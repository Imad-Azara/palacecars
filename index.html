<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Location de Voiture Agadir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome (integrity corrigÃ©) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3F5f5qK2K6Q24L+nkA5bf5F3Gmf0iVCi/2fA/wz2N9H/Gz9oW9sP7Cg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; /* Slate-100 */ color: #334155; /* Slate-700 */ scroll-behavior: smooth; overflow-x: hidden; /* Prevent horizontal scroll */ }

        /* Custom Colors: Blue (#2563eb) and Yellow/Gold (#f59e0b) */
        :root {
            --color-primary: #2563eb; /* Blue-600 */
            --color-primary-dark: #1d4ed8; /* Blue-700 */
            --color-primary-light: #60a5fa; /* Blue-400 */
            --color-primary-lighter: #eff6ff; /* Blue-50 */
            --color-accent: #f59e0b; /* Amber-500 */
            --color-accent-dark: #d97706; /* Amber-600 */
            --color-text-dark: #1e293b; /* Slate-800 */
            --color-text-medium: #64748b; /* Slate-500 */
            --color-text-light: #f1f5f9; /* Slate-100 */
            --color-bg-light: #f1f5f9; /* Slate-100 */
            --color-bg-white: #ffffff;
            --color-bg-dark: #0f172a; /* Slate-900 */
            --color-bg-darker: #020617; /* Slate-950 */
            --color-border-light: #e2e8f0; /* Slate-200 */
            --color-border-medium: #cbd5e1; /* Slate-300 */
        }

        /* Helper classes */
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary-dark:hover { background-color: var(--color-primary-dark); }
        .border-primary { border-color: var(--color-primary); }
        .ring-primary { --tw-ring-color: var(--color-primary); }
        .focus\:border-primary:focus { border-color: var(--color-primary); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--color-primary); }

        .text-accent { color: var(--color-accent); }
        .bg-accent { background-color: var(--color-accent); }
        .hover\:bg-accent-dark:hover { background-color: var(--color-accent-dark); }
        .border-accent { border-color: var(--color-accent); }
        .ring-accent { --tw-ring-color: var(--color-accent); }
        .focus\:border-accent:focus { border-color: var(--color-accent); }
        .focus\:ring-accent:focus { --tw-ring-color: var(--color-accent); }

        /* Header Styling */
        header { transition: background-color 0.3s ease, box-shadow 0.3s ease, padding 0.3s ease; }
        header.scrolled { background-color: var(--color-bg-white); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding-top: 0.5rem; padding-bottom: 0.5rem; } /* py-2 */
        header nav a { transition: color 0.3s ease; }
        header:not(.scrolled) nav a:not(.btn-accent) { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); } /* White text when transparent + subtle shadow */
        header:not(.scrolled) nav a:not(.btn-accent):hover { color: var(--color-accent); } /* Yellow hover when transparent */
        header:not(.scrolled) #mobile-menu-button { color: white; }
        header.scrolled nav a { color: var(--color-text-dark); } /* Dark text when scrolled */
        header.scrolled nav a:hover { color: var(--color-primary); }
        header.scrolled #mobile-menu-button { color: var(--color-text-dark); }

        #mobile-menu { background-color: var(--color-bg-white); }
        #mobile-menu a { color: var(--color-text-dark); }
        #mobile-menu a:hover { background-color: var(--color-primary-lighter); color: var(--color-primary); }

        /* Logo swap styling */
        .logo-container { position: relative; width: 4rem; height: 4rem; /* h-16 w-16 */ } /* Ensure container has size */
        .logo-container img {
            position: absolute; top: 0; left: 0;
            height: 100%; width: 100%;
            object-fit: contain;
            border-radius: 9999px; /* rounded-full */
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
            transform: scale(1); /* Base scale */
        }
        .logo-container img:hover { transform: scale(1.05); } /* Keep hover effect */
        #logo-color { opacity: 0; }
        #logo-white { opacity: 1; }
        header.scrolled #logo-color { opacity: 1; }
        header.scrolled #logo-white { opacity: 0; }


        /* Hero Section Styling */
        .hero-bg {
            background-image: linear-gradient(rgba(10, 20, 80, 0.6), rgba(0, 0, 0, 0.8)), url('https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=2070&auto-format=fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed; /* Parallax effect */
        }
        .text-shadow-lg { text-shadow: 0 4px 8px rgba(0,0,0,0.5); }

        /* Loader */
        .loader { border-top-color: var(--color-primary); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Card styles - More Dynamic & Premium */
        .car-card { transition: transform 0.3s ease, box-shadow 0.4s ease; background-color: var(--color-bg-white); border-radius: 1rem; /* rounded-2xl */ overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07); }
        .car-card img { transition: transform 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .car-card:hover { transform: translateY(-12px); box-shadow: 0 25px 50px -12px rgba(37, 99, 235, 0.25); } /* Primary color shadow */
        .car-card:hover img { transform: scale(1.1); }
        .car-card.selected { border: 2px solid var(--color-primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3), 0 10px 20px rgba(0,0,0,0.1); transform: scale(1.03); }
        .car-card h3, .car-card h4 { color: var(--color-text-dark); font-weight: 700; } /* Bold */
        .car-card p { color: var(--color-text-medium); }
        .car-card .price { color: var(--color-primary); font-weight: 700; font-size: 1.375rem; } /* Increased price size */
        .car-card .select-car-button { font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.3s ease; border-radius: 9999px; /* rounded-full */ box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .car-card .select-car-button:hover:not(:disabled) { transform: translateY(-3px) scale(1.03); box-shadow: 0 10px 15px rgba(0,0,0,0.15); }
        .car-card .select-car-button.selected-btn { background-color: #16a34a; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.3); } /* Green-600 */
        .car-card .select-car-button.selected-btn:hover { background-color: #15803d; box-shadow: 0 6px 12px rgba(21, 128, 61, 0.4); } /* Green-700 */

        /* Input/Select Styles - Modernized */
        input[type="text"], input[type="tel"], input[type="email"], input[type="date"], select {
            background-color: var(--color-bg-white); border: 1px solid var(--color-border-medium); color: var(--color-text-dark);
            border-radius: 0.75rem; /* rounded-xl */ padding: 1rem 1.25rem; transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04) inset; font-weight: 500;
        }
        input::placeholder, select option[disabled] { color: #94a3b8; } /* Slate-400 */
        input:focus, select:focus { background-color: white; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25), 0 2px 4px rgba(0,0,0,0.04) inset; outline: none; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.8; filter: invert(0.5); transition: opacity 0.2s ease; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
        select {
             -webkit-appearance: none; -moz-appearance: none; appearance: none;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); /* Slate-500 */
             background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; padding-right: 3rem;
        }
        .time-select { padding: 1rem 0.75rem; padding-right: 2.5rem; }

        /* Section Animation on Scroll */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .section-animate { opacity: 0; } /* Start hidden for JS observer */
        .section-animate.visible { animation: fadeInUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }

        /* Animation & initial state for Reservation Section - Using Tailwind classes */
        #reservation {
            /* Initial state set by Tailwind classes below */
            transition: max-height 0.8s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.6s ease-out 0.2s, padding-top 0.8s ease, padding-bottom 0.8s ease, margin-top 0.8s ease, margin-bottom 0.8s ease;
        }

        /* FAQ details style - Enhanced */
        details { transition: all 0.3s ease; border: 1px solid transparent; background-color: var(--color-bg-white); border-radius: 0.75rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        details[open] { border-color: var(--color-primary-light); background-color: var(--color-bg-white); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.15); }
        details > summary { list-style: none; padding: 1.5rem 2rem; font-weight: 600; color: var(--color-text-dark); cursor: pointer; transition: color 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { color: var(--color-primary); }
        details[open] > summary i { transform: rotate(180deg); color: var(--color-primary); }
        details > summary i { transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), color 0.3s ease; color: var(--color-primary); font-size: 1.1em; }
        details div { padding: 0 2rem 1.5rem 2rem; color: var(--color-text-medium); line-height: 1.7; border-top: 1px solid var(--color-border-light); }

        /* Message Box Styling */
        #message-box { transition: opacity 0.3s ease, transform 0.3s ease; font-weight: 500; }

        /* General Button Styles - Pill Shape Option */
        .btn { padding: 0.8rem 2rem; border-radius: 9999px; /* rounded-full */ font-weight: 600; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); text-align: center; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-dark); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(37, 99, 235, 0.3); }
        .btn-accent { background-color: var(--color-accent); color: var(--color-bg-dark); } /* Dark text on yellow */
        .btn-accent:hover:not(:disabled) { background-color: var(--color-accent-dark); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(245, 158, 11, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Section Titles - Bolder */
        .section-title { font-size: 2.75rem; /* ~text-4xl/5xl */ font-weight: 800; /* Extra bold */ color: var(--color-text-dark); text-align: center; margin-bottom: 1.5rem; line-height: 1.2; }
        .section-subtitle { font-size: 1.125rem; /* text-lg */ color: var(--color-text-medium); text-align: center; margin-bottom: 4rem; max-width: 650px; margin-left: auto; margin-right: auto; line-height: 1.8; }

        /* Enhanced Section Backgrounds */
        #reservation-container { background-color: var(--color-bg-light); border-bottom: 1px solid var(--color-border-light); } /* Container holds the bg color */
        #flotte { background-color: var(--color-bg-white); padding-top: 6rem; padding-bottom: 6rem; }
        #services { background: linear-gradient(145deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); color: white; padding-top: 6rem; padding-bottom: 6rem; }
        #services .section-title, #services .section-subtitle { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        #services .service-card { background-color: rgba(255, 255, 255, 0.08); border-radius: 1rem; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #services .service-card h3 { color: white; }
        #services .service-card p { color: var(--color-text-light); opacity: 0.9; }
        #faq { background-color: var(--color-bg-light); /* Slate-100 */ padding-top: 6rem; padding-bottom: 6rem; }
        #contact { background: var(--color-bg-darker); /* Slate-950 */ color: var(--color-text-light); padding-top: 6rem; padding-bottom: 6rem; }
        #contact h2 { color: white; }
        #contact p { color: var(--color-text-medium); } /* Lighter gray for dark bg */
        #contact a { color: var(--color-text-light); }
        #contact a:hover { color: var(--color-accent); }
        #contact i { color: var(--color-accent); transition: transform 0.3s ease; }
        #contact a:hover i { transform: scale(1.1); }

        /* Smooth scroll adjustment */
        html { scroll-padding-top: 80px; /* Adjust based on sticky header height */ }

        /* Hide scrollbar for Chrome, Safari and Opera */
        body::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        body { -ms-overflow-style: none; /* IE and Edge */ scrollbar-width: none; /* Firefox */ }

        /* Small divider */
        .divider { height: 1px; background-color: var(--color-border-light); margin: 3rem auto; width: 80%; max-width: 300px; }

    </style>
</head>
<body class="bg-bg-light text-text-dark">

    <!-- Header -->
    <header id="main-header" class="fixed top-0 left-0 right-0 z-50 py-4 transition-all duration-300">
        <nav class="container mx-auto px-6 flex justify-between items-center">
            <!-- Navigation Links - Left -->
            <div class="hidden md:flex items-center space-x-8">
                <a href="#accueil" class=" hover:text-accent font-medium">Accueil</a>
                <a href="#flotte" class=" hover:text-accent font-medium">Notre Flotte</a>
                <a href="#services" class=" hover:text-accent font-medium">Services</a>
            </div>

            <!-- Logo - Center -->
            <div class="flex-1 flex justify-center md:absolute md:left-1/2 md:transform md:-translate-x-1/2">
                 <a href="#" class="logo-container"> <!-- Added container for positioning -->
                   <!-- White Logo (Initially Visible) -->
                   <img id="logo-white" src="https://i.imgur.com/uPC4OVz.png" alt="Palace Cars Logo Blanc">
                   <!-- Color Logo (Initially Hidden) -->
                   <img id="logo-color" src="https://i.imgur.com/htqH0IE.png" alt="Palace Cars Logo Couleur">
                 </a>
            </div>

            <!-- Navigation Links & Button - Right -->
            <div class="hidden md:flex items-center space-x-8">
                <a href="#faq" class=" hover:text-accent font-medium">FAQ</a>
                <a href="#contact" class=" hover:text-accent font-medium">Contact</a>
                <a href="#reservation" id="nav-reserve-button" class="btn btn-accent text-sm px-6 py-2">RÃ©server</a>
            </div>

            <!-- Mobile Menu Button (Hamburger) -->
            <div class="md:hidden">
                <button id="mobile-menu-button" class="focus:outline-none p-2 -mr-2">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg mt-2 rounded-md">
             <a href="#accueil" class="block px-6 py-3 hover:bg-primary-lighter hover:text-primary font-medium border-b border-gray-100">Accueil</a>
             <a href="#flotte" class="block px-6 py-3 hover:bg-primary-lighter hover:text-primary font-medium border-b border-gray-100">Notre Flotte</a>
             <a href="#services" class="block px-6 py-3 hover:bg-primary-lighter hover:text-primary font-medium border-b border-gray-100">Services</a>
             <a href="#faq" class="block px-6 py-3 hover:bg-primary-lighter hover:text-primary font-medium border-b border-gray-100">FAQ</a>
             <a href="#contact" class="block px-6 py-3 hover:bg-primary-lighter hover:text-primary font-medium border-b border-gray-100">Contact</a>
             <a href="#reservation" id="mobile-reserve-button" class="block px-6 py-3 bg-accent text-slate-900 font-semibold text-center rounded-b-md hover:bg-accent-dark">RÃ©server en Ligne</a>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="accueil" class="hero-bg text-white min-h-screen flex items-center justify-center relative">
        <div class="absolute inset-0 bg-gradient-to-t from-black via-blue-900/40 to-transparent opacity-80"></div>
        <div class="container mx-auto px-6 text-center relative z-10 pt-20">
            <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold mb-4 leading-tight text-shadow-lg animate-fade-in-down">Palace Cars Agadir</h1>
            <p class="text-lg md:text-2xl text-gray-200 mb-10 max-w-3xl mx-auto animate-fade-in-up" style="animation-delay: 0.2s;">Location de voitures simple, rapide et aux meilleurs prix.</p>
            <!-- Bouton "RÃ©server en Ligne" -->
            <button id="hero-reserve-button" class="btn btn-accent text-lg px-10 py-4 animate-fade-in-up shadow-lg hover:shadow-xl hover:scale-105" style="animation-delay: 0.4s;">
                RÃ©server en Ligne <i class="fas fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
            </button>
        </div>
        <!-- Scroll Down Arrow (Optional) -->
        <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-10 animate-bounce hidden md:block">
            <a href="#reservation" id="scroll-down-button">
                <i class="fas fa-chevron-down text-white text-3xl opacity-70 hover:opacity-100 transition-opacity"></i>
            </a>
        </div>
    </section>

    <!-- Reservation Form Section Container (Handles background and structure) -->
    <div id="reservation-container" class="bg-gradient-to-b from-slate-100 to-white">
        <!-- The actual Reservation Form Section - Initially Hidden & Animated -->
        <!-- Start hidden with Tailwind classes, add padding classes that will be applied when visible -->
        <section id="reservation" class="container mx-auto px-6 max-w-5xl max-h-0 opacity-0 overflow-hidden transition-all duration-700 ease-in-out p-0 m-0">
            <!-- Apply padding when visible via Tailwind classes -->
            <div class="bg-white p-8 md:p-16 rounded-2xl shadow-xl border border-gray-100 relative overflow-hidden mt-16 mb-16 md:mt-24 md:mb-24">
                <!-- Decorative elements -->
                <div class="absolute top-0 left-0 w-32 h-32 bg-blue-100 rounded-full opacity-30 -translate-x-1/3 -translate-y-1/3 filter blur-xl"></div>
                <div class="absolute bottom-0 right-0 w-48 h-48 bg-yellow-100 rounded-full opacity-30 translate-x-1/4 translate-y-1/4 filter blur-xl"></div>

                <div class="relative z-10">
                    <h2 class="section-title mb-10 text-primary">RÃ©servez Votre VÃ©hicule</h2>

                    <!-- Message Box -->
                    <div id="message-box" class="hidden p-4 rounded-lg text-center mb-6"></div>

                    <!-- Formulaire -->
                    <form id="booking-form" class="space-y-6">
                        <!-- Web3Forms Hidden Inputs -->
                         <input type="hidden" name="subject" value="Nouvelle demande de rÃ©servation - Palace Cars">
                         <input type="hidden" name="from_name" value="Palace Cars RÃ©servation">
                         <input type="hidden" name="access_key" value="9a2470af-9163-405c-abc9-3aafd98b14fd">
                         <input type="hidden" name="redirect" value="https://web3forms.com/success">

                        <!-- Champs Client -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="nomPrenom" class="block text-sm font-semibold text-gray-700 mb-2">Nom et PrÃ©nom <span class="text-red-500">*</span></label>
                                <input type="text" id="nomPrenom" name="nomPrenom" required placeholder="Votre nom complet" class="block w-full">
                            </div>
                            <div>
                                <label for="telephone" class="block text-sm font-semibold text-gray-700 mb-2">TÃ©lÃ©phone <span class="text-red-500">*</span></label>
                                <input type="tel" id="telephone" name="telephone" required placeholder="+212 6 XX XX XX XX" class="block w-full">
                            </div>
                        </div>
                         <div>
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Adresse E-mail <span class="text-red-500">*</span></label>
                            <input type="email" id="email" name="email" required placeholder="votre.email@exemple.com" class="block w-full">
                        </div>

                        <!-- Champs Lieu -->
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="lieuPriseEnCharge" class="block text-sm font-semibold text-gray-700 mb-2">Lieu Prise en Charge <span class="text-red-500">*</span></label>
                                <input type="text" id="lieuPriseEnCharge" name="lieuPriseEnCharge" required placeholder="AÃ©roport, HÃ´tel..." class="block w-full">
                            </div>
                            <div>
                                <label for="lieuRetour" class="block text-sm font-semibold text-gray-700 mb-2">Lieu Retour <span class="text-red-500">*</span></label>
                                <input type="text" id="lieuRetour" name="lieuRetour" required placeholder="AÃ©roport, HÃ´tel..." class="block w-full">
                            </div>
                        </div>

                        <!-- Champs Date et Heure -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Date et Heure de DÃ©but -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">DÃ©but Location <span class="text-red-500">*</span></label>
                                <input type="date" id="datePriseEnCharge" name="datePriseEnCharge" required class="block w-full mb-2">
                                 <div class="grid grid-cols-2 gap-3">
                                    <select id="heurePriseEnChargeHeure" name="heurePriseEnChargeHeure" required class="block w-full time-select">
                                        <option value="" disabled selected>Heure</option>
                                    </select>
                                    <select id="heurePriseEnChargeMinute" name="heurePriseEnChargeMinute" required class="block w-full time-select">
                                        <option value="" disabled selected>Minute</option>
                                    </select>
                                 </div>
                            </div>
                             <!-- Date et Heure de Fin -->
                             <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Fin Location <span class="text-red-500">*</span></label>
                                <input type="date" id="dateRetour" name="dateRetour" required class="block w-full mb-2">
                                <div class="grid grid-cols-2 gap-3">
                                    <select id="heureRetourHeure" name="heureRetourHeure" required class="block w-full time-select">
                                        <option value="" disabled selected>Heure</option>
                                    </select>
                                    <select id="heureRetourMinute" name="heureRetourMinute" required class="block w-full time-select">
                                        <option value="" disabled selected>Minute</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Bouton VÃ©rifier DisponibilitÃ© -->
                        <div class="text-center pt-8">
                            <button type="button" id="check-availability-button" class="btn btn-primary w-full md:w-auto px-12 py-3.5 text-base disabled:opacity-50 shadow-lg hover:shadow-primary/50">
                                <span class="mr-2">VÃ©rifier la DisponibilitÃ©</span>
                                <i class="fas fa-search"></i>
                                <span id="availability-spinner" class="ml-2 inline-block border-2 border-white border-t-transparent rounded-full w-5 h-5 hidden animate-spin"></span>
                            </button>
                        </div>

                        <!-- Champ cachÃ© pour stocker la voiture sÃ©lectionnÃ©e -->
                         <input type="hidden" id="selectedCar" name="voiture">

                    </form> <!-- Fin du formulaire initial -->

                     <!-- Section pour afficher les voitures disponibles -->
                     <div id="available-cars-section" class="mt-16 hidden">
                        <hr class="mb-12 border-gray-200">
                        <h3 class="section-title text-3xl mb-12 text-primary">Voitures Disponibles</h3>
                        <div id="available-cars-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- Les cartes de voitures seront injectÃ©es ici -->
                        </div>
                        <p id="no-cars-message" class="text-center text-text-medium mt-8 hidden text-lg">DÃ©solÃ©, aucune voiture n'est disponible pour les dates sÃ©lectionnÃ©es.</p>

                        <!-- Bouton Soumettre Final -->
                        <div class="text-center mt-16">
                            <button type="button" id="submit-booking-button" class="btn btn-accent w-full md:w-auto px-16 py-4 text-lg hidden disabled:opacity-50 shadow-xl hover:shadow-accent/50">
                                <span>Soumettre la Demande</span>
                                <span id="submit-spinner" class="ml-2 inline-block border-2 border-slate-900 border-t-transparent rounded-full w-5 h-5 hidden animate-spin"></span>
                            </button>
                        </div>
                     </div>
                 </div>
            </div>
        </section> <!-- Fin de #reservation -->
    </div> <!-- Fin de #reservation-container -->


    <!-- Featured Cars Section -->
    <section id="flotte" class="py-24 bg-white section-animate" style="animation-delay: 0.2s;">
        <div class="container mx-auto px-6">
            <h2 class="section-title">Notre Flotte</h2>
            <p class="section-subtitle">Des vÃ©hicules rÃ©cents et bien entretenus pour tous vos besoins.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Car Card 1 -->
                <div class="car-card">
                     <div class="relative group overflow-hidden rounded-t-lg">
                         <img src="https://placehold.co/300x200/e2e8f0/334155?text=Logan+D+24" alt="Dacia Logan Diesel 2024" class="w-full h-52 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+Indispo';">
                         <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl mb-2">Dacia Logan Diesel 2024</h3>
                        <p class="mb-4 text-sm h-10 text-text-medium">Ãconomique et fiable, idÃ©ale pour la ville.</p>
                        <div class="flex justify-between items-center mt-4">
                            <p class="text-xl price">250 Dhs <span class="text-sm font-normal text-text-medium">/ jour</span></p>
                            <a href="#reservation" class="btn btn-primary text-xs px-4 py-2 reserve-now-link">RÃ©server</a>
                        </div>
                    </div>
                </div>
                <!-- Car Card 2 -->
                <div class="car-card">
                    <div class="relative group overflow-hidden rounded-t-lg">
                        <img src="https://placehold.co/300x200/e2e8f0/334155?text=Logan+D+25" alt="Dacia Logan Diesel 2025" class="w-full h-52 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+Indispo';">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                    </div>
                   <div class="p-6">
                       <h3 class="text-xl mb-2">Dacia Logan Diesel 2025</h3>
                       <p class="mb-4 text-sm h-10 text-text-medium">Le dernier modÃ¨le, confort amÃ©liorÃ©.</p>
                       <div class="flex justify-between items-center mt-4">
                           <p class="text-xl price">250 Dhs <span class="text-sm font-normal text-text-medium">/ jour</span></p>
                           <a href="#reservation" class="btn btn-primary text-xs px-4 py-2 reserve-now-link">RÃ©server</a>
                       </div>
                   </div>
               </div>
                <!-- Car Card 3 -->
                <div class="car-card">
                    <div class="relative group overflow-hidden rounded-t-lg">
                        <img src="https://placehold.co/300x200/e2e8f0/334155?text=Sandero+E" alt="Dacia Sandero Essence" class="w-full h-52 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+Indispo';">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl mb-2">Dacia Sandero Essence</h3>
                        <p class="mb-4 text-sm h-10 text-text-medium">Compacte et agile, parfaite pour la ville.</p>
                        <div class="flex justify-between items-center mt-4">
                            <p class="text-xl price">300 Dhs <span class="text-sm font-normal text-text-medium">/ jour</span></p>
                            <a href="#reservation" class="btn btn-primary text-xs px-4 py-2 reserve-now-link">RÃ©server</a>
                        </div>
                    </div>
                </div>
                 <!-- Car Card 4 -->
                 <div class="car-card">
                    <div class="relative group overflow-hidden rounded-t-lg">
                        <img src="https://placehold.co/300x200/e2e8f0/334155?text=Sandero+D" alt="Dacia Sandero Diesel" class="w-full h-52 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+Indispo';">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl mb-2">Dacia Sandero Diesel</h3>
                        <p class="mb-4 text-sm h-10 text-text-medium">Version diesel Ã©conomique et polyvalente.</p>
                        <div class="flex justify-between items-center mt-4">
                           <p class="text-xl price">250 Dhs <span class="text-sm font-normal text-text-medium">/ jour</span></p>
                           <a href="#reservation" class="btn btn-primary text-xs px-4 py-2 reserve-now-link">RÃ©server</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section - Redesigned -->
    <section id="services" class="py-24 bg-gradient-to-br from-primary to-blue-800 text-white section-animate" style="animation-delay: 0.3s;">
        <div class="container mx-auto px-6 text-center">
            <h2 class="section-title mb-4">Nos Engagements QualitÃ©</h2>
            <p class="section-subtitle !text-blue-100 opacity-90">Votre satisfaction est notre prioritÃ©.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                <!-- Service Card 1 -->
                <div class="service-card bg-white/10 backdrop-blur-md p-8 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-white/10 hover:border-white/20">
                     <div class="text-accent text-6xl mb-6"> <!-- Bigger icon -->
                        <i class="fas fa-plane-departure"></i>
                     </div>
                    <h3 class="text-2xl font-semibold mb-3">Livraison AÃ©roport</h3>
                    <p class="opacity-90 leading-relaxed">Prise en charge et retour simplifiÃ©s directement Ã  l'aÃ©roport d'Agadir Al Massira.</p>
                </div>
                <!-- Service Card 2 -->
                <div class="service-card bg-white/10 backdrop-blur-md p-8 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-white/10 hover:border-white/20">
                    <div class="text-accent text-6xl mb-6">
                        <i class="fas fa-headset"></i>
                     </div>
                    <h3 class="text-2xl font-semibold mb-3">Assistance 24/7</h3>
                    <p class="opacity-90 leading-relaxed">Notre Ã©quipe est disponible Ã  toute heure pour vous assister en cas de besoin.</p>
                </div>
                <!-- Service Card 3 -->
                <div class="service-card bg-white/10 backdrop-blur-md p-8 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-2 border border-white/10 hover:border-white/20">
                     <div class="text-accent text-6xl mb-6">
                        <i class="fas fa-infinity"></i> <!-- Changed Icon -->
                     </div>
                    <h3 class="text-2xl font-semibold mb-3">KilomÃ©trage IllimitÃ©</h3>
                    <p class="opacity-90 leading-relaxed">Explorez sans limites. Profitez pleinement de votre aventure au Maroc.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section - Redesigned -->
    <section id="faq" class="py-24 bg-bg-light section-animate" style="animation-delay: 0.4s;">
         <div class="container mx-auto px-6 max-w-4xl"> <!-- Wider container -->
            <h2 class="section-title">Questions FrÃ©quentes</h2>
            <p class="section-subtitle">Trouvez rapidement les informations dont vous avez besoin.</p>
            <div class="space-y-4">
                <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer">
                        <span>Quels documents sont nÃ©cessaires pour louer une voiture ?</span>
                        <i class="fas fa-chevron-down text-lg"></i>
                    </summary>
                    <div>Vous aurez besoin d'un permis de conduire valide depuis au moins un an, d'une piÃ¨ce d'identitÃ© (passeport ou carte d'identitÃ© nationale en cours de validitÃ©), et d'une carte de crÃ©dit au nom du conducteur principal pour la caution.</div>
                </details>
                 <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer">
                        <span>Quel est l'Ã¢ge minimum requis pour louer ?</span>
                        <i class="fas fa-chevron-down text-lg"></i>
                    </summary>
                    <div>L'Ã¢ge minimum standard est de 21 ans. Cependant, pour certaines catÃ©gories de vÃ©hicules (luxe, 4x4), un Ã¢ge minimum plus Ã©levÃ© et/ou des annÃ©es d'expÃ©rience de conduite supplÃ©mentaires peuvent Ãªtre exigÃ©s.</div>
                </details>
                 <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer">
                        <span>Quelles assurances sont incluses dans le prix ?</span>
                        <i class="fas fa-chevron-down text-lg"></i>
                    </summary>
                    <div>Nos tarifs incluent toujours l'assurance responsabilitÃ© civile obligatoire et une assurance de base couvrant les dommages au vÃ©hicule avec une franchise applicable en cas d'accident responsable. Des options d'assurance complÃ©mentaire (rachat de franchise, protection personnelle) sont disponibles.</div>
                </details>
                 <details class="group">
                    <summary class="flex justify-between items-center cursor-pointer">
                        <span>Puis-je conduire la voiture en dehors d'Agadir ?</span>
                        <i class="fas fa-chevron-down text-lg"></i>
                    </summary>
                    <div>Absolument ! Nos vÃ©hicules peuvent Ãªtre conduits dans tout le Maroc. Nous vous demandons simplement de nous informer si vous prÃ©voyez de trÃ¨s longs trajets ou de vous rendre dans des zones spÃ©cifiques. La sortie du territoire marocain n'est pas autorisÃ©e.</div>
                </details>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="py-24 bg-bg-darker text-white section-animate" style="animation-delay: 0.5s;">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-4xl font-bold mb-6 text-primary">Contactez-Nous</h2>
            <p class="mb-12 max-w-xl mx-auto text-gray-400 text-lg leading-relaxed">Une question ? Besoin d'un devis personnalisÃ© ? Notre Ã©quipe est prÃªte Ã  vous aider.</p>
            <div class="flex flex-col md:flex-row justify-center items-center space-y-8 md:space-y-0 md:space-x-12">
                <a href="tel:+212659198122" class="text-xl font-medium hover:text-accent transition duration-300 flex items-center group">
                    <i class="fas fa-phone mr-3 text-accent text-3xl group-hover:scale-110 transition-transform duration-300"></i>
                    <span>+212 659 198 122</span>
                </a>
                <a href="mailto:contact@palacecars.ma" class="text-xl font-medium hover:text-accent transition duration-300 flex items-center group">
                    <i class="fas fa-envelope mr-3 text-accent text-3xl group-hover:scale-110 transition-transform duration-300"></i>
                    <span>contact@palacecars.ma</span>
                </a>
                 <a href="https://wa.me/212659198122" target="_blank" class="text-xl font-medium hover:text-accent transition duration-300 flex items-center group">
                    <i class="fab fa-whatsapp mr-3 text-accent text-3xl group-hover:scale-110 transition-transform duration-300"></i>
                    <span>WhatsApp Direct</span>
                 </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-bg-dark text-gray-400 py-12 border-t border-gray-800">
        <div class="container mx-auto px-6 text-center">
             <div class="mb-6">
                 <a href="#accueil" class="px-3 hover:text-accent text-sm transition duration-300">Accueil</a> |
                 <a href="#reservation" class="px-3 hover:text-accent text-sm transition duration-300 reserve-now-link">RÃ©server</a> |
                 <a href="#flotte" class="px-3 hover:text-accent text-sm transition duration-300">Flotte</a> |
                 <a href="#services" class="px-3 hover:text-accent text-sm transition duration-300">Services</a> |
                 <a href="#faq" class="px-3 hover:text-accent text-sm transition duration-300">FAQ</a> |
                 <a href="#contact" class="px-3 hover:text-accent text-sm transition duration-300">Contact</a>
             </div>
             <img src="https://i.imgur.com/ZtFVbmL.png" alt="Palace Cars Logo Footer" class="h-14 w-14 mx-auto mb-5 rounded-full shadow-lg border-2 border-gray-700">
            <p class="text-sm">&copy; <span id="current-year"></span> PalaceCars - Tous droits rÃ©servÃ©s. Location de voiture Agadir.</p>
             <p class="text-xs mt-3 text-gray-500">Design & DÃ©veloppement</p>
        </div>
    </footer>


    <!-- Script Firebase & Logique -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, getDoc, getDocs, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
            authDomain: "palace-cars.firebaseapp.com",
            projectId: "palace-cars",
            storageBucket: "palace-cars.firebasestorage.app",
            messagingSenderId: "469852272715",
            appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
            measurementId: "G-KCEF4WBW0G"
        };

        // --- Initialize Firebase ---
        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef;
        let carManualStatusCollectionRef;
        let dbReady = false;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            bookingsCollectionRef = collection(db, "palace_cars_bookings");
            unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
            carManualStatusCollectionRef = collection(db, "car_manual_status");
            dbReady = true;
            console.log("Firebase initialisÃ© avec succÃ¨s.");
        } catch (error) {
            console.error("Erreur critique d'initialisation Firebase:", error);
             const initialMessageBox = document.getElementById('message-box');
             const reservationSectionEl = document.getElementById('reservation');
             if(initialMessageBox && reservationSectionEl) {
                 // Make section visible to show the error
                 reservationSectionEl.classList.remove('opacity-0', 'max-h-0', 'p-0', 'm-0', 'overflow-hidden');
                 reservationSectionEl.classList.add('py-20', 'md:py-32', 'opacity-100', 'max-h-[3000px]'); // Use the 'visible' state classes
                 reservationSectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

                initialMessageBox.textContent = "Erreur critique: Impossible de connecter Ã  la base de donnÃ©es.";
                initialMessageBox.className = 'p-4 rounded-lg text-center mb-6 font-medium bg-red-100 text-red-800 border border-red-300';
                initialMessageBox.classList.remove('hidden');
             }
        }

         // --- Liste des Voitures et Prix ---
         const carFleet = {
            "Dacia Logan Diesel 2024": { price: 250, image: "https://placehold.co/300x200/e2e8f0/334155?text=Logan+D+24" },
            "Dacia Logan Diesel 2025": { price: 250, image: "https://placehold.co/300x200/e2e8f0/334155?text=Logan+D+25" },
            "Dacia Sandero Essence": { price: 300, image: "https://placehold.co/300x200/e2e8f0/334155?text=Sandero+E" },
            "Dacia Sandero Diesel": { price: 250, image: "https://placehold.co/300x200/e2e8f0/334155?text=Sandero+D" },
        };
        const carNames = Object.keys(carFleet);

        // --- DOM Elements ---
        const mainHeader = document.getElementById('main-header');
        const heroReserveButton = document.getElementById('hero-reserve-button');
        const scrollDownButton = document.getElementById('scroll-down-button');
        const reservationSection = document.getElementById('reservation');
        const form = document.getElementById('booking-form');
        const messageBox = document.getElementById('message-box');
        const checkAvailabilityButton = document.getElementById('check-availability-button');
        const availabilitySpinner = document.getElementById('availability-spinner');
        const availableCarsSection = document.getElementById('available-cars-section');
        const availableCarsListDiv = document.getElementById('available-cars-list');
        const noCarsMessage = document.getElementById('no-cars-message');
        const submitBookingButton = document.getElementById('submit-booking-button');
        const submitSpinner = document.getElementById('submit-spinner');
        const selectedCarInput = document.getElementById('selectedCar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const navReserveButton = document.getElementById('nav-reserve-button');
        const mobileReserveButton = document.getElementById('mobile-reserve-button');
        const reserveNowLinks = document.querySelectorAll('.reserve-now-link');

        const nomPrenomInput = document.getElementById('nomPrenom');
        const telephoneInput = document.getElementById('telephone');
        const emailInput = document.getElementById('email');
        const lieuPriseEnChargeInput = document.getElementById('lieuPriseEnCharge');
        const lieuRetourInput = document.getElementById('lieuRetour');
        const datePriseEnChargeInput = document.getElementById('datePriseEnCharge');
        const heurePriseEnChargeHeureSelect = document.getElementById('heurePriseEnChargeHeure');
        const heurePriseEnChargeMinuteSelect = document.getElementById('heurePriseEnChargeMinute');
        const dateRetourInput = document.getElementById('dateRetour');
        const heureRetourHeureSelect = document.getElementById('heureRetourHeure');
        const heureRetourMinuteSelect = document.getElementById('heureRetourMinute');
        const currentYearSpan = document.getElementById('current-year');

        let selectedCarName = null;
        let currentPickupDateTime = null;
        let currentReturnDateTime = null;

        // --- Fonctions Utilitaires ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'p-4 rounded-lg text-center mb-6 font-medium border text-sm md:text-base'; // Keep base classes
            messageBox.classList.remove('bg-green-100', 'border-green-300', 'text-green-800', 'bg-red-100', 'border-red-300', 'text-red-800', 'bg-yellow-100', 'border-yellow-300', 'text-yellow-800', 'bg-blue-100', 'border-blue-300', 'text-blue-800'); // Remove old colors
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            } else if (type === 'warning') {
                 messageBox.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
            } else { // info default
                messageBox.classList.add('bg-blue-100', 'border-blue-300', 'text-blue-800');
            }
             messageBox.style.opacity = '1'; messageBox.style.transform = 'translateY(0)';
             messageBox.classList.remove('hidden');
            // Auto-hide after 7 seconds
            setTimeout(() => {
                if (!messageBox.classList.contains('hidden')) { // Check if still visible
                    messageBox.style.opacity = '0'; messageBox.style.transform = 'translateY(-10px)';
                    setTimeout(() => messageBox.classList.add('hidden'), 300);
                 }
            }, 7000);
        }

        function getDateTimeObject(dateStr, hourStr, minuteStr) {
            if (!dateStr || hourStr === "" || minuteStr === "") return null;
            try {
                const hour = hourStr.padStart(2, '0');
                const minute = minuteStr.padStart(2, '0');
                const [year, month, day] = dateStr.split('-');
                // Use UTC to avoid timezone issues when comparing dates
                const d = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), 0));
                if (isNaN(d.getTime())) { throw new Error("Invalid date created"); }
                return d;
            } catch (e) {
                console.error("Erreur conversion date/heure:", dateStr, hourStr, minuteStr, e);
                showMessage("Erreur dans le format de date ou d'heure.", "error");
                return null;
            }
        }

        function formatReadableDateTime(dateObj) {
            if (!dateObj || isNaN(dateObj.getTime())) return "Date invalide";
             const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'UTC' };
             try {
                let formatted = new Intl.DateTimeFormat('fr-FR', options).format(dateObj);
                // Correctly remove potential multiple spaces after replace in different locales
                formatted = formatted.replace(/[\s,]+/g, ' ').trim();
                return formatted;
             } catch (e) {
                console.error("Error formatting date:", e);
                const day = String(dateObj.getUTCDate()).padStart(2, '0');
                const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
                const year = dateObj.getUTCFullYear();
                const hours = String(dateObj.getUTCHours()).padStart(2, '0');
                const minutes = String(dateObj.getUTCMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}h${minutes}`;
             }
        }

        // --- Remplissage des Selects Heure/Minute ---
        function populateTimeSelects() {
            const hourSelects = [heurePriseEnChargeHeureSelect, heureRetourHeureSelect];
            const minuteSelects = [heurePriseEnChargeMinuteSelect, heureRetourMinuteSelect];

            hourSelects.forEach(select => {
                const placeholder = select.querySelector('option[disabled]'); select.innerHTML = ''; if (placeholder) select.appendChild(placeholder);
                for (let i = 0; i < 24; i++) { const value = i.toString().padStart(2, '0'); select.options.add(new Option(value, value)); }
            });

            minuteSelects.forEach(select => {
                 const placeholder = select.querySelector('option[disabled]'); select.innerHTML = ''; if (placeholder) select.appendChild(placeholder);
                 // Populate with 00, 15, 30, 45
                 ['00', '15', '30', '45'].forEach(value => {
                     select.options.add(new Option(value, value));
                 });
            });
        }

        // --- VÃ©rification de DisponibilitÃ© SpÃ©cifique ---
        async function isCarAvailable(carName, pickupDateTime, returnDateTime) {
             if (!dbReady || !carName || !pickupDateTime || !returnDateTime || isNaN(pickupDateTime) || isNaN(returnDateTime)) {
                 console.error("DonnÃ©es invalides pour isCarAvailable", carName, pickupDateTime, returnDateTime);
                 return { available: false, reason: 'Erreur interne' };
             }
             try {
                 // 1. VÃ©rifier statut manuel
                 const manualStatusDocRef = doc(db, "car_manual_status", carName);
                 const manualStatusSnap = await getDoc(manualStatusDocRef);
                 if (manualStatusSnap.exists() && manualStatusSnap.data().status === 'unavailable') {
                     return { available: false, reason: 'Indisponible' };
                 }

                 // 2. VÃ©rifier les pÃ©riodes d'indisponibilitÃ©
                 const pickupTimestamp = Timestamp.fromDate(pickupDateTime);
                 const returnTimestamp = Timestamp.fromDate(returnDateTime);

                 // Query for periods ending after the requested pickup time
                 const qPeriodsEndAfterPickup = query(
                     unavailabilityPeriodsCollectionRef,
                     where("car", "==", carName),
                     where("endDate", ">", pickupTimestamp) // Check if the period ENDS AFTER the requested START
                 );

                 const periodsSnapshot = await getDocs(qPeriodsEndAfterPickup);
                 let isUnavailable = false;

                 for (const docSnap of periodsSnapshot.docs) {
                     const period = docSnap.data();
                     // Check if the period STARTS BEFORE the requested END time
                     if (period.startDate && period.startDate.seconds < returnTimestamp.seconds) {
                         // We have an overlap
                         isUnavailable = true;
                         break;
                     }
                 }

                 if (isUnavailable) {
                     console.log(`${carName} a une pÃ©riode d'indisponibilitÃ© qui chevauche la demande.`);
                     return { available: false, reason: `(Indisponible)` };
                 }
                 return { available: true };

             } catch (error) {
                 console.error(`Erreur vÃ©rification disponibilitÃ© pour ${carName}:`, error);
                 if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     showMessage("Index Firestore manquant dÃ©tectÃ©. Ouvrez la console (F12) et suivez le lien fourni par Firebase pour crÃ©er l'index requis. Cela peut prendre quelques minutes.", "error");
                 } else { showMessage("Erreur technique lors de la vÃ©rification de disponibilitÃ©.", "error"); }
                 return { available: false, reason: 'Erreur' };
             }
         }

        // --- Logique de Soumission Finale ---
        submitBookingButton.addEventListener('click', async () => {
             console.log("Submit button clicked"); // Log 1: Button clicked
             // Validation and data gathering
              if (!dbReady) {
                  console.error("DB not ready during submit");
                  showMessage("La connexion Ã  la base de donnÃ©es n'est pas prÃªte.", "error");
                  return;
              }
             if (!selectedCarName) { showMessage("Veuillez d'abord sÃ©lectionner une voiture.", "warning"); return; }
             if (!currentPickupDateTime || !currentReturnDateTime) { showMessage("Dates invalides. RevÃ©rifiez la disponibilitÃ©.", "warning"); return; }

             console.log("Validation passed, gathering data..."); // Log 2: Validation ok

             const formData = new FormData(form);
             const bookingData = Object.fromEntries(formData.entries());
             const requiredFields = ['nomPrenom', 'telephone', 'email', 'lieuPriseEnCharge', 'lieuRetour', 'datePriseEnCharge', 'heurePriseEnChargeHeure', 'heurePriseEnChargeMinute', 'dateRetour', 'heureRetourHeure', 'heureRetourMinute'];
             let firstEmptyField = null;
             let formIsValid = true;
             for (const field of requiredFields) {
                 if (!bookingData[field] || bookingData[field] === "") {
                    formIsValid = false;
                    let label = document.querySelector(`label[for='${field}']`)?.textContent?.replace('*','').trim() || field;
                    if (field.includes('Heure')) label = field.includes('PriseEnCharge') ? 'Heure DÃ©but' : 'Heure Fin';
                    if (field.includes('Minute')) label = field.includes('PriseEnCharge') ? 'Minute DÃ©but' : 'Minute Fin';
                    showMessage(`Le champ "${label}" est requis.`, 'warning');
                    if (!firstEmptyField) firstEmptyField = document.getElementById(field);
                 }
             }
             if (!formIsValid) {
                 if (firstEmptyField) firstEmptyField.focus();
                 return;
             }

             console.log("Form data valid, proceeding..."); // Log 3: Form data collected

             submitBookingButton.disabled = true; submitSpinner.classList.remove('hidden'); messageBox.classList.add('hidden');

             // *** FINAL AVAILABILITY CHECK ***
             console.log(`Checking final availability for ${selectedCarName}...`); // Log 4: Checking availability
             const availabilityCheck = await isCarAvailable(selectedCarName, currentPickupDateTime, currentReturnDateTime);
             console.log("Availability check result:", availabilityCheck); // Log 5: Availability result

             if (!availabilityCheck.available) {
                 showMessage(`DÃ©solÃ©, la voiture "${selectedCarName}" vient d'Ãªtre indisponible. Veuillez choisir une autre voiture.`, 'error');
                  // Re-run availability check visually
                  checkAvailabilityButton.click();
                 submitBookingButton.classList.add('hidden'); // Hide submit button again
                 submitBookingButton.disabled = false; submitSpinner.classList.add('hidden');
                 console.log("Car became unavailable, submission cancelled."); // Log 6a: Unavailable
                 return;
             }
             // *** END FINAL CHECK ***

             console.log("Car is still available, preparing details..."); // Log 6b: Available

             const heurePriseStr = `${bookingData.heurePriseEnChargeHeure.padStart(2, '0')}:${bookingData.heurePriseEnChargeMinute.padStart(2, '0')}`;
             const heureRetourStr = `${bookingData.heureRetourHeure.padStart(2, '0')}:${bookingData.heureRetourMinute.padStart(2, '0')}`;
             const bookingDetails = {
                 nomPrenom: bookingData.nomPrenom, telephone: bookingData.telephone, email: bookingData.email, lieuPriseEnCharge: bookingData.lieuPriseEnCharge, lieuRetour: bookingData.lieuRetour, datePriseEnCharge: bookingData.datePriseEnCharge, heurePriseEnCharge: heurePriseStr, dateRetour: bookingData.dateRetour, heureRetour: heureRetourStr,
                 voiture: selectedCarName, timestamp: serverTimestamp(), confirmed: false, deleted: false
             };
             console.log("Booking details object:", bookingDetails); // Log 7: Booking details ready

             let newBookingId = null;
             // 1. Save to Firestore
             try {
                 console.log("Attempting to save booking to Firestore..."); // Log 8: Saving booking
                 const docRef = await addDoc(bookingsCollectionRef, bookingDetails);
                 newBookingId = docRef.id;
                 console.log("Booking saved to Firestore, ID: ", newBookingId); // Log 9: Booking saved success

                 // Automatically add unavailability period for this booking
                 const unavailabilityData = {
                    car: selectedCarName,
                    startDate: Timestamp.fromDate(currentPickupDateTime),
                    endDate: Timestamp.fromDate(currentReturnDateTime),
                    type: 'booking', // Mark as automatically generated
                    bookingId: newBookingId // Link to the booking document
                 };
                 console.log("Attempting to add unavailability period to Firestore..."); // Log 10: Saving unavailability
                 await addDoc(unavailabilityPeriodsCollectionRef, unavailabilityData);
                 console.log("Unavailability period added automatically for", selectedCarName); // Log 11: Unavailability saved success

             } catch (error) {
                 console.error("Erreur Firestore lors de l'enregistrement: ", error); // Log 12a: Firestore error
                 showMessage("Erreur technique lors de l'enregistrement de la rÃ©servation. Veuillez rÃ©essayer.", 'error');
                 submitBookingButton.disabled = false; submitSpinner.classList.add('hidden');
                 return;
             }

             // 2. Send via Web3Forms
             try {
                 console.log("Attempting to send email via Web3Forms..."); // Log 13: Sending Web3Forms
                 const objectForWeb3Forms = { ...bookingDetails };
                 // Add necessary Web3Forms fields from hidden inputs
                 objectForWeb3Forms.access_key = form.querySelector('input[name="access_key"]').value;
                 objectForWeb3Forms.subject = form.querySelector('input[name="subject"]').value;
                 objectForWeb3Forms.from_name = form.querySelector('input[name="from_name"]').value;
                 objectForWeb3Forms.redirect = form.querySelector('input[name="redirect"]').value;
                 // Use a readable format for the email
                 objectForWeb3Forms.datePriseEnCharge = `${bookingDetails.datePriseEnCharge} ${bookingDetails.heurePriseEnCharge}`;
                 objectForWeb3Forms.dateRetour = `${bookingDetails.dateRetour} ${bookingDetails.heureRetour}`;
                 objectForWeb3Forms.timestamp_readable = formatReadableDateTime(new Date()); // Add submission time formatted
                 delete objectForWeb3Forms.timestamp; // Remove server timestamp object for JSON
                 delete objectForWeb3Forms.confirmed; delete objectForWeb3Forms.deleted; delete objectForWeb3Forms.heurePriseEnCharge; delete objectForWeb3Forms.heureRetour; // Clean up redundant fields

                 const jsonPayload = JSON.stringify(objectForWeb3Forms);
                 console.log("Web3Forms Payload:", jsonPayload); // Log 14: Web3Forms payload
                 const web3Response = await fetch("https://api.web3forms.com/submit", { method: "POST", headers: { "Content-Type": "application/json", "Accept": "application/json" }, body: jsonPayload });
                 const result = await web3Response.json();
                 if (result.success) {
                     console.log('Web3Forms Success:', result); // Log 15a: Web3Forms success
                     showMessage("Demande EnvoyÃ©e avec SuccÃ¨s ! On va vous contacter le plus proche possible pour la confirmation.", 'success');
                     form.reset();
                     // Reset time selects
                      heurePriseEnChargeHeureSelect.value = ""; heurePriseEnChargeMinuteSelect.value = "";
                      heureRetourHeureSelect.value = ""; heureRetourMinuteSelect.value = "";
                     availableCarsSection.classList.add('hidden'); submitBookingButton.classList.add('hidden');
                     selectedCarName = null; selectedCarInput.value = '';
                     // Scroll back to top after success
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 } else {
                     console.error('Web3Forms Error:', result); // Log 15b: Web3Forms error
                     // Show warning: Firestore worked, but email failed
                     showMessage("Demande enregistrÃ©e, mais l'e-mail de notification a Ã©chouÃ©. Nous vous contacterons quand mÃªme.", 'warning');
                     // Reset form anyway, as the booking is in Firestore
                     form.reset();
                     heurePriseEnChargeHeureSelect.value = ""; heurePriseEnChargeMinuteSelect.value = "";
                     heureRetourHeureSelect.value = ""; heureRetourMinuteSelect.value = "";
                     availableCarsSection.classList.add('hidden'); submitBookingButton.classList.add('hidden');
                     selectedCarName = null; selectedCarInput.value = '';
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 }
             } catch (web3Error) {
                 console.error('Erreur fetch Web3Forms:', web3Error); // Log 16: Web3Forms fetch error
                 showMessage("Demande enregistrÃ©e, mais l'e-mail de notification a Ã©chouÃ©. Nous vous contacterons quand mÃªme.", 'warning');
                 // Reset form anyway, as the booking is in Firestore
                 form.reset();
                 heurePriseEnChargeHeureSelect.value = ""; heurePriseEnChargeMinuteSelect.value = "";
                 heureRetourHeureSelect.value = ""; heureRetourMinuteSelect.value = "";
                 availableCarsSection.classList.add('hidden'); submitBookingButton.classList.add('hidden');
                 selectedCarName = null; selectedCarInput.value = '';
                 window.scrollTo({ top: 0, behavior: 'smooth' });
             } finally {
                 submitBookingButton.disabled = false; submitSpinner.classList.add('hidden');
             }
        });

        // --- Header Scroll Effect ---
        window.addEventListener('scroll', () => {
             const scrollPosition = window.scrollY;
             if (scrollPosition > 50) {
                 mainHeader.classList.add('scrolled');
             } else {
                 mainHeader.classList.remove('scrolled');
             }
        });

        // --- Mobile Menu Toggle ---
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', (e) => { e.stopPropagation(); mobileMenu.classList.toggle('hidden'); });
             // Close menu if clicking outside or on a link
             document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && !mobileMenuButton.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
            mobileMenu.querySelectorAll('a').forEach(link => { link.addEventListener('click', () => { mobileMenu.classList.add('hidden'); }); });
        }

        // --- Footer Current Year ---
        if (currentYearSpan) {
            currentYearSpan.textContent = new Date().getFullYear();
        }

        // --- Function to show/hide reservation form with animation ---
        function toggleReservationForm(show) {
            const reservationSectionEl = document.getElementById('reservation');
            if (!reservationSectionEl) {
                console.error("Reservation section not found!");
                return;
            }

            // Define classes for hidden and visible states
            const hiddenClasses = ['max-h-0', 'opacity-0', 'py-0', 'my-0', 'overflow-hidden'];
            // Adjusted max-h for potential large content, adjust if needed
            const visibleClasses = ['max-h-[3000px]', 'opacity-100', 'py-20', 'md:py-32', 'my-16', 'md:my-24']; // py-20 md:py-32 my-16 md:my-24

            if (show) {
                // Ensure it's not display: none before animating
                reservationSectionEl.style.display = 'block';

                // Use requestAnimationFrame to ensure styles are applied before adding visible classes
                requestAnimationFrame(() => {
                    hiddenClasses.forEach(c => reservationSectionEl.classList.remove(c));
                    visibleClasses.forEach(c => reservationSectionEl.classList.add(c));

                    // Scroll after a short delay to allow animation to start
                    setTimeout(() => {
                        reservationSectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 50); // Adjust delay if needed
                });

            } else {
                 // To hide, remove visible classes and add hidden classes
                 visibleClasses.forEach(c => reservationSectionEl.classList.remove(c));
                 hiddenClasses.forEach(c => reservationSectionEl.classList.add(c));
                 // Optional: Set display none after transition ends
                 // Consider removing if it causes issues with re-showing
                 /*
                 reservationSectionEl.addEventListener('transitionend', function handleTransitionEnd() {
                    if (!reservationSectionEl.classList.contains('opacity-100')) { // Check if it's hidden
                        reservationSectionEl.style.display = 'none';
                    }
                    reservationSectionEl.removeEventListener('transitionend', handleTransitionEnd); // Clean up listener
                 }, { once: true });
                 */
            }
        }


        // --- Event Listeners for showing the form ---
         const reservationTriggers = [
             heroReserveButton,
             scrollDownButton,
             navReserveButton,
             mobileReserveButton,
             ...reserveNowLinks // Spread the NodeList into the array
         ];

         reservationTriggers.forEach(trigger => {
            if(trigger) { // Check if the element exists
                trigger.addEventListener('click', (event) => {
                    event.preventDefault();
                    toggleReservationForm(true);
                });
            }
         });


        // --- Initialize time selects and hide reservation section on load ---
        document.addEventListener('DOMContentLoaded', () => {
             populateTimeSelects();
             const reservationSectionEl = document.getElementById('reservation');
             if (reservationSectionEl) {
                // Apply initial hidden classes using Tailwind and ensure no padding/margin
                reservationSectionEl.classList.add('max-h-0', 'opacity-0', 'overflow-hidden', 'p-0', 'm-0');
                reservationSectionEl.classList.remove('py-20', 'md:py-32', 'my-16', 'md:my-24'); // Explicitly remove padding/margin
                reservationSectionEl.style.display = 'block'; // Make sure it's not display:none initially
             } else {
                console.error("Reservation section element not found on DOMContentLoaded");
             }
        });

        // --- Section Animations on Scroll ---
        const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observerCallback = (entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Check if it's the reservation section and prevent animation if triggered by scroll
                    if (entry.target.id === 'reservation') {
                        // We still need to unobserve it though, otherwise it might trigger later
                        observer.unobserve(entry.target);
                        return;
                    }
                    entry.target.classList.add('visible'); // Use 'visible' class to trigger animation
                    observer.unobserve(entry.target);
                }
            });
        };

        const observer = new IntersectionObserver(observerCallback, observerOptions);
        // Observe all sections with section-animate, AND #reservation
        document.querySelectorAll('.section-animate, #reservation').forEach(section => {
             observer.observe(section);
        });

    </script>
</body>
</html>

