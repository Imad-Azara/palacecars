<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Location de Voitures à Agadir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hero-bg { background-image: url('https://placehold.co/1920x800/003366/FFFFFF?text=Bienvenue+chez+Palace+Cars'); background-size: cover; background-position: center; }
        select:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        option:disabled { color: #9ca3af; background-color: #f3f4f6; font-style: italic; }
        select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%236b7280' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E%0A");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header (inchangé) -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 lg:px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-blue-600">PalaceCars</a>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#accueil" class="text-gray-600 hover:text-blue-600">Accueil</a>
                <a href="#flotte" class="text-gray-600 hover:text-blue-600">Notre Flotte</a>
                <a href="#services" class="text-gray-600 hover:text-blue-600">Services</a>
                <a href="#faq" class="text-gray-600 hover:text-blue-600">FAQ</a>
                <a href="#contact" class="text-gray-600 hover:text-blue-600">Contact</a>
                <a href="#reservation-rapide" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-300">Réserver Maintenant</a>
            </div>
            <button id="mobile-menu-button" class="md:hidden focus:outline-none">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-md">
             <a href="#accueil" class="block py-2 px-4 text-sm text-gray-700 hover:bg-blue-50">Accueil</a>
            <a href="#flotte" class="block py-2 px-4 text-sm text-gray-700 hover:bg-blue-50">Notre Flotte</a>
            <a href="#services" class="block py-2 px-4 text-sm text-gray-700 hover:bg-blue-50">Services</a>
            <a href="#faq" class="block py-2 px-4 text-sm text-gray-700 hover:bg-blue-50">FAQ</a>
            <a href="#contact" class="block py-2 px-4 text-sm text-gray-700 hover:bg-blue-50">Contact</a>
            <a href="#reservation-rapide" class="block py-2 px-4 text-sm bg-blue-600 text-white text-center rounded-b-md hover:bg-blue-700">Réserver Maintenant</a>
        </div>
    </header>

    <!-- Hero Section (inchangé) -->
    <section id="accueil" class="hero-bg text-white py-24 md:py-40">
        <div class="container mx-auto px-4 text-center bg-black bg-opacity-50 p-8 rounded-lg max-w-4xl">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4">Location de Voitures à Agadir</h1>
            <p class="text-lg md:text-xl mb-8">Votre partenaire de confiance pour explorer le Maroc en toute liberté.</p>
            <a href="#reservation-rapide" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md text-lg transition duration-300">Réservez Votre Voiture</a>
        </div>
    </section>

    <!-- Reservation Form Section (Select voiture modifié) -->
    <section id="reservation-rapide" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <div class="bg-white p-6 md:p-10 rounded-lg shadow-xl max-w-3xl mx-auto">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">Réservation Rapide</h2>
                <form id="booking-form" class="space-y-6">
                    <!-- Personal Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="nomPrenom" class="block text-sm font-medium text-gray-700 mb-1">Nom et Prénom <span class="text-red-500">*</span></label>
                            <input type="text" id="nomPrenom" name="nomPrenom" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Votre nom complet">
                        </div>
                        <div>
                            <label for="telephone" class="block text-sm font-medium text-gray-700 mb-1">Numéro de Téléphone <span class="text-red-500">*</span></label>
                            <input type="tel" id="telephone" name="telephone" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="+212 6 XX XX XX XX">
                        </div>
                         <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Adresse E-mail <span class="text-red-500">*</span></label>
                            <input type="email" id="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="votre.email@exemple.com">
                        </div>
                         <div>
                             <label for="voiture" class="block text-sm font-medium text-gray-700 mb-1">Choisissez une voiture <span class="text-red-500">*</span></label>
                             <select id="voiture" name="voiture" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white" disabled>
                                 <option value="" disabled selected>-- Sélectionnez d'abord les dates --</option>
                                 <!-- Options gérées dynamiquement par JavaScript -->
                             </select>
                             <p id="availability-loading" class="text-xs text-blue-600 mt-1 hidden">Vérification de la disponibilité...</p>
                         </div>
                    </div>

                    <!-- Pickup & Return Details (inputs pour date/heure) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="lieuPriseEnCharge" class="block text-sm font-medium text-gray-700 mb-1">Lieu de Prise en Charge <span class="text-red-500">*</span></label>
                            <input type="text" id="lieuPriseEnCharge" name="lieuPriseEnCharge" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ex: Aéroport Agadir, Votre hôtel...">
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="datePriseEnCharge" class="block text-sm font-medium text-gray-700 mb-1">Date Début <span class="text-red-500">*</span></label>
                                <input type="date" id="datePriseEnCharge" name="datePriseEnCharge" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="heurePriseEnCharge" class="block text-sm font-medium text-gray-700 mb-1">Heure Début <span class="text-red-500">*</span></label>
                                <input type="time" id="heurePriseEnCharge" name="heurePriseEnCharge" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label for="lieuRetour" class="block text-sm font-medium text-gray-700 mb-1">Lieu de Retour <span class="text-red-500">*</span></label>
                            <input type="text" id="lieuRetour" name="lieuRetour" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ex: Aéroport Agadir, Votre hôtel...">
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="dateRetour" class="block text-sm font-medium text-gray-700 mb-1">Date Fin <span class="text-red-500">*</span></label>
                                <input type="date" id="dateRetour" name="dateRetour" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="heureRetour" class="block text-sm font-medium text-gray-700 mb-1">Heure Fin <span class="text-red-500">*</span></label>
                                <input type="time" id="heureRetour" name="heureRetour" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Message Section -->
                    <div id="message-box" class="hidden p-4 rounded-md text-center"></div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" id="submit-button" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 flex items-center justify-center mx-auto disabled:opacity-50">
                            <span>Soumettre la Demande</span>
                            <span id="submit-spinner" class="loader hidden"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

     <!-- Flotte Section (inchangée) -->
     <section id="flotte" class="py-16 bg-white"> /* ... (contenu inchangé) ... */ </section>

    <!-- Services Section (inchangée) -->
     <section id="services" class="py-16 bg-gray-50"> /* ... (contenu inchangé) ... */ </section>

    <!-- Footer (inchangé) -->
    <footer id="contact" class="bg-gray-800 text-gray-300 py-10"> /* ... (contenu inchangé) ... */ </footer>

    <!-- Script Firebase, Web3Forms et Disponibilité -->
    <script type="module">
        // Imports Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, Timestamp, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
            authDomain: "palace-cars.firebaseapp.com",
            projectId: "palace-cars",
            storageBucket: "palace-cars.firebasestorage.app",
            messagingSenderId: "469852272715",
            appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
            measurementId: "G-KCEF4WBW0G"
        };

        // --- Initialisation Firebase ---
        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef; // Périodes spécifiques
        let carManualStatusCollectionRef;     // Statut manuel (maintenance)
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            bookingsCollectionRef = collection(db, "palace_cars_bookings");
            unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
            carManualStatusCollectionRef = collection(db, "car_manual_status");
            console.log("Firebase initialisé.");
            // setLogLevel('debug');
        } catch (error) {
            console.error("Erreur Firebase:", error);
            showMessage("Erreur critique: Service de réservation indisponible.", 'error');
        }

        // --- DOM Elements ---
        const form = document.getElementById('booking-form');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-button');
        const submitSpinner = document.getElementById('submit-spinner');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const carSelect = document.getElementById('voiture');
        const pickupDateInput = document.getElementById('datePriseEnCharge');
        const pickupTimeInput = document.getElementById('heurePriseEnCharge');
        const returnDateInput = document.getElementById('dateRetour');
        const returnTimeInput = document.getElementById('heureRetour');
        const availabilityLoading = document.getElementById('availability-loading');

        // --- Liste des Voitures ---
        const allCarOptions = [ // Doit correspondre à admin.html
            { value: "Dacia Logan Diesel 2024", text: "Dacia Logan Diesel 2024 (250 Dhs/j)" },
            { value: "Dacia Logan Diesel 2025", text: "Dacia Logan Diesel 2025 (250 Dhs/j)" },
            { value: "Dacia Sandero Essence", text: "Dacia Sandero Essence (300 Dhs/j)" },
            { value: "Dacia Sandero Diesel", text: "Dacia Sandero Diesel (250 Dhs/j)" },
            { value: "Autre / Pas de préférence", text: "Autre / Pas de préférence" }
        ];

        let unavailabilityPeriods = []; // Cache pour les périodes d'indisponibilité
        let carManualStatuses = new Map(); // Cache pour les statuts manuels { carName -> 'unavailable' | 'available' }

        // --- Mobile Menu Toggle ---
        if (mobileMenuButton && mobileMenu) { /* ... */
            mobileMenuButton.addEventListener('click', () => { mobileMenu.classList.toggle('hidden'); });
            mobileMenu.querySelectorAll('a').forEach(link => { link.addEventListener('click', () => mobileMenu.classList.add('hidden')); });
        }

        // --- Initialisation et Écouteurs ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            pickupDateInput.min = today;
            returnDateInput.min = today;

            // Écouter les changements de disponibilité (périodes et statuts)
            listenForAvailabilityChanges();

            // Écouter les changements de date/heure
            [pickupDateInput, pickupTimeInput, returnDateInput, returnTimeInput].forEach(input => {
                input.addEventListener('change', updateCarSelectAvailability);
            });

            // Charger initialement les options désactivées
            populateCarSelect();
        });

        // --- Écouter les Changements de Disponibilité (Périodes et Statuts Manuels) ---
        function listenForAvailabilityChanges() {
            if (!db) return;
            console.log("Écoute des changements de disponibilité (périodes et statuts)...");

            // 1. Écouter les périodes d'indisponibilité
            const now = Timestamp.now();
            const periodsQuery = query(unavailabilityPeriodsCollectionRef, where("endDate", ">=", now));
            onSnapshot(periodsQuery, (snapshot) => {
                unavailabilityPeriods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Périodes d'indisponibilité mises à jour:", unavailabilityPeriods);
                updateCarSelectAvailability(); // Mettre à jour le selecteur
            }, (error) => {
                console.error("Erreur écoute périodes:", error);
                showMessage("Erreur mise à jour disponibilités (périodes).", "warning");
            });

            // 2. Écouter les statuts manuels
            const statusQuery = query(carManualStatusCollectionRef);
            onSnapshot(statusQuery, (snapshot) => {
                 const newStatuses = new Map();
                 snapshot.forEach((doc) => {
                     newStatuses.set(doc.id, doc.data().status); // doc.id est le nom de la voiture
                 });
                 carManualStatuses = newStatuses;
                 console.log("Statuts manuels mis à jour:", carManualStatuses);
                 updateCarSelectAvailability(); // Mettre à jour le selecteur
            }, (error) => {
                console.error("Erreur écoute statuts manuels:", error);
                showMessage("Erreur mise à jour disponibilités (statuts).", "warning");
            });
        }

        // --- Mise à jour du Selecteur de Voiture (Vérifie périodes ET statut manuel) ---
        function updateCarSelectAvailability() {
            const pickupDateStr = pickupDateInput.value;
            const pickupTimeStr = pickupTimeInput.value;
            const returnDateStr = returnDateInput.value;
            const returnTimeStr = returnTimeInput.value;

            // Vérifier si toutes les dates/heures sont remplies
            if (!pickupDateStr || !pickupTimeStr || !returnDateStr || !returnTimeStr) {
                populateCarSelect(); // Afficher "-- Sélectionnez dates --"
                return;
            }

            availabilityLoading.classList.remove('hidden');

            const userPickupDateTime = new Date(`${pickupDateStr}T${pickupTimeStr}:00`);
            const userReturnDateTime = new Date(`${returnDateStr}T${returnTimeStr}:00`);

            // Valider les dates
            if (isNaN(userPickupDateTime.getTime()) || isNaN(userReturnDateTime.getTime()) || userPickupDateTime >= userReturnDateTime) {
                 populateCarSelect(); // Garder désactivé
                 availabilityLoading.classList.add('hidden');
                 if (userPickupDateTime >= userReturnDateTime) {
                    showMessage("La date/heure de retour doit être après la prise en charge.", "warning");
                 }
                return;
            }

            // Convertir en Timestamps Firestore pour la comparaison
            const userStartTimestamp = Timestamp.fromDate(userPickupDateTime);
            const userEndTimestamp = Timestamp.fromDate(userReturnDateTime);

            const unavailableCarsInfo = new Map(); // Stocke pourquoi une voiture est indispo { carName -> "manual" | "period" }

            // 1. Vérifier le statut manuel
            carManualStatuses.forEach((status, carName) => {
                if (status === 'unavailable') {
                    unavailableCarsInfo.set(carName, "manual"); // Marquer comme indispo manuellement
                }
            });

            // 2. Vérifier les périodes d'indisponibilité (si pas déjà marqué comme indispo manuellement)
            unavailabilityPeriods.forEach(period => {
                const carName = period.car;
                // Si la voiture n'est pas déjà marquée indispo manuellement
                if (!unavailableCarsInfo.has(carName)) {
                    // Vérifier le chevauchement : (DébutClient < FinPériode) ET (FinClient > DébutPériode)
                    if (userStartTimestamp.seconds < period.endDate.seconds && userEndTimestamp.seconds > period.startDate.seconds) {
                        unavailableCarsInfo.set(carName, "period"); // Marquer comme indispo à cause d'une période
                    }
                }
            });

            console.log("Voitures indisponibles pour la période:", unavailableCarsInfo);
            populateCarSelect(unavailableCarsInfo); // Mettre à jour le selecteur
            availabilityLoading.classList.add('hidden');
        }

        // --- Remplir le Selecteur de Voiture ---
        function populateCarSelect(unavailableCarsInfo = null) {
            carSelect.innerHTML = ''; // Vider

            // Si aucune date n'est sélectionnée ou si la map est null
            if (!unavailableCarsInfo) {
                const defaultOption = document.createElement('option');
                defaultOption.value = ""; defaultOption.textContent = "-- Sélectionnez d'abord les dates --";
                defaultOption.disabled = true; defaultOption.selected = true;
                carSelect.appendChild(defaultOption);
                carSelect.disabled = true; return;
            }

            const placeholderOption = document.createElement('option');
             placeholderOption.value = ""; placeholderOption.textContent = "Sélectionnez un modèle";
             placeholderOption.disabled = true; placeholderOption.selected = true;
             carSelect.appendChild(placeholderOption);

            let availableCount = 0;
            allCarOptions.forEach(carInfo => {
                const option = document.createElement('option');
                option.value = carInfo.value;
                const isUnavailable = unavailableCarsInfo.has(carInfo.value);

                option.textContent = carInfo.text + (isUnavailable ? " (Indisponible)" : " (Disponible)");
                option.disabled = isUnavailable;
                if (isUnavailable) {
                    option.style.color = '#9ca3af';
                } else if (carInfo.value !== "Autre / Pas de préférence") { // Ne pas compter "Autre" comme disponible
                    availableCount++;
                }

                carSelect.appendChild(option);
            });

            // Si aucune voiture n'est disponible (sauf "Autre")
            if (availableCount === 0 && carSelect.querySelector('option[value="Autre / Pas de préférence"]')) {
                 // On peut laisser "Autre" sélectionnable, ou ajouter un message
                 console.log("Aucune voiture spécifique disponible pour ces dates.");
            }

            carSelect.disabled = false; // Activer le selecteur
        }

        // --- Logique de Soumission du Formulaire (Firestore + Web3Forms - ajustée validation) ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db) { showMessage("Service indisponible.", 'error'); return; }

            // Récupérer les dates/heures sélectionnées par l'utilisateur
            const pickupDateStr = pickupDateInput.value;
            const pickupTimeStr = pickupTimeInput.value;
            const returnDateStr = returnDateInput.value;
            const returnTimeStr = returnTimeInput.value;
            const selectedCarValue = carSelect.value;

             // Vérification finale si une voiture est sélectionnée et si elle est disponible
            if (!selectedCarValue || selectedCarValue === "") {
                showMessage("Veuillez choisir une voiture.", 'error'); return;
            }
             const selectedCarOption = carSelect.options[carSelect.selectedIndex];
             if (selectedCarOption && selectedCarOption.disabled) {
                showMessage("La voiture sélectionnée est indisponible pour ces dates.", 'error');
                return; // Empêche la soumission
             }
             if (!pickupDateStr || !pickupTimeStr || !returnDateStr || !returnTimeStr) {
                  showMessage("Veuillez sélectionner les dates et heures.", 'error'); return;
             }


            submitButton.disabled = true; submitSpinner.classList.remove('hidden');
            submitButton.querySelector('span').textContent = "Envoi...";
            showMessage('Envoi de votre demande...', 'loading');

            const formData = new FormData(form);
            const bookingDataFirestore = {
                nomPrenom: formData.get('nomPrenom')?.trim() || null,
                telephone: formData.get('telephone')?.trim() || null,
                email: formData.get('email')?.trim() || null,
                voiture: selectedCarValue, // Utiliser la valeur validée
                lieuPriseEnCharge: formData.get('lieuPriseEnCharge')?.trim() || null,
                datePriseEnCharge: pickupDateStr,
                heurePriseEnCharge: pickupTimeStr,
                lieuRetour: formData.get('lieuRetour')?.trim() || null,
                dateRetour: returnDateStr,
                heureRetour: returnTimeStr,
                timestamp: serverTimestamp(),
                confirmed: false,
                deleted: false
            };
             const objectForWeb3Forms = { ...Object.fromEntries(formData), voiture: selectedCarValue }; // S'assurer que la bonne voiture est envoyée
             objectForWeb3Forms.subject = `Nouvelle Réservation: ${bookingDataFirestore.voiture || 'N/A'} - ${bookingDataFirestore.nomPrenom || 'N/A'}`;
             objectForWeb3Forms.from_name = "Site Web Palace Cars";
             objectForWeb3Forms.access_key = "9a2470af-9163-405c-abc9-3aafd98b14fd";

            let firestoreSuccess = false;
            try {
                // Enregistrer la réservation
                const docRef = await addDoc(bookingsCollectionRef, bookingDataFirestore);
                console.log("Firestore Réservation OK:", docRef.id);
                firestoreSuccess = true;

                // Ajouter automatiquement une période d'indisponibilité pour cette réservation
                // Convertir les dates/heures en Timestamps pour la période
                 const startDateTime = new Date(`${pickupDateStr}T${pickupTimeStr}:00`);
                 const endDateTime = new Date(`${returnDateStr}T${returnTimeStr}:00`);
                 if (!isNaN(startDateTime.getTime()) && !isNaN(endDateTime.getTime())) {
                     try {
                        await addDoc(unavailabilityPeriodsCollectionRef, {
                            car: selectedCarValue,
                            startDate: Timestamp.fromDate(startDateTime),
                            endDate: Timestamp.fromDate(endDateTime),
                            type: 'booking', // Marquer comme venant d'une réservation
                            bookingId: docRef.id // Lier à la réservation
                        });
                        console.log("Période d'indisponibilité ajoutée pour la réservation:", docRef.id);
                     } catch (periodError) {
                         console.error("Erreur ajout période d'indisponibilité:", periodError);
                         // Continuer même si l'ajout de période échoue, mais logguer l'erreur
                     }
                 }

            } catch (error) {
                console.error("Erreur Firestore:", error);
                showMessage("Erreur lors de l'enregistrement. Réessayez.", 'error');
                resetSubmitButton(); return;
            }

            // Envoyer l'email Web3Forms seulement après succès Firestore
            if (firestoreSuccess) {
                console.log("Envoi Web3Forms...");
                 try {
                     const response = await fetch('https://api.web3forms.com/submit', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(objectForWeb3Forms) });
                     const result = await response.json();
                     if (result.success) {
                         console.log('Web3Forms OK:', result);
                         showMessage("Demande Envoyée avec Succès ! On va vous contacter le plus proche possible pour la confirmation.", 'success');
                     } else {
                         console.error('Web3Forms Erreur:', result);
                         showMessage(`Demande enregistrée, mais l'envoi de l'email a échoué. Vous serez contacté.`, 'warning');
                     }
                 } catch (error) {
                     console.error('Web3Forms Fetch Erreur:', error);
                     showMessage("Demande enregistrée, mais erreur réseau email. Vous serez contacté.", 'warning');
                 } finally {
                     form.reset(); populateCarSelect(); // Reset form et selecteur
                     resetSubmitButton();
                 }
            }
        });

        // --- Helper Functions (inchangées) ---
        function showMessage(msg, type) { /* ... */
              messageBox.textContent = msg;
            messageBox.className = 'p-4 rounded-md text-center text-sm ';
            if (type === 'success') messageBox.classList.add('bg-green-100', 'text-green-700');
            else if (type === 'error') messageBox.classList.add('bg-red-100', 'text-red-700');
            else if (type === 'warning') messageBox.classList.add('bg-yellow-100', 'text-yellow-700');
            else messageBox.classList.add('bg-blue-100', 'text-blue-700');
            messageBox.classList.remove('hidden');
            if (type !== 'error' && type !== 'loading') { setTimeout(() => { messageBox.classList.add('hidden'); }, 7000); }
        }
        function resetSubmitButton() { /* ... */
              submitButton.disabled = false;
            submitSpinner.classList.add('hidden');
            submitButton.querySelector('span').textContent = "Soumettre la Demande";
         }

    </script>

</body>
</html>

