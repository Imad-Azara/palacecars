<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Location de Voiture Agadir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Ajout de Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3F5f5qK2K6Q24L+nkA5bf5F3Gmf0iVCi/2fA/wz2N9H/Gz9oW9sP7Cg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hero-bg { background-image: url('https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; } /* Example background */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block; /* To show it next to text */
            margin-left: 8px; /* Space from text */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        /* Style for selected car card */
        .car-card.selected {
            border-color: #3b82f6; /* Blue border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            transform: scale(1.02);
            transition: all 0.2s ease-in-out;
        }
        /* Ajustement pour les selects heure/minute */
        .time-select-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        select {
             -webkit-appearance: none;
             -moz-appearance: none;
             appearance: none;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem; /* Make space for arrow */
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-blue-600">PalaceCars</a>
            <div class="space-x-4 hidden md:flex">
                <a href="#accueil" class="text-gray-600 hover:text-blue-600">Accueil</a>
                <a href="#flotte" class="text-gray-600 hover:text-blue-600">Flotte</a>
                <a href="#services" class="text-gray-600 hover:text-blue-600">Services</a>
                <a href="#faq" class="text-gray-600 hover:text-blue-600">FAQ</a>
                <a href="#contact" class="text-gray-600 hover:text-blue-600">Contact</a>
            </div>
            <a href="#reservation" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300">Réserver Maintenant</a>
            <!-- Mobile Menu Button (optional) -->
        </nav>
    </header>

    <!-- Hero Section -->
    <section id="accueil" class="hero-bg text-white py-20 md:py-32">
        <div class="container mx-auto px-6 text-center bg-black bg-opacity-50 rounded-lg py-10">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Location de Voiture Facile à Agadir</h1>
            <p class="text-lg md:text-xl mb-8">Découvrez notre flotte diversifiée, offrant luxe, économie et 4x4 pour chaque aventure.</p>
            <a href="#reservation" class="bg-blue-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Voir les Voitures & Réserver</a>
        </div>
    </section>

    <!-- Reservation Form Section -->
    <section id="reservation" class="py-16 bg-gray-100">
        <div class="container mx-auto px-6 max-w-4xl">
            <div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Réservation Rapide</h2>

                <!-- Message Box -->
                <div id="message-box" class="hidden p-4 rounded-md text-center mb-6"></div>

                <!-- Formulaire -->
                <form id="booking-form" class="space-y-6">
                     <!-- Web3Forms Hidden Inputs -->
                     <input type="hidden" name="subject" value="Nouvelle demande de réservation - Palace Cars">
                     <input type="hidden" name="from_name" value="Palace Cars Réservation">
                     <!-- Remplacer par votre clé -->
                     <input type="hidden" name="access_key" value="9a2470af-9163-405c-abc9-3aafd98b14fd">
                     <input type="hidden" name="redirect" value="https://web3forms.com/success"> <!-- Optionnel: page de succès -->

                    <!-- Champs Client -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="nomPrenom" class="block text-sm font-medium text-gray-700">Nom et Prénom <span class="text-red-500">*</span></label>
                            <input type="text" id="nomPrenom" name="nomPrenom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="telephone" class="block text-sm font-medium text-gray-700">Numéro de Téléphone <span class="text-red-500">*</span></label>
                            <input type="tel" id="telephone" name="telephone" required placeholder="+212 6 XX XX XX XX" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Adresse E-mail <span class="text-red-500">*</span></label>
                        <input type="email" id="email" name="email" required placeholder="votre.email@exemple.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Champs Lieu -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="lieuPriseEnCharge" class="block text-sm font-medium text-gray-700">Lieu de Prise en Charge <span class="text-red-500">*</span></label>
                            <input type="text" id="lieuPriseEnCharge" name="lieuPriseEnCharge" required placeholder="ex: Aéroport Agadir, Votre hôtel..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="lieuRetour" class="block text-sm font-medium text-gray-700">Lieu de Retour <span class="text-red-500">*</span></label>
                            <input type="text" id="lieuRetour" name="lieuRetour" required placeholder="ex: Aéroport Agadir, Votre hôtel..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Champs Date et Heure -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Date et Heure de Début -->
                        <div>
                            <label for="datePriseEnCharge" class="block text-sm font-medium text-gray-700">Date & Heure Début <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="date" id="datePriseEnCharge" name="datePriseEnCharge" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <select id="heurePriseEnChargeHeure" name="heurePriseEnChargeHeure" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">Heure</option> <!-- MODIFICATION -->
                                    <!-- Options ajoutées par JS -->
                                </select>
                                <select id="heurePriseEnChargeMinute" name="heurePriseEnChargeMinute" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">Minute</option> <!-- MODIFICATION -->
                                    <!-- Options ajoutées par JS -->
                                </select>
                            </div>
                        </div>
                         <!-- Date et Heure de Fin -->
                         <div>
                            <label for="dateRetour" class="block text-sm font-medium text-gray-700">Date & Heure Fin <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="date" id="dateRetour" name="dateRetour" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <select id="heureRetourHeure" name="heureRetourHeure" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">Heure</option> <!-- MODIFICATION -->
                                    <!-- Options ajoutées par JS -->
                                </select>
                                <select id="heureRetourMinute" name="heureRetourMinute" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">Minute</option> <!-- MODIFICATION -->
                                     <!-- Options ajoutées par JS -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Bouton Vérifier Disponibilité -->
                    <div class="text-center pt-2">
                        <button type="button" id="check-availability-button" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 flex items-center justify-center mx-auto disabled:opacity-50">
                            <span>Vérifier la Disponibilité</span>
                            <span id="availability-spinner" class="loader !border-t-white !border-l-white hidden ml-2"></span>
                        </button>
                    </div>

                    <!-- Champ caché pour stocker la voiture sélectionnée -->
                     <input type="hidden" id="selectedCar" name="voiture">

                </form> <!-- Fin du formulaire initial -->

                 <!-- Section pour afficher les voitures disponibles (initiallement cachée) -->
                 <div id="available-cars-section" class="mt-10 hidden">
                    <h3 class="text-2xl font-semibold text-center text-gray-800 mb-6">Voitures Disponibles pour cette période</h3>
                    <div id="available-cars-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Les cartes de voitures seront injectées ici par JS -->
                    </div>
                    <p id="no-cars-message" class="text-center text-gray-600 mt-4 hidden">Aucune voiture disponible pour les dates sélectionnées.</p>

                    <!-- Bouton Soumettre Final (initiallement caché) -->
                    <div class="text-center mt-8">
                        <button type="button" id="submit-booking-button" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 hidden flex items-center justify-center mx-auto disabled:opacity-50">
                            <span>Soumettre la Demande de Réservation</span>
                            <span id="submit-spinner" class="loader !border-t-white !border-l-white hidden ml-2"></span>
                        </button>
                    </div>
                 </div>

            </div>
        </div>
    </section>

    <!-- Featured Cars Section -->
    <section id="flotte" class="py-16">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-10">Notre Flotte Populaire</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Car Card 1 -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <img src="https://placehold.co/300x200/cccccc/333333?text=Logan+Diesel+24" alt="Dacia Logan Diesel 2024" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+indispo';" >
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Dacia Logan Diesel 2024</h3>
                        <p class="text-gray-600 mb-4">Économique et fiable, idéale pour la ville et les trajets courts.</p>
                        <p class="text-lg font-bold text-blue-600">250 Dhs / jour</p>
                    </div>
                </div>
                <!-- Car Card 2 -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <img src="https://placehold.co/300x200/cccccc/333333?text=Logan+Diesel+25" alt="Dacia Logan Diesel 2025" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+indispo';">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Dacia Logan Diesel 2025</h3>
                        <p class="text-gray-600 mb-4">Le dernier modèle, confort et économie améliorés.</p>
                        <p class="text-lg font-bold text-blue-600">250 Dhs / jour</p>
                    </div>
                </div>
                <!-- Car Card 3 -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <img src="https://placehold.co/300x200/cccccc/333333?text=Sandero+Essence" alt="Dacia Sandero Essence" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+indispo';">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Dacia Sandero Essence</h3>
                        <p class="text-gray-600 mb-4">Compacte et agile, parfaite pour explorer la ville.</p>
                        <p class="text-lg font-bold text-blue-600">300 Dhs / jour</p>
                    </div>
                </div>
                 <!-- Car Card 4 -->
                 <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <img src="https://placehold.co/300x200/cccccc/333333?text=Sandero+Diesel" alt="Dacia Sandero Diesel" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+indispo';">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">Dacia Sandero Diesel</h3>
                        <p class="text-gray-600 mb-4">Version diesel économique pour plus de kilomètres.</p>
                        <p class="text-lg font-bold text-blue-600">250 Dhs / jour</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="py-16 bg-gray-200">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-10">Nos Services</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-3">Livraison Aéroport</h3>
                    <p class="text-gray-600">Récupérez votre voiture dès votre arrivée à l'aéroport d'Agadir.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-3">Assistance 24/7</h3>
                    <p class="text-gray-600">Nous sommes disponibles à tout moment en cas de besoin.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-3">Kilométrage Illimité</h3>
                    <p class="text-gray-600">Explorez sans limites avec nos offres de kilométrage illimité.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section (Placeholder) -->
    <section id="faq" class="py-16">
         <div class="container mx-auto px-6 max-w-3xl">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-10">Questions Fréquentes (FAQ)</h2>
            <div class="space-y-4">
                <details class="bg-white p-4 rounded-lg shadow cursor-pointer">
                    <summary class="font-semibold">Quels documents sont nécessaires pour louer ?</summary>
                    <p class="mt-2 text-gray-600">Vous aurez besoin de votre permis de conduire valide, d'une pièce d'identité (passeport ou CIN) et d'une carte de crédit pour la caution.</p>
                </details>
                 <details class="bg-white p-4 rounded-lg shadow cursor-pointer">
                    <summary class="font-semibold">Quel est l'âge minimum pour louer ?</summary>
                    <p class="mt-2 text-gray-600">L'âge minimum est généralement de 21 ans avec un permis de conduire valide depuis au moins un an. Des conditions spécifiques peuvent s'appliquer pour certaines catégories de véhicules.</p>
                </details>
                 <details class="bg-white p-4 rounded-lg shadow cursor-pointer">
                    <summary class="font-semibold">L'assurance est-elle incluse ?</summary>
                    <p class="mt-2 text-gray-600">Oui, nos tarifs incluent une assurance responsabilité civile et une assurance de base contre les dommages avec franchise. Des options d'assurance complémentaire sont disponibles.</p>
                </details>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="py-16 bg-blue-700 text-white">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-6">Contactez-Nous</h2>
            <p class="mb-8">Pour toute question ou demande spécifique, n'hésitez pas à nous appeler ou nous envoyer un message.</p>
            <p class="text-xl font-semibold mb-2"><i class="fas fa-phone mr-2"></i> +212 659 198 122</p>
            <p class="text-lg"><i class="fas fa-envelope mr-2"></i> contact@palacecars.ma</p>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-8">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 PalaceCars - Tous droits réservés.</p>
             <!-- Lien Admin supprimé du footer public -->
        </div>
    </footer>


    <!-- Script Firebase & Logique -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, getDoc, getDocs, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('debug'); // Pour debug

        // --- Configuration Firebase (UTILISEZ VOTRE VRAIE CONFIG) ---
        const firebaseConfig = {
             apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
             authDomain: "palace-cars.firebaseapp.com",
             projectId: "palace-cars",
             storageBucket: "palace-cars.firebasestorage.app",
             messagingSenderId: "469852272715",
             appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
             measurementId: "G-KCEF4WBW0G"
        };

        // --- Initialize Firebase ---
        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef;
        let carManualStatusCollectionRef;
        let dbReady = false;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            bookingsCollectionRef = collection(db, "palace_cars_bookings");
            unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
            carManualStatusCollectionRef = collection(db, "car_manual_status");
            dbReady = true;
            console.log("Firebase initialisé avec succès.");
        } catch (error) {
            console.error("Erreur critique d'initialisation Firebase:", error);
            showMessage("Erreur de connexion à la base de données. Veuillez réessayer plus tard.", 'error');
        }

        // --- Liste des Voitures et Prix ---
        const carFleet = {
            "Dacia Logan Diesel 2024": { price: 250, image: "https://placehold.co/300x200/cccccc/333333?text=Logan+Diesel+24" },
            "Dacia Logan Diesel 2025": { price: 250, image: "https://placehold.co/300x200/cccccc/333333?text=Logan+Diesel+25" },
            "Dacia Sandero Essence": { price: 300, image: "https://placehold.co/300x200/cccccc/333333?text=Sandero+Essence" },
            "Dacia Sandero Diesel": { price: 250, image: "https://placehold.co/300x200/cccccc/333333?text=Sandero+Diesel" },
            // Ajoutez d'autres voitures ici si nécessaire
        };
        const carNames = Object.keys(carFleet); // ["Dacia Logan...", "Dacia Sandero...", ...]

        // --- DOM Elements ---
        const form = document.getElementById('booking-form');
        const messageBox = document.getElementById('message-box');
        const checkAvailabilityButton = document.getElementById('check-availability-button');
        const availabilitySpinner = document.getElementById('availability-spinner');
        const availableCarsSection = document.getElementById('available-cars-section');
        const availableCarsListDiv = document.getElementById('available-cars-list');
        const noCarsMessage = document.getElementById('no-cars-message');
        const submitBookingButton = document.getElementById('submit-booking-button');
        const submitSpinner = document.getElementById('submit-spinner');
        const selectedCarInput = document.getElementById('selectedCar'); // Champ caché

        // Champs du formulaire
        const nomPrenomInput = document.getElementById('nomPrenom');
        const telephoneInput = document.getElementById('telephone');
        const emailInput = document.getElementById('email');
        const lieuPriseEnChargeInput = document.getElementById('lieuPriseEnCharge');
        const lieuRetourInput = document.getElementById('lieuRetour');
        const datePriseEnChargeInput = document.getElementById('datePriseEnCharge');
        const heurePriseEnChargeHeureSelect = document.getElementById('heurePriseEnChargeHeure'); // NEW Select
        const heurePriseEnChargeMinuteSelect = document.getElementById('heurePriseEnChargeMinute'); // NEW Select
        const dateRetourInput = document.getElementById('dateRetour');
        const heureRetourHeureSelect = document.getElementById('heureRetourHeure'); // NEW Select
        const heureRetourMinuteSelect = document.getElementById('heureRetourMinute'); // NEW Select

        let selectedCarName = null; // Pour stocker la voiture sélectionnée
        let currentPickupDateTime = null; // Stocker les dates pour la vérification finale
        let currentReturnDateTime = null;

        // --- Fonctions Utilitaires ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-yellow-100', 'text-yellow-700', 'bg-blue-100', 'text-blue-700'); // Clean all potential classes
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'warning') {
                 messageBox.classList.add('bg-yellow-100', 'text-yellow-700');
            } else { // info default
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
             messageBox.classList.remove('hidden');
            // Hide after 7 seconds
            setTimeout(() => { messageBox.classList.add('hidden'); }, 7000);
        }

        // Convertit date (YYYY-MM-DD), heure (HH) et minute (MM) en objet Date JS
        function getDateTimeObject(dateStr, hourStr, minuteStr) {
            if (!dateStr || hourStr === "" || minuteStr === "") return null; // Check for empty selects
            try {
                // S'assurer que heure et minute sont formatées sur deux chiffres
                const hour = hourStr.padStart(2, '0');
                const minute = minuteStr.padStart(2, '0');
                const dateTimeString = `${dateStr}T${hour}:${minute}:00`;
                 // Vérifier si la date est valide
                 const d = new Date(dateTimeString);
                 if (isNaN(d.getTime())) {
                     throw new Error("Invalid date/time string generated");
                 }
                return d;
            } catch (e) {
                console.error("Erreur conversion date/heure:", dateStr, hourStr, minuteStr, e);
                return null;
            }
        }

        // --- Remplissage des Selects Heure/Minute ---
        function populateTimeSelects() {
            const hourSelects = [heurePriseEnChargeHeureSelect, heureRetourHeureSelect];
            const minuteSelects = [heurePriseEnChargeMinuteSelect, heureRetourMinuteSelect];

            // Heures (00-23)
            hourSelects.forEach(select => {
                // Ne pas supprimer l'option placeholder existante
                for (let i = 0; i < 24; i++) {
                    const value = i.toString().padStart(2, '0');
                    select.options.add(new Option(value, value));
                }
            });

            // Minutes (00-59)
            minuteSelects.forEach(select => {
                 // Ne pas supprimer l'option placeholder existante
                 for (let i = 0; i < 60; i++) { // Minutes de 0 à 59
                    const value = i.toString().padStart(2, '0');
                    select.options.add(new Option(value, value));
                }
            });
        }
        // Appeler au chargement de la page
        document.addEventListener('DOMContentLoaded', populateTimeSelects);

        // --- Vérification de Disponibilité Spécifique pour une Voiture et Période ---
        async function isCarAvailable(carName, pickupDateTime, returnDateTime) {
             if (!dbReady || !carName || !pickupDateTime || !returnDateTime) return false;

             try {
                 // 1. Vérifier le statut manuel
                 const manualStatusDocRef = doc(db, "car_manual_status", carName);
                 const manualStatusSnap = await getDoc(manualStatusDocRef);
                 if (manualStatusSnap.exists() && manualStatusSnap.data().status === 'unavailable') {
                     console.log(`${carName} est marqué indisponible manuellement.`);
                     return false; // Indisponible manuellement
                 }

                 // 2. Vérifier les périodes d'indisponibilité
                 const pickupTimestamp = Timestamp.fromDate(pickupDateTime);
                 const returnTimestamp = Timestamp.fromDate(returnDateTime);

                 // Requête pour trouver les périodes qui chevauchent la demande
                 // Une période P chevauche une demande D si :
                 // (P.start < D.end) ET (P.end > D.start)
                 const qPeriods = query(
                     unavailabilityPeriodsCollectionRef,
                     where("car", "==", carName),
                     where("startDate", "<", returnTimestamp) // Période commence avant la fin de la demande
                     // La condition P.end > D.start est vérifiée en JS ci-dessous car Firestore ne supporte pas deux 'range filter' (<, >) sur des champs différents
                 );
                 const periodsSnapshot = await getDocs(qPeriods);
                 let overlaps = false;
                 periodsSnapshot.forEach(docSnap => {
                     const period = docSnap.data();
                     // Vérification finale du chevauchement (P.end > D.start)
                     if (period.endDate.toDate() > pickupDateTime) {
                         console.log(`${carName} indisponible car période ${docSnap.id} chevauche.`);
                         overlaps = true;
                     }
                 });

                 return !overlaps; // Disponible seulement s'il n'y a pas de chevauchement

             } catch (error) {
                 console.error(`Erreur vérification disponibilité pour ${carName}:`, error);
                 // En cas d'erreur Firestore (ex: index manquant), afficher un message plus clair
                 if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     showMessage("Erreur de base de données : Index manquant. Veuillez contacter l'administrateur.", "error");
                 }
                 return false; // En cas d'erreur, considérer comme indisponible par sécurité
             }
         }


        // --- Logique de Vérification de Disponibilité (Bouton Vert) ---
        checkAvailabilityButton.addEventListener('click', async () => {
            if (!dbReady) {
                showMessage("La connexion à la base de données n'est pas prête. Réessayez.", "error");
                return;
            }

            // Récupérer et valider les dates et heures depuis les selects
            const startDateStr = datePriseEnChargeInput.value;
            const startHourStr = heurePriseEnChargeHeureSelect.value;
            const startMinuteStr = heurePriseEnChargeMinuteSelect.value;
            const endDateStr = dateRetourInput.value;
            const endHourStr = heureRetourHeureSelect.value;
            const endMinuteStr = heureRetourMinuteSelect.value;

            if (!startDateStr || startHourStr === "" || startMinuteStr === "" || !endDateStr || endHourStr === "" || endMinuteStr === "") {
                showMessage("Veuillez sélectionner les dates, heures et minutes de début et de fin.", "warning");
                return;
            }

            currentPickupDateTime = getDateTimeObject(startDateStr, startHourStr, startMinuteStr); // Stocker pour la soumission
            currentReturnDateTime = getDateTimeObject(endDateStr, endHourStr, endMinuteStr);     // Stocker pour la soumission

            if (!currentPickupDateTime || !currentReturnDateTime) {
                showMessage("Format de date ou d'heure invalide.", "error");
                currentPickupDateTime = null; currentReturnDateTime = null; // Reset stored dates
                return;
            }

            // Ajouter une validation simple pour s'assurer que la date de prise en charge n'est pas dans le passé
            const now = new Date();
             // Permettre la réservation pour aujourd'hui mais pas dans le passé
            if (currentPickupDateTime < new Date(now.getFullYear(), now.getMonth(), now.getDate())) {
                 showMessage("La date de prise en charge ne peut pas être dans le passé.", "warning");
                 return;
            }


            if (currentPickupDateTime >= currentReturnDateTime) {
                showMessage("La date/heure de retour doit être après la date/heure de prise en charge.", "warning");
                currentPickupDateTime = null; currentReturnDateTime = null; // Reset stored dates
                return;
            }

            // --- Reste de la logique de vérification (identique à avant) ---
            availabilitySpinner.classList.remove('hidden');
            checkAvailabilityButton.disabled = true;
            availableCarsSection.classList.add('hidden');
            availableCarsListDiv.innerHTML = '';
            noCarsMessage.classList.add('hidden');
            submitBookingButton.classList.add('hidden');
            selectedCarName = null;
            selectedCarInput.value = '';

            try {
                // Récupérer les statuts manuels
                const manualStatusSnapshot = await getDocs(carManualStatusCollectionRef);
                const manuallyUnavailableCars = new Set();
                manualStatusSnapshot.forEach(doc => {
                    if (doc.data().status === 'unavailable') {
                        manuallyUnavailableCars.add(doc.id);
                    }
                });

                // Récupérer les périodes d'indisponibilité
                const pickupTimestamp = Timestamp.fromDate(currentPickupDateTime);
                const returnTimestamp = Timestamp.fromDate(currentReturnDateTime);

                // Requête pour récupérer TOUTES les périodes potentiellement pertinentes
                // On filtre ensuite en JS car deux 'range filters' ne sont pas possibles sur des champs différents
                const qPeriods = query(unavailabilityPeriodsCollectionRef); // Prend toutes les périodes

                const periodsSnapshot = await getDocs(qPeriods);
                const unavailableCarsInPeriod = new Set(); // Voitures avec chevauchement

                periodsSnapshot.forEach(docSnap => {
                     const period = docSnap.data();
                     const periodStart = period.startDate.toDate();
                     const periodEnd = period.endDate.toDate();

                     // Vérifier le chevauchement : (period.start < requested.end) AND (period.end > requested.start)
                     if (periodStart < currentReturnDateTime && periodEnd > currentPickupDateTime) {
                         unavailableCarsInPeriod.add(period.car);
                     }
                 });


                // Filtrer la flotte finale
                const availableCars = carNames.filter(carName =>
                    !manuallyUnavailableCars.has(carName) && !unavailableCarsInPeriod.has(carName)
                );

                // Afficher les résultats
                availableCarsSection.classList.remove('hidden');
                if (availableCars.length === 0) {
                    noCarsMessage.classList.remove('hidden');
                } else {
                    availableCars.forEach(carName => {
                        const carData = carFleet[carName];
                        if (carData) {
                            availableCarsListDiv.appendChild(createCarCard(carName, carData));
                        }
                    });
                }

            } catch (error) {
                console.error("Erreur lors de la vérification de disponibilité:", error);
                 if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     showMessage("Configuration de la base de données requise. Le lien pour créer l'index est dans la console F12.", "error");
                 } else {
                    showMessage("Une erreur s'est produite lors de la vérification. Veuillez réessayer.", "error");
                 }
            } finally {
                availabilitySpinner.classList.add('hidden');
                checkAvailabilityButton.disabled = false;
            }
        });

        // --- Création Carte Voiture Disponible ---
        function createCarCard(carName, carData) {
            const card = document.createElement('div');
            card.className = 'car-card bg-white rounded-lg shadow-md overflow-hidden border-2 border-transparent transition duration-200 cursor-pointer'; // Ajout border-transparent
            card.dataset.carName = carName;

            card.innerHTML = `
                <img src="${carData.image || 'https://placehold.co/300x200/e2e8f0/cbd5e0?text=Image+Voiture'}" alt="${carName}" class="w-full h-40 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e0e0e0/a0a0a0?text=Image+Indispo';">
                <div class="p-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-1">${carName}</h4>
                    <p class="text-md font-bold text-blue-600 mb-3">${carData.price} Dhs / jour</p>
                    <button type="button" class="select-car-button w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md text-sm transition duration-300">
                        Sélectionner
                    </button>
                </div>
            `;

             // Event listener pour la sélection
             card.addEventListener('click', () => {
                 // Désélectionner toutes les autres cartes
                 document.querySelectorAll('.car-card.selected').forEach(selectedCard => {
                     selectedCard.classList.remove('selected');
                     const btn = selectedCard.querySelector('.select-car-button');
                     if (btn) {
                        btn.textContent = 'Sélectionner';
                        btn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50'); // Rétablir l'état normal
                        btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        btn.disabled = false;
                     }
                 });

                 // Sélectionner cette carte
                 card.classList.add('selected');
                 const selectButton = card.querySelector('.select-car-button');
                 if (selectButton) {
                    selectButton.textContent = 'Sélectionnée ✔';
                    selectButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50'); // Griser et désactiver
                    selectButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    selectButton.disabled = true;
                 }

                 // Mettre à jour la voiture sélectionnée et afficher le bouton de soumission final
                 selectedCarName = carName;
                 selectedCarInput.value = carName; // Mettre à jour le champ caché
                 submitBookingButton.classList.remove('hidden');
                 submitBookingButton.disabled = false; // S'assurer qu'il est activé
                 submitSpinner.classList.add('hidden');
             });

            return card;
        }


        // --- Logique de Soumission Finale ---
        submitBookingButton.addEventListener('click', async () => {
             if (!dbReady) {
                 showMessage("La connexion à la base de données n'est pas prête.", "error"); return;
             }
             if (!selectedCarName) {
                 showMessage("Veuillez d'abord sélectionner une voiture.", "warning"); return;
             }
             if (!currentPickupDateTime || !currentReturnDateTime) {
                 showMessage("Les dates de réservation semblent invalides. Veuillez revérifier la disponibilité.", "warning");
                 return;
             }

             // Validation simple des champs client
             const formData = new FormData(form);
             const bookingData = Object.fromEntries(formData.entries());
             const requiredFields = ['nomPrenom', 'telephone', 'email', 'lieuPriseEnCharge', 'lieuRetour', 'datePriseEnCharge', 'heurePriseEnChargeHeure', 'heurePriseEnChargeMinute', 'dateRetour', 'heureRetourHeure', 'heureRetourMinute']; // Updated time fields
             for (const field of requiredFields) {
                 if (!bookingData[field] || bookingData[field] === "") { // Also check for empty select value
                     // Tentative de trouver le label associé
                     let label = document.querySelector(`label[for='${field}']`)?.textContent?.replace('*','').trim();
                     // Fallback si le label n'est pas directement associé via 'for'
                     if (!label) {
                         const selectElement = document.getElementById(field);
                         label = selectElement?.closest('div')?.querySelector('label')?.textContent?.replace('*','').trim() || field;
                     }
                     showMessage(`Le champ "${label || field}" est requis.`, 'warning');
                     return;
                 }
             }

             submitBookingButton.disabled = true;
             submitSpinner.classList.remove('hidden');
             messageBox.classList.add('hidden');

             // *** VÉRIFICATION FINALE DE DISPONIBILITÉ ***
             const isStillAvailable = await isCarAvailable(selectedCarName, currentPickupDateTime, currentReturnDateTime);

             if (!isStillAvailable) {
                 // MODIFICATION: Changement du message d'erreur
                 showMessage(`Désolé, la voiture "${selectedCarName}" vient d'être indisponible. Veuillez choisir une autre voiture.`, 'error');
                 availableCarsSection.classList.add('hidden');
                 submitBookingButton.classList.add('hidden');
                 selectedCarName = null;
                 selectedCarInput.value = '';
                 submitBookingButton.disabled = false;
                 submitSpinner.classList.add('hidden');
                 return; // Arrêter la soumission
             }
             // *** FIN VÉRIFICATION FINALE ***


             // Si la voiture est toujours dispo, continuer...
              // Formatage heure/minute pour l'enregistrement et l'email
             const heurePriseStr = `${bookingData.heurePriseEnChargeHeure.padStart(2, '0')}:${bookingData.heurePriseEnChargeMinute.padStart(2, '0')}`;
             const heureRetourStr = `${bookingData.heureRetourHeure.padStart(2, '0')}:${bookingData.heureRetourMinute.padStart(2, '0')}`;

             const bookingDetails = {
                 nomPrenom: bookingData.nomPrenom,
                 telephone: bookingData.telephone,
                 email: bookingData.email,
                 lieuPriseEnCharge: bookingData.lieuPriseEnCharge,
                 lieuRetour: bookingData.lieuRetour,
                 datePriseEnCharge: bookingData.datePriseEnCharge,
                 heurePriseEnCharge: heurePriseStr, // Utiliser la chaîne formatée
                 dateRetour: bookingData.dateRetour,
                 heureRetour: heureRetourStr,       // Utiliser la chaîne formatée
                 voiture: selectedCarName,
                 timestamp: serverTimestamp(),
                 confirmed: false,
                 deleted: false
             };

             // 1. Enregistrer dans Firestore
             let firestoreSuccess = false;
             let newBookingId = null;
             try {
                 const docRef = await addDoc(bookingsCollectionRef, bookingDetails);
                 newBookingId = docRef.id;
                 console.log("Réservation enregistrée avec ID: ", newBookingId);
                 firestoreSuccess = true;
             } catch (error) {
                 console.error("Erreur lors de l'enregistrement Firestore: ", error);
                 showMessage("Erreur technique lors de l'enregistrement de votre demande. Veuillez réessayer.", 'error');
                 submitBookingButton.disabled = false;
                 submitSpinner.classList.add('hidden');
                 return; // Arrêter si Firestore échoue
             }

             // 2. Envoyer via Web3Forms (si Firestore a réussi)
             try {
                 const objectForWeb3Forms = { ...bookingDetails };
                 objectForWeb3Forms.access_key = bookingData.access_key;
                 objectForWeb3Forms.subject = bookingData.subject;
                 objectForWeb3Forms.from_name = bookingData.from_name;
                 objectForWeb3Forms.redirect = bookingData.redirect;
                 // Formatage de la date/heure pour l'email
                 objectForWeb3Forms.timestamp = new Date().toLocaleString('fr-FR', {
                     year: 'numeric', month: '2-digit', day: '2-digit',
                     hour: '2-digit', minute: '2-digit', hour12: false });
                 // Supprimer les champs non nécessaires pour l'email
                 delete objectForWeb3Forms.confirmed;
                 delete objectForWeb3Forms.deleted;


                 const jsonPayload = JSON.stringify(objectForWeb3Forms);
                 const web3Response = await fetch("https://api.web3forms.com/submit", {
                     method: "POST",
                     headers: { "Content-Type": "application/json", "Accept": "application/json" },
                     body: jsonPayload
                 });
                 const result = await web3Response.json();
                 if (result.success) {
                     console.log('Web3Forms Success:', result);
                     showMessage("Demande Envoyée avec Succès ! On va vous contacter le plus proche possible pour la confirmation.", 'success');
                     form.reset(); // Vider le formulaire
                     // Réinitialiser les selects d'heure/minute à leur placeholder
                     heurePriseEnChargeHeureSelect.value = "";
                     heurePriseEnChargeMinuteSelect.value = "";
                     heureRetourHeureSelect.value = "";
                     heureRetourMinuteSelect.value = "";
                     availableCarsSection.classList.add('hidden'); // Cacher la section voiture
                     submitBookingButton.classList.add('hidden'); // Cacher le bouton soumettre
                     selectedCarName = null; // Réinitialiser
                     selectedCarInput.value = ''; // Réinitialiser champ caché
                 } else {
                     console.error('Web3Forms Error:', result);
                     showMessage("Votre demande a été enregistrée, mais l'envoi de l'e-mail de notification a échoué. Nous vous contacterons.", 'warning');
                 }
             } catch (web3Error) {
                 console.error('Erreur fetch Web3Forms:', web3Error);
                 showMessage("Votre demande a été enregistrée, mais l'envoi de l'e-mail de notification a échoué. Nous vous contacterons.", 'warning');
             } finally {
                 submitBookingButton.disabled = false;
                 submitSpinner.classList.add('hidden');
             }
        });

    </script>
</body>
</html>

