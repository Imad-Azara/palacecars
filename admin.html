<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Panneau d'Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icônes Font Awesome (CORRIGÉ DÉFINITIVEMENT) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3F5f5qK2K6Q24L+nkA5bf5F3Gmf0iVCi/2fA/wz2N9H/Gz9oW9sP7Cg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Style pour la modale et la mise en page -->
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
        :root {
            --color-primary: #2563eb; /* Blue-600 */
            --color-accent: #f59e0b; /* Amber-500 */
            --color-text-dark: #1e293b; /* Slate-800 */
        }
        /* Style pour la modale */
        #confirmation-modal {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease-in-out;
        }
        #modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
        }
        #confirmation-modal:not(.hidden) #modal-content {
            transform: scale(1);
            opacity: 1;
        }
        /* Style pour le loader */
        .loader {
            border-top-color: var(--color-primary);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Désactiver le défilement lorsque la modale est ouverte */
        body.modal-open {
            overflow: hidden;
        }

        /* Style pour les champs de date/heure de la modale */
        #modal-pickup-date, #modal-return-date, #modal-pickup-time, #modal-return-time {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* Slate-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        /* Masquer les flèches sur les inputs de type 'time' */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }
    </style>
    <!-- Liens pour PWA (Application Mobile) -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="theme-color" content="#2563eb">
</head>
<body class="antialiased text-slate-800">

    <!-- Section de Connexion (initialement visible) -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 sm:p-12 rounded-2xl shadow-xl w-full max-w-md">
            <img src="https://i.imgur.com/htqH0IE.png" alt="Palace Cars Logo" class="w-24 h-24 mx-auto mb-6 rounded-full shadow-md">
            <h1 class="text-3xl font-bold text-center text-primary mb-6">Accès Administrateur</h1>
            <div id="login-error-message" class="hidden text-center text-red-600 font-medium mb-4 p-3 bg-red-100 rounded-lg">Mot de passe incorrect.</div>
            <div class="space-y-5">
                <div>
                    <label for="password-input" class="block text-sm font-semibold text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password-input" placeholder="Entrez le mot de passe" class="block w-full px-5 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                </div>
                <button id="login-button" class="w-full bg-primary text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                    Connexion
                </button>
            </div>
        </div>
    </div>

    <!-- Panneau d'Administration Principal (initialement caché) -->
    <div id="admin-panel" class="hidden">
        
        <!-- Header du Panneau Admin -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo et Titre -->
                    <div class="flex items-center space-x-3">
                         <img src="https://i.imgur.com/htqH0IE.png" alt="Logo" class="h-12 w-12 rounded-full">
                         <h1 class="text-xl sm:text-2xl font-bold text-primary">
                            <span class="hidden sm:inline">Panneau Administrateur</span>
                            <span class="sm:hidden">Admin</span>
                        </h1>
                    </div>
                    <!-- Bouton Notifications -->
                    <div class="flex items-center space-x-4">
                        <button id="enable-notifications-button" class="text-sm font-medium text-gray-600 hover:text-primary transition duration-300">
                            Activer les Notifications
                        </button>
                        <div id="notification-status" class="hidden text-sm font-medium p-2 rounded-md"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenu Principal (Grille) -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="db-error-message" class="hidden text-center text-red-600 font-medium mb-6 p-4 bg-red-100 rounded-lg shadow"></div>
            
             <!-- Grille 2 Colonnes (responsive) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
                
                <!-- Colonne Gauche: Boîte de Réception -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-text-dark mb-6">Boîte de Réception des Réservations</h2>
                        
                        <!-- Tabs -->
                        <div class="flex border-b border-gray-200 mb-6">
                            <button id="tab-new" class="px-6 py-3 font-semibold text-primary border-b-2 border-primary -mb-px">
                                Nouvelles Demandes
                            </button>
                            <button id="tab-confirmed" class="px-6 py-3 font-semibold text-gray-500 hover:text-gray-700">
                                Réservations Confirmées
                            </button>
                        </div>
                        
                        <!-- Zone d'affichage des réservations -->
                        <div id="bookings-list" class="space-y-4">
                            <!-- Les cartes de réservation seront injectées ici -->
                        </div>
                         <div id="loading-spinner" class="flex justify-center items-center py-10">
                            <div class="loader w-12 h-12 border-4 border-gray-200 rounded-full"></div>
                         </div>
                         <p id="no-bookings-message" class="text-center text-gray-500 py-10 hidden">Aucune réservation dans cette catégorie.</p>
                    </div>
                </div>
                
                <!-- Colonne Droite: Gestion Disponibilité (Sticky) -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="lg:sticky lg:top-28"> <!-- 20px (header) + 1.5rem (main padding) = ~112px = top-28 -->
                        
                        <!-- Gérer la Disponibilité -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <h3 class="text-xl font-bold text-text-dark mb-5">Ajouter Période Indisponible</h3>
                            <form id="unavailability-form" class="space-y-4">
                                <div>
                                    <label for="car-select" class="block text-sm font-medium text-gray-700">Voiture</label>
                                    <select id="car-select" name="car" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                                        <option value="" disabled selected>Choisir...</option>
                                        <!-- Options remplies par JS -->
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                     <div>
                                        <label for="unav-start-date" class="block text-sm font-medium text-gray-700">Date Début</label>
                                        <input type="date" id="unav-start-date" name="unav-start-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <div>
                                        <label for="unav-start-time" class="block text-sm font-medium text-gray-700">Heure Début</label>
                                        <input type="time" id="unav-start-time" name="unav-start-time" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                     <div>
                                        <label for="unav-end-date" class="block text-sm font-medium text-gray-700">Date Fin</label>
                                        <input type="date" id="unav-end-date" name="unav-end-date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                    <div>
                                        <label for="unav-end-time" class="block text-sm font-medium text-gray-700">Heure Fin</label>
                                        <input type="time" id="unav-end-time" name="unav-end-time" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                                    Ajouter Période
                                </button>
                                <div id="unavailability-message" class="text-sm text-center"></div>
                            </form>
                        </div>
                        
                        <!-- Statut Actuel des Voitures -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <h3 class="text-xl font-bold text-text-dark mb-5">Statut Actuel des Voitures</h3>
                            <div id="manual-status-list" class="space-y-3">
                                <!-- Liste générée par JS -->
                            </div>
                        </div>

                         <!-- Périodes Programmées -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-text-dark mb-5">Périodes Programmées</h3>
                            <div id="unavailability-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                                <!-- Liste générée par JS -->
                                <p id="no-periods-message" class="text-sm text-gray-500 text-center">Aucune période d'indisponibilité programmée.</p>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
            </div> <!-- Fin de la Grille -->

        </main> <!-- Fin du Main Container -->
    </div> <!-- Fin du Panneau Admin -->

    <!-- Modale de Confirmation de Réservation (initialement cachée) -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300 bg-black bg-opacity-60">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 sm:p-8 transition-all duration-300 opacity-0 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-primary">Confirmer Réservation</h2>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <p class="text-text-dark mb-4">Veuillez confirmer les détails de la réservation. Vous pouvez modifier les dates/heures si nécessaire.</p>

            <!-- Message d'erreur de la modale -->
            <div id="modal-error-message" class="hidden text-sm text-red-700 bg-red-100 p-3 rounded-md mb-4"></div>

            <div class="space-y-4">
                 <!-- Détails Client (Non modifiables) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-500">Client</label>
                    <p id="modal-client-name" class="text-lg font-medium text-text-dark"></p>
                    <p id="modal-client-contact" class="text-sm text-text-medium"></p>
                </div>
                 <div>
                    <label class="block text-sm font-semibold text-gray-500">Voiture</label>
                    <p id="modal-car-name" class="text-lg font-medium text-text-dark"></p>
                </div>
                
                <!-- Champs Date/Heure Modifiables -->
                <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                    <div>
                        <label for="modal-pickup-date" class="block text-sm font-medium text-gray-700">Date Prise en Charge</label>
                        <input type="date" id="modal-pickup-date" class="mt-1">
                    </div>
                     <div>
                        <label for="modal-pickup-time" class="block text-sm font-medium text-gray-700">Heure Prise en Charge</label>
                        <input type="time" id="modal-pickup-time" class="mt-1">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-return-date" class="block text-sm font-medium text-gray-700">Date Retour</label>
                        <input type="date" id="modal-return-date" class="mt-1">
                    </div>
                     <div>
                        <label for="modal-return-time" class="block text-sm font-medium text-gray-700">Heure Retour</label>
                        <input type="time" id="modal-return-time" class="mt-1">
                    </div>
                </div>
            </div>

            <!-- Boutons d'action de la modale -->
            <div class="flex justify-end space-x-4 mt-8">
                <button id="modal-cancel-button" class="px-5 py-2.5 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Annuler
                </button>
                <button id="modal-confirm-button" class="px-5 py-2.5 text-sm font-semibold text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-400">
                    <i class="fas fa-check mr-1.5"></i>
                    Confirmer la Réservation
                </button>
            </div>
        </div>
    </div>


    <!-- Script Firebase & Logique Admin -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
            authDomain: "palace-cars.firebaseapp.com",
            projectId: "palace-cars",
            storageBucket: "palace-cars.firebasestorage.app",
            messagingSenderId: "469852272715",
            appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
            measurementId: "G-KCEF4WBW0G"
        };
        
        // --- Liste des Voitures (Synchro avec index.html) ---
        const carOptions = [
            "Dacia Logan Diesel 2024",
            "Dacia Logan Diesel 2025",
            "Dacia Sandero Essence",
            "Dacia Sandero Diesel"
        ];
        
        // --- Variables Globales ---
        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef;
        let carManualStatusCollectionRef;
        let dbReady = false;
        let unsubscribeBookings = null;
        let unsubscribePeriods = null;
        let unsubscribeManualStatus = null;
        let currentBookingListener = 'new'; // 'new' or 'confirmed'
        let currentBookingsData = new Map(); // Cache pour les données de la modale

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const loginErrorMessage = document.getElementById('login-error-message');
        const dbErrorMessage = document.getElementById('db-error-message');
        const bookingsListDiv = document.getElementById('bookings-list');
        const noBookingsMessage = document.getElementById('no-bookings-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const tabNew = document.getElementById('tab-new');
        const tabConfirmed = document.getElementById('tab-confirmed');
        const enableNotificationsButton = document.getElementById('enable-notifications-button');
        const notificationStatus = document.getElementById('notification-status');
        
        // Elements Geston Disponibilité
        const carSelect = document.getElementById('car-select');
        const unavailabilityForm = document.getElementById('unavailability-form');
        const unavMessage = document.getElementById('unavailability-message');
        const unavListDiv = document.getElementById('unavailability-list');
        const noPeriodsMessage = document.getElementById('no-periods-message');
        const manualStatusListDiv = document.getElementById('manual-status-list');

        // Elements Modale
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalContent = document.getElementById('modal-content');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const modalClientName = document.getElementById('modal-client-name');
        const modalClientContact = document.getElementById('modal-client-contact');
        const modalCarName = document.getElementById('modal-car-name');
        const modalPickupDate = document.getElementById('modal-pickup-date');
        const modalPickupTime = document.getElementById('modal-pickup-time');
        const modalReturnDate = document.getElementById('modal-return-date');
        const modalReturnTime = document.getElementById('modal-return-time');

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialisation Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                bookingsCollectionRef = collection(db, "palace_cars_bookings");
                unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
                carManualStatusCollectionRef = collection(db, "car_manual_status");
                dbReady = true;
                console.log("Firebase initialisé avec succès.");
            } catch (error) {
                console.error("Erreur critique d'initialisation Firebase:", error);
                // Afficher l'erreur sur la page de connexion
                loginErrorMessage.textContent = "Erreur critique de connexion à la base de données.";
                loginErrorMessage.classList.remove('hidden');
                loginButton.disabled = true;
                loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            // Logique de Connexion
            loginButton.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Logique de PWA (Service Worker)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker enregistré avec succès:', registration);
                        // Transmettre l'instance de registration pour les notifications
                        setupNotifications(registration);
                    })
                    .catch(error => {
                        console.error('Échec de l\'enregistrement du Service Worker:', error);
                    });
            }
        });

        // --- Logique de Connexion Admin ---
        function handleLogin() {
            const password = passwordInput.value;
            if (password === "12234") {
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                // Charger les données initiales
                loadBookings('new'); // Charger les nouvelles demandes par défaut
                listenForUnavailabilityPeriods();
                listenForManualStatusChanges();
                populateCarSelects();
            } else {
                loginErrorMessage.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        // --- Remplir les Selects ---
        function populateCarSelects() {
            carSelect.innerHTML = '<option value="" disabled selected>Choisir...</option>'; // Reset
            carOptions.forEach(carName => {
                const option = new Option(carName, carName);
                carSelect.add(option);
            });
        }

        // --- Gestion des Tabs ---
        tabNew.addEventListener('click', () => switchTab('new'));
        tabConfirmed.addEventListener('click', () => switchTab('confirmed'));

        function switchTab(tabName) {
            currentBookingListener = tabName;
            if (tabName === 'new') {
                tabNew.classList.add('text-primary', 'border-primary', '-mb-px');
                tabNew.classList.remove('text-gray-500', 'hover:text-gray-700');
                tabConfirmed.classList.add('text-gray-500', 'hover:text-gray-700');
                tabConfirmed.classList.remove('text-primary', 'border-primary', '-mb-px');
                loadBookings('new');
            } else {
                tabConfirmed.classList.add('text-primary', 'border-primary', '-mb-px');
                tabConfirmed.classList.remove('text-gray-500', 'hover:text-gray-700');
                tabNew.classList.add('text-gray-500', 'hover:text-gray-700');
                tabNew.classList.remove('text-primary', 'border-primary', '-mb-px');
                loadBookings('confirmed');
            }
        }

        // --- Chargement des Données Firestore ---
        
        // Écouter les Périodes d'Indisponibilité
        function listenForUnavailabilityPeriods() {
            if (!dbReady) return;
            if (unsubscribePeriods) unsubscribePeriods();

            const now = Timestamp.now();
            const q = query(
                unavailabilityPeriodsCollectionRef,
                where("endDate", ">", now), // Ne charger que les périodes futures ou en cours
                orderBy("endDate", "asc")
            );

            unsubscribePeriods = onSnapshot(q, (querySnapshot) => {
                unavListDiv.innerHTML = '';
                if (querySnapshot.empty) {
                    noPeriodsMessage.classList.remove('hidden');
                    return;
                }
                noPeriodsMessage.classList.add('hidden');
                querySnapshot.forEach((doc) => {
                    unavListDiv.appendChild(createPeriodListItem(doc.id, doc.data()));
                });
            }, (error) => {
                console.error("Erreur écoute périodes indispo:", error);
                 if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     dbErrorMessage.classList.remove('hidden');
                     dbErrorMessage.innerHTML += `<br><b>Erreur Index Périodes:</b> Un index est requis pour 'car_unavailability_periods'. Vérifiez la console (F12) pour le lien de création.`;
                }
            });
        }

        // Écouter les Statuts Manuels
        function listenForManualStatusChanges() {
             if (!dbReady) return;
             if (unsubscribeManualStatus) unsubscribeManualStatus();
             
             // Créer les éléments de la liste pour toutes les voitures
             manualStatusListDiv.innerHTML = '';
             const statusMap = new Map();
             carOptions.forEach(carName => {
                statusMap.set(carName, 'available'); // Par défaut
                // L'ajout à l'UI se fera par l'snapshot
             });
             
             // Écouter les changements de la collection
             unsubscribeManualStatus = onSnapshot(carManualStatusCollectionRef, (querySnapshot) => {
                // Mettre à jour la Map avec les statuts réels
                querySnapshot.forEach((doc) => {
                    if (statusMap.has(doc.id)) {
                        statusMap.set(doc.id, doc.data().status || 'available');
                    }
                });
                
                // Mettre à jour l'UI
                manualStatusListDiv.innerHTML = '';
                statusMap.forEach((status, carName) => {
                     manualStatusListDiv.appendChild(createManualStatusItem(carName, status));
                });
                
             }, (error) => {
                console.error("Erreur écoute statuts manuels:", error);
             });
        }

        // --- Création des Éléments d'UI ---

        // (CREATE) Ajouter Période Indisponible
        unavailabilityForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             if (!dbReady) return;
             
             const car = carSelect.value;
             const startDateStr = document.getElementById('unav-start-date').value;
             const startTimeStr = document.getElementById('unav-start-time').value;
             const endDateStr = document.getElementById('unav-end-date').value;
             const endTimeStr = document.getElementById('unav-end-time').value;

             if (!car || !startDateStr || !startTimeStr || !endDateStr || !endTimeStr) {
                 unavMessage.textContent = "Tous les champs sont requis.";
                 unavMessage.className = 'text-sm text-center text-red-600';
                 return;
             }
             
             // Convertir en objet Date puis en Timestamp
             const startDate = new Date(`${startDateStr}T${startTimeStr}:00`);
             const endDate = new Date(`${endDateStr}T${endTimeStr}:00`);

             if (endDate <= startDate) {
                 unavMessage.textContent = "La date de fin doit être après la date de début.";
                 unavMessage.className = 'text-sm text-center text-red-600';
                 return;
             }
             
             const data = {
                car: car,
                startDate: Timestamp.fromDate(startDate),
                endDate: Timestamp.fromDate(endDate),
                type: 'manual', // Période manuelle
                bookingId: null // Pas de lien de réservation
             };
             
             try {
                const docRef = await addDoc(unavailabilityPeriodsCollectionRef, data);
                console.log("Période manuelle ajoutée:", docRef.id);
                unavMessage.textContent = "Période ajoutée !";
                unavMessage.className = 'text-sm text-center text-green-600';
                unavailabilityForm.reset();
             } catch (error) {
                console.error("Erreur ajout période:", error);
                unavMessage.textContent = "Erreur lors de l'ajout.";
                unavMessage.className = 'text-sm text-center text-red-600';
             }
             setTimeout(() => { unavMessage.textContent = ''; }, 3000);
        });

        // (UPDATE/DELETE) Gérer Statut Manuel
        async function handleToggleManualStatus(carName, newStatus) {
            if (!dbReady) return;
            const carDocRef = doc(db, "car_manual_status", carName);
            try {
                if (newStatus === 'unavailable') {
                     await setDoc(carDocRef, { status: 'unavailable', lastUpdated: serverTimestamp() });
                     console.log(`${carName} marqué Indisponible.`);
                } else {
                    // Si 'available', on peut soit mettre à jour le statut, soit supprimer le document
                    // Supprimer est plus propre pour "disponible par défaut"
                    await deleteDoc(carDocRef);
                    console.log(`${carName} marqué Disponible (document supprimé).`);
                }
            } catch (error) {
                console.error(`Erreur maj statut ${carName}:`, error);
                dbErrorMessage.textContent = "Erreur lors de la mise à jour du statut de la voiture.";
                dbErrorMessage.classList.remove('hidden');
            }
        }
        
        // (DELETE) Supprimer Période d'Indisponibilité
        async function handleDeletePeriod(periodId) {
            if (!dbReady) return;
            if (!confirm("Vraiment supprimer cette période d'indisponibilité ?")) return;
            
            const periodDocRef = doc(db, "car_unavailability_periods", periodId);
            try {
                await deleteDoc(periodDocRef);
                console.log("Période supprimée:", periodId);
            } catch (error) {
                 console.error("Erreur suppression période:", error);
                 dbErrorMessage.textContent = "Erreur lors de la suppression de la période.";
                 dbErrorMessage.classList.remove('hidden');
            }
        }

        // --- Logique de la Modale de Confirmation ---
        
        let currentBookingIdToConfirm = null;

        function openConfirmationModal(bookingId) {
            const booking = currentBookingsData.get(bookingId);
            if (!booking) {
                console.error("Impossible de trouver les données de réservation pour", bookingId);
                return;
            }
            currentBookingIdToConfirm = bookingId;

            // Remplir les champs
            modalClientName.textContent = booking.nomPrenom;
            modalClientContact.textContent = `${booking.telephone} | ${booking.email}`;
            modalCarName.textContent = booking.voiture;
            
            // Remplir les champs date/heure
            modalPickupDate.value = booking.datePriseEnCharge;
            modalPickupTime.value = booking.heurePriseEnCharge;
            modalReturnDate.value = booking.dateRetour;
            modalReturnTime.value = booking.heureRetour;
            
            modalErrorMessage.classList.add('hidden');
            confirmationModal.classList.remove('hidden');
            modalContent.classList.remove('opacity-0', 'scale-95'); // Déclenche l'animation d'entrée
            document.body.classList.add('modal-open');
        }

        function closeConfirmationModal() {
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300); // Attend la fin de la transition
        }

        modalCloseButton.addEventListener('click', closeConfirmationModal);
        modalCancelButton.addEventListener('click', closeConfirmationModal);

        // (UPDATE) Logique de Confirmation Finale
        modalConfirmButton.addEventListener('click', async () => {
            if (!currentBookingIdToConfirm) return;

            const bookingDocRef = doc(db, "palace_cars_bookings", currentBookingIdToConfirm);
            const bookingData = currentBookingsData.get(currentBookingIdToConfirm);
            
            // 1. Récupérer les valeurs (potentiellement modifiées) de la modale
            const newPickupDateStr = modalPickupDate.value;
            const newPickupTimeStr = modalPickupTime.value;
            const newReturnDateStr = modalReturnDate.value;
            const newReturnTimeStr = modalReturnTime.value;
            
            // 2. Valider les dates/heures
            const newPickupDateTime = new Date(`${newPickupDateStr}T${newPickupTimeStr}:00`);
            const newReturnDateTime = new Date(`${newReturnDateStr}T${newReturnTimeStr}:00`);

            if (isNaN(newPickupDateTime.getTime()) || isNaN(newReturnDateTime.getTime())) {
                modalErrorMessage.textContent = "Format de date ou d'heure invalide.";
                modalErrorMessage.classList.remove('hidden');
                return;
            }
            if (newReturnDateTime <= newPickupDateTime) {
                 modalErrorMessage.textContent = "La date de fin doit être après la date de début.";
                 modalErrorMessage.classList.remove('hidden');
                 return;
            }
            
            modalErrorMessage.classList.add('hidden');
            modalConfirmButton.disabled = true;
            modalConfirmButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1.5"></i>Confirmation...';

            try {
                // 3. Mettre à jour la réservation
                const updateData = {
                    confirmed: true,
                    datePriseEnCharge: newPickupDateStr,
                    heurePriseEnCharge: newPickupTimeStr,
                    dateRetour: newReturnDateStr,
                    heureRetour: newReturnTimeStr
                };
                await updateDoc(bookingDocRef, updateData);
                console.log("Réservation confirmée:", currentBookingIdToConfirm);

                // 4. *** CORRECTION LOGIQUE ***
                // Ajouter la période d'indisponibilité MAINTENANT, lors de la confirmation
                const unavailabilityData = {
                    car: bookingData.voiture,
                    startDate: Timestamp.fromDate(newPickupDateTime),
                    endDate: Timestamp.fromDate(newReturnDateTime),
                    type: 'booking', // Marqué comme généré par une réservation
                    bookingId: currentBookingIdToConfirm // Lien vers la réservation
                 };
                 await addDoc(unavailabilityPeriodsCollectionRef, unavailabilityData);
                 console.log(`Période d'indisponibilité ajoutée pour ${bookingData.voiture} (Booking ID: ${currentBookingIdToConfirm})`);

                // 5. Fermer la modale
                closeConfirmationModal();
                // (l'écouteur onSnapshot s'occupera de rafraîchir l'UI)
                
            } catch (error) {
                console.error("Erreur lors de la confirmation finale:", error);
                 modalErrorMessage.textContent = `Erreur: ${error.message}`;
                 modalErrorMessage.classList.remove('hidden');
            } finally {
                modalConfirmButton.disabled = false;
                modalConfirmButton.innerHTML = '<i class="fas fa-check mr-1.5"></i>Confirmer la Réservation';
            }
        });


        // (DELETE) Supprimer une Réservation
        async function handleDeleteBooking(bookingId) {
            if (!dbReady) return;
            
            const bookingData = currentBookingsData.get(bookingId);
            if (!bookingData) {
                console.error("Impossible de trouver les données pour supprimer", bookingId);
                return;
            }

            const confirmMessage = `Êtes-vous sûr de vouloir supprimer cette demande ?\n\nClient: ${bookingData.nomPrenom}\nVoiture: ${bookingData.voiture}`;
            
            // Utiliser un simple confirm()
            if (!confirm(confirmMessage)) {
                return;
            }

            console.log("Suppression de la réservation:", bookingId);

            try {
                 // 1. Marquer la réservation comme supprimée (Soft delete)
                 const bookingDocRef = doc(db, "palace_cars_bookings", bookingId);
                 await updateDoc(bookingDocRef, { deleted: true });
                 console.log("Réservation marquée comme supprimée.");
                 
                 // 2. Si la réservation était confirmée, supprimer la période d'indisponibilité associée
                 if (bookingData.confirmed) {
                    console.log("Réservation confirmée, recherche de la période d'indispo associée...");
                    const q = query(unavailabilityPeriodsCollectionRef, where("bookingId", "==", bookingId));
                    const periodSnapshot = await getDocs(q);
                    
                    if (!periodSnapshot.empty) {
                        const periodDocId = periodSnapshot.docs[0].id;
                         const periodDocRef = doc(db, "car_unavailability_periods", periodDocId);
                         await deleteDoc(periodDocRef);
                         console.log("Période d'indisponibilité associée supprimée:", periodDocId);
                    } else {
                         console.log("Aucune période d'indisponibilité trouvée pour ce bookingId (peut-être déjà supprimée).");
                    }
                 }
                 // L'écouteur onSnapshot mettra à jour l'UI
                 
            } catch (error) {
                 console.error("Erreur lors de la suppression:", error);
                 dbErrorMessage.textContent = `Erreur lors de la suppression. Vérifiez la console. Message: ${error.message}`;
                 dbErrorMessage.classList.remove('hidden');
                  // Gérer l'erreur d'index si elle se produit ici
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     dbErrorMessage.innerHTML += `<br><b>Erreur Index Suppression:</b> Un index est requis pour 'car_unavailability_periods' sur 'bookingId'. Vérifiez la console (F12) pour le lien de création.`;
                }
            }
        }
        
        // --- Notifications ---
        let swRegistration = null;
        function setupNotifications(registration) {
            swRegistration = registration;
            
            enableNotificationsButton.addEventListener('click', () => {
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        setNotificationStatus('Notifications déjà activées.', 'success');
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                setNotificationStatus('Notifications activées !', 'success');
                                // Tester la notification
                                showNotification('Palace Cars Admin', 'Vous recevrez maintenant les nouvelles demandes.');
                            } else {
                                setNotificationStatus('Notifications bloquées.', 'error');
                            }
                        });
                    } else {
                         setNotificationStatus('Notifications bloquées par le navigateur.', 'error');
                    }
                } else {
                     setNotificationStatus('Notifications non supportées.', 'error');
                }
            });
            
             // Vérifier le statut au chargement
             if (Notification.permission === 'granted') {
                 setNotificationStatus('Alertes activées.', 'success');
             } else if (Notification.permission === 'denied') {
                 setNotificationStatus('Alertes bloquées.', 'error');
                 enableNotificationsButton.disabled = true;
             }
        }
        
        function setNotificationStatus(message, type) {
            notificationStatus.textContent = message;
            notificationStatus.className = 'text-sm font-medium p-2 rounded-md'; // Reset
             if (type === 'success') {
                notificationStatus.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                 notificationStatus.classList.add('bg-red-100', 'text-red-700');
            }
            notificationStatus.classList.remove('hidden');
        }

        // Fonction pour afficher une notification via le Service Worker
        function showNotification(title, body, bookingData = null) {
            if (Notification.permission !== 'granted' || !swRegistration) {
                console.log("Permission de notification non accordée ou SW non prêt.");
                return;
            }

            const options = {
                body: body,
                icon: '/icons/icon-192x192.png',
                badge: '/icons/icon-192x192.png',
                tag: bookingData ? `booking-${bookingData.bookingId}` : 'general-notification', // Utiliser un tag unique
                renotify: true, // Permet de notifier à nouveau même si le tag est le même
                data: {
                    url: window.location.href // Pour que le clic ouvre cette page
                }
            };

            // Essayer d'envoyer au Service Worker (préféré pour l'arrière-plan)
            if (navigator.serviceWorker.controller) {
                 navigator.serviceWorker.controller.postMessage({
                    type: 'show-notification',
                    title: title,
                    options: options
                 });
            } else {
                 // Fallback pour l'affichage direct (si le SW n'est pas encore actif)
                 swRegistration.showNotification(title, options)
                    .catch(err => console.error("Erreur showNotification:", err));
            }
        }
                
        // (Cette fonction est maintenant la SEULE déclaration de loadBookings)
        function loadBookings(type = 'new') {
            if (!dbReady) return;
            if (unsubscribeBookings) unsubscribeBookings(); // Détacher l'ancien écouteur

            loadingSpinner.classList.remove('hidden');
            bookingsListDiv.innerHTML = '';
            noBookingsMessage.classList.add('hidden');
            
            const showConfirmed = (type === 'confirmed');
            
            const q = query(
                bookingsCollectionRef,
                where("confirmed", "==", showConfirmed),
                where("deleted", "==", false),
                orderBy("timestamp", "desc")
            );

            let isInitialLoad = true; // Pour éviter les notifications au premier chargement
            
            unsubscribeBookings = onSnapshot(q, (querySnapshot) => {
                loadingSpinner.classList.add('hidden');
                
                if (isInitialLoad && querySnapshot.empty) {
                     bookingsListDiv.innerHTML = '';
                     noBookingsMessage.classList.remove('hidden');
                }
                
                querySnapshot.docChanges().forEach((change) => {
                    const booking = change.doc.data();
                    const bookingId = change.doc.id;
                    
                    const existingCard = bookingsListDiv.querySelector(`[data-booking-id='${bookingId}']`);

                    if (change.type === "added") {
                         if (!existingCard) {
                            currentBookingsData.set(bookingId, booking);
                            const newCard = createBookingCard(bookingId, booking);
                            // Insérer au début (car trié par desc)
                            bookingsListDiv.prepend(newCard);
                            noBookingsMessage.classList.add('hidden');
                         }

                        // Déclencher la notification SEULEMENT si ce n'est pas le chargement initial
                        // ET si c'est une 'nouvelle' demande
                        if (!isInitialLoad && type === 'new') {
                            console.log("Nouvelle réservation détectée, envoi notification...");
                            showNotification(
                                'Nouvelle Demande de Réservation !',
                                `${booking.nomPrenom} veut louer: ${booking.voiture}`,
                                { bookingId: bookingId }
                            );
                        }
                    }
                    if (change.type === "modified") {
                        currentBookingsData.set(bookingId, booking);
                        if (existingCard) {
                            // Remplacer l'ancienne carte
                            const updatedCard = createBookingCard(bookingId, booking);
                            bookingsListDiv.replaceChild(updatedCard, existingCard);
                        }
                    }
                    if (change.type === "removed") {
                        currentBookingsData.delete(bookingId);
                         if(existingCard) {
                            existingCard.remove();
                         }
                    }
                });
                
                // Mettre à jour l'état après le premier traitement
                 isInitialLoad = false;
                 // Gérer le cas où la liste est vide après les modifications
                 if (bookingsListDiv.children.length === 0) {
                     noBookingsMessage.classList.remove('hidden');
                 }

            }, (error) => {
                console.error("Erreur lors de la récupération des réservations (onSnapshot): ", error);
                loadingSpinner.classList.add('hidden');
                dbErrorMessage.textContent = `Erreur de chargement des réservations. Vérifiez la console (F12). Message: ${error.message}`;
                dbErrorMessage.classList.remove('hidden');
                 if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     dbErrorMessage.innerHTML = `<b>Erreur: Index Firestore manquant.</b><br>Veuillez ouvrir la console (F12) et cliquer sur le lien fourni dans l'erreur rouge pour créer l'index requis par Firestore.`;
                }
            });
        }
        
        // (Cette fonction est maintenant la SEULE déclaration de createBookingCard)
        function createBookingCard(bookingId, booking) {
            const card = document.createElement('div');
            // Ajout de data-booking-id pour le remplacement 'modified'
            card.setAttribute('data-booking-id', bookingId);
            card.className = 'border border-gray-200 rounded-lg p-5 shadow-sm bg-white hover:shadow-md transition-shadow duration-300';
            
            const bookingDate = booking.timestamp ? formatReadableDateTime(booking.timestamp.toDate()) : 'Date inconnue';
            const pickupDateTime = `${booking.datePriseEnCharge} ${booking.heurePriseEnCharge}`;
            const returnDateTime = `${booking.dateRetour} ${booking.heureRetour}`;

            let statusTag = '';
            if (booking.confirmed === false && booking.deleted === false) {
                statusTag = '<span class="text-xs font-semibold text-blue-800 bg-blue-100 px-3 py-1 rounded-full"><i class="fas fa-hourglass-half mr-1.5"></i>Nouvelle Demande</span>';
            } else if (booking.confirmed === true && booking.deleted === false) {
                 statusTag = '<span class="text-xs font-semibold text-green-800 bg-green-100 px-3 py-1 rounded-full"><i class="fas fa-check-circle mr-1.5"></i>Confirmée</span>';
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <span class="text-xs text-gray-500 font-medium">Reçu le : ${bookingDate}</span>
                    ${statusTag}
                </div>
                <div class="mb-4">
                    <p class="text-lg font-bold text-text-dark">${booking.nomPrenom || 'Non spécifié'}</p>
                    <p class="text-sm text-primary font-medium">${booking.telephone || 'Non spécifié'}</p>
                    <p class="text-sm text-gray-600">${booking.email || 'Non spécifié'}</p>
                </div>
                <div class="border-t border-gray-100 pt-4">
                     <p class="text-sm font-semibold text-text-dark mb-1">Voiture : <span class="font-bold text-primary">${booking.voiture || 'Non spécifié'}</span></p>
                     <p class="text-xs text-gray-600">Prise en charge : <span class="font-medium">${pickupDateTime}</span></p>
                     <p class="text-xs text-gray-600">Retour : <span class="font-medium">${returnDateTime}</span></p>
                     <p class="text-xs text-gray-600">Lieux : <span class="font-medium">${booking.lieuPriseEnCharge} / ${booking.lieuRetour}</span></p>
                </div>
                <div class="flex justify-end items-center space-x-3 mt-5">
                    ${booking.confirmed === false ? `
                    <button data-id="${bookingId}" class="confirm-button px-4 py-2 text-xs font-bold text-white bg-green-500 rounded-lg shadow-sm hover:bg-green-600 transition-all transform hover:scale-105">
                        <i class="fas fa-check mr-1.5"></i>Confirmer
                    </button>` : ''}
                    <button data-id="${bookingId}" class="delete-button px-4 py-2 text-xs font-bold text-white bg-red-500 rounded-lg shadow-sm hover:bg-red-600 transition-all transform hover:scale-105">
                        <i class="fas fa-trash-alt mr-1.5"></i>Supprimer
                    </button>
                    <a href="https://wa.me/${booking.telephone ? booking.telephone.replace(/\D/g,'') : ''}" target="_blank" class="contact-button px-4 py-2 text-xs font-bold text-white bg-green-400 rounded-lg shadow-sm hover:bg-green-500 transition-all transform hover:scale-105 ${!booking.telephone ? 'hidden' : ''}">
                        <i class="fab fa-whatsapp mr-1.5"></i>Contacter
                    </a>
                </div>
            `;
            
            // Attacher les écouteurs d'événements
            const confirmBtn = card.querySelector('.confirm-button');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    openConfirmationModal(id);
                });
            }
            
            const deleteBtn = card.querySelector('.delete-button');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    handleDeleteBooking(id);
                });
            }
            
            return card;
        }

    </script>
</body>
</html>

