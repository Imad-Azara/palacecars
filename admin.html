<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Panneau d'Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icônes Font Awesome: CORRECTION de 'xintegrity' en 'integrity' -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3F5f5qK2K6Q24L+nkA5bf5F3Gmf0iVCi/2fA/wz2N9H/Gz9oW9sP7Cg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; } /* Slate-100 */
        :root {
            --color-primary: #2563eb; /* Blue-600 */
            --color-accent: #f59e0b; /* Amber-500 */
            --color-text-dark: #1e293b; /* Slate-800 */
        }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; /* rounded-lg */ font-weight: 600; transition: all 0.3s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; /* Blue-700 */ }
        .btn-danger { background-color: #dc2626; /* Red-600 */ color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; /* Red-700 */ }
        .btn-success { background-color: #16a34a; /* Green-600 */ color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803d; /* Green-700 */ }
        .btn-secondary { background-color: #64748b; /* Slate-500 */ color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; /* Slate-600 */ }
        .btn-warning { background-color: var(--color-accent); color: var(--color-text-dark); }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; /* Amber-600 */ }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-button { padding: 0.75rem 1.5rem; font-weight: 600; color: #475569; /* Slate-600 */ border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--color-primary); border-color: var(--color-primary); }
        .tab-button:hover:not(.active) { color: var(--color-text-dark); }

        /* Styles pour la modale */
        #confirmation-modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 500px;
        }
        /* Animation d'apparition de la modale */
        #confirmation-modal:not(.hidden) { opacity: 1; }
        #confirmation-modal:not(.hidden) .modal-content {
            opacity: 1; transform: translateY(0) scale(1);
        }

        /* Login Form */
        #login-overlay { background-color: rgba(241, 245, 249, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen bg-gray-100">

    <!-- Authentification Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-gray-200">
            <h2 class="text-3xl font-bold mb-6 text-primary">Accès Admin</h2>
            <p class="text-gray-600 mb-6">Veuillez entrer le mot de passe pour accéder au panneau.</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Entrez le mot de passe">
            <button id="login-button" class="btn btn-primary w-full mt-6 py-3 text-lg">
                <i class="fas fa-sign-in-alt mr-2"></i> Connexion
            </button>
            <p id="login-error" class="text-red-500 mt-4 text-sm font-medium hidden">Mot de passe incorrect.</p>
        </div>
    </div>

    <!-- Contenu Principal (Caché par défaut) -->
    <div id="main-content" class="hidden opacity-0 transition-opacity duration-500">

        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo/Titre -->
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-car-on text-primary text-3xl"></i>
                        <h1 class="text-2xl font-bold text-text-dark ml-3">Palace Cars <span class="font-normal text-gray-500">Admin</span></h1>
                    </div>
                    <!-- Notifications -->
                    <div>
                        <button id="enable-notifications" class="btn btn-secondary btn-sm">
                            <i class="fas fa-bell mr-2"></i> Activer les Notifications
                        </button>
                        <span id="notifications-status" class="text-sm text-green-600 font-medium ml-3 hidden">
                            <i class="fas fa-check-circle"></i> Alertes activées.
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenu Page -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">

            <!-- Message Box Global -->
            <div id="admin-message-box" class="hidden p-4 rounded-lg text-center mb-6 font-medium"></div>

            <div class="flex flex-col lg:flex-row lg:space-x-8">

                <!-- Colonne Principale: Réservations -->
                <div class="lg:w-2/3 w-full">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-text-dark mb-5">Boîte de Réception des Réservations</h2>

                        <!-- Tabs -->
                        <div class="border-b border-gray-200 mb-5">
                            <nav class="flex space-x-4">
                                <button id="tab-new" class="tab-button active">
                                    Nouvelles Demandes (<span id="count-new">0</span>)
                                </button>
                                <button id="tab-confirmed" class="tab-button">
                                    Réservations Confirmées (<span id="count-confirmed">0</span>)
                                </button>
                            </nav>
                        </div>

                        <!-- Liste des Réservations -->
                        <div id="bookings-list" class="space-y-5">
                            <!-- Les réservations seront injectées ici -->
                            <p id="loading-bookings" class="text-center text-gray-500 py-10">Chargement des réservations...</p>
                        </div>
                    </div>
                </div>

                <!-- Colonne Latérale: Gestion Disponibilité -->
                <div class="lg:w-1/3 w-full mt-8 lg:mt-0 lg:sticky lg:top-28" style="align-self: flex-start;">
                    <!-- Gérer Disponibilité -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8">
                        <h3 class="text-xl font-bold text-text-dark mb-5">Ajouter Période Indisponible</h3>
                        <form id="unavailability-form" class="space-y-4">
                            <div>
                                <label for="unav-car" class="block text-sm font-semibold text-gray-700 mb-1">Voiture</label>
                                <select id="unav-car" name="car" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="" disabled selected>Choisir...</option>
                                    <!-- Options remplies par JS -->
                                </select>
                            </div>
                            <!-- Date et Heure de Début -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Début Indisponibilité</label>
                                <div class="flex gap-2">
                                    <input type="date" id="unav-start-date" name="startDate" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <input type="time" id="unav-start-time" name="startTime" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                             <!-- Date et Heure de Fin -->
                             <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Fin Indisponibilité</label>
                                <div class="flex gap-2">
                                    <input type="date" id="unav-end-date" name="endDate" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <input type="time" id="unav-end-time" name="endTime" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                            <button type="submit" id="add-period-button" class="btn btn-primary w-full py-2.5">
                                <i class="fas fa-plus-circle mr-2"></i> Ajouter Période
                            </button>
                        </form>
                    </div>

                    <!-- Statut Manuel -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8">
                         <h3 class="text-xl font-bold text-text-dark mb-5">Statut Actuel des Voitures</h3>
                         <div id="manual-status-list" class="space-y-3">
                            <!-- Statuts chargés par JS -->
                         </div>
                    </div>

                      <!-- Périodes Programmées -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-bold text-text-dark mb-5">Périodes Programmées</h3>
                         <div id="periods-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <!-- Périodes chargées par JS -->
                             <p id="loading-periods" class="text-center text-gray-500 py-4">Chargement...</p>
                         </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modale de Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-lg opacity-0 transform scale-95 -translate-y-10 border border-gray-200">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-2xl font-bold text-primary">Confirmer la Réservation</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-700 text-2xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-6">Veuillez vérifier ou modifier les dates/heures si nécessaire avant de confirmer. La confirmation bloquera la voiture pour cette période.</p>
            
            <div id="modal-booking-details" class="text-gray-700 mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <!-- Détails de la réservation chargés ici -->
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <!-- Date et Heure de Début -->
                <div>
                    <label for="modal-start-date" class="block text-sm font-semibold text-gray-700 mb-1">Début Location</label>
                    <input type="date" id="modal-start-date" name="modalStartDate" required class="block w-full mb-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <input type="time" id="modal-start-time" name="modalStartTime" required class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <!-- Date et Heure de Fin -->
                <div>
                    <label for="modal-end-date" class="block text-sm font-semibold text-gray-700 mb-1">Fin Location</label>
                    <input type="date" id="modal-end-date" name="modalEndDate" required class="block w-full mb-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <input type="time" id="modal-end-time" name="modalEndTime" required class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>

            <p id="modal-error" class="text-red-500 mt-4 text-sm font-medium text-center hidden">Erreur : La date de fin doit être après la date de début.</p>

            <div class="mt-8 flex justify-end space-x-3">
                 <button id="cancel-modal-button" class="btn btn-secondary">Annuler</button>
                 <button id="confirm-modal-button" class="btn btn-success">
                     <i class="fas fa-check mr-2"></i> Confirmer la Réservation
                 </button>
            </div>
        </div>
    </div>


    <!-- Imports Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, 
            where, orderBy, doc, getDoc, getDocs, updateDoc, deleteDoc, 
            Timestamp, serverTimestamp, setDoc, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *** C'EST ICI : Votre configuration Firebase ***
        const firebaseConfig = {
          apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
          authDomain: "palace-cars.firebaseapp.com",
          projectId: "palace-cars",
          storageBucket: "palace-cars.firebasestorage.app",
          messagingSenderId: "469852272715",
          appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
          measurementId: "G-KCEF4WBW0G"
        };
        // *** FIN DE LA CONFIGURATION ***

        // *** CORRECTION : DÉPLACEMENT DE TOUTES LES FONCTIONS EN HAUT ***
        // (Pour corriger les erreurs 'ReferenceError: ... is not defined')

        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef;
        let carManualStatusCollectionRef;
        let dbReady = false;
        let allBookingsCache = []; // Cache pour stocker toutes les réservations
        let currentView = 'new'; // 'new' or 'confirmed'
        let currentBookingId = null; // Pour la modale de confirmation
        let currentBookingData = null; // Pour la modale de confirmation

        // ** FIX: Variables pour les éléments DOM importants **
        let listDiv, loadingMsg, countNew, countConfirmed;
        let tabNew, tabConfirmed;
        // ** FIN FIX **

        // Liste statique des voitures
        const carOptions = [
            "Dacia Logan Diesel 2024",
            "Dacia Logan Diesel 2025",
            "Dacia Sandero Essence",
            "Dacia Sandero Diesel"
        ];

        // --- FONCTIONS UTILITAIRES ---

        function formatReadableDateTime(timestamp) {
            // ** FIX: Définir le fuseau horaire du Maroc **
            const timeZone = 'Africa/Casablanca';

            if (!timestamp || !timestamp.seconds) {
                // Essayer de le traiter comme une date-chaîne (ex: 2025-10-24 10:30)
                if(typeof timestamp === 'string') {
                    // Si c'est juste une date (YYYY-MM-DD) et une heure (HH:MM)
                    const parts = timestamp.split(' ');
                    if(parts.length === 2) {
                        const dateParts = parts[0].split('-');
                        const timeParts = parts[1].split(':');
                        if (dateParts.length === 3 && timeParts.length === 2) {
                             // On suppose que la chaîne est en UTC, puis on la formate pour le Maroc
                             const date = new Date(Date.UTC(dateParts[0], dateParts[1]-1, dateParts[2], timeParts[0], timeParts[1]));
                             if(!isNaN(date)) {
                                 return new Intl.DateTimeFormat('fr-FR', {
                                    day: '2-digit', month: '2-digit', year: 'numeric',
                                    hour: '2-digit', minute: '2-digit', hour12: false, 
                                    timeZone: timeZone // Utiliser le fuseau horaire du Maroc
                                }).format(date).replace('à ', '');
                             }
                        }
                    }
                }
                return "Date non spécifiée"; // Retour par défaut
            }
            // Si c'est un objet Timestamp Firebase
            const date = new Date(timestamp.seconds * 1000 + (timestamp.nanoseconds || 0) / 1000000);
            return new Intl.DateTimeFormat('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false, 
                timeZone: timeZone // Utiliser le fuseau horaire du Maroc
            }).format(date).replace('à ', '');
        }


        function getDateTimeObjectFromTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return { date: '', time: '' };
            // Crée un objet Date à partir du timestamp Firebase
            const date = new Date(timestamp.seconds * 1000 + (timestamp.nanoseconds || 0) / 1000000);
            
            // Crée des chaînes ISO distinctes pour la date et l'heure en UTC
            // Les champs de la modale (date/heure) doivent rester en UTC
            // car ils sont lus et écrits comme UTC. Seul l'affichage est changé.
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hour = String(date.getUTCHours()).padStart(2, '0');
            const minute = String(date.getUTCMinutes()).padStart(2, '0');
            
            const dateISO = `${year}-${month}-${day}`;
            const timeISO = `${hour}:${minute}`;
            
            return { date: dateISO, time: timeISO };
        }

        // Fonction utilitaire pour convertir YYYY-MM-DD et HH:MM en objet Date (en UTC)
        function getDateTimeObjectFromISO(dateStr, timeStr) {
             try {
                 if (!dateStr || !timeStr) throw new Error("Date ou heure manquante");
                 // ** FIX: Crée un objet Date basé sur le temps local du navigateur (ex: Maroc) **
                 // new Date("2025-11-06T11:30:00")
                 // Cela crée une date à 11:30 heure locale.
                 const d = new Date(`${dateStr}T${timeStr}:00`); 
                 
                 // L'ancienne méthode (Date.UTC) interprétait 11:30 comme 11:30 UTC, ce qui causait le décalage.
                 // const d = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), 0));
                 
                 if (isNaN(d.getTime())) { throw new Error("Date invalide"); }
                 return d; // Retourne un objet Date local
             } catch (e) {
                 console.error("Erreur conversion ISO date/heure:", dateStr, timeStr, e);
                 return null;
             }
        }

        function showAdminMessage(message, type = 'info', duration = 5000) {
            const msgBox = document.getElementById('admin-message-box');
            if (!msgBox) return;

            msgBox.textContent = message;
            msgBox.className = 'p-4 rounded-lg text-center mb-6 font-medium border text-sm'; // Reset
            msgBox.classList.remove('bg-green-100', 'border-green-300', 'text-green-800', 'bg-red-100', 'border-red-300', 'text-red-800', 'bg-yellow-100', 'border-yellow-300', 'text-yellow-800');

            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            } else if (type === 'warning') {
                msgBox.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
            }
            msgBox.classList.remove('hidden');
            
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, duration);
        }

        function populateCarSelects() {
            const unavCarSelect = document.getElementById('unav-car');
            if (!unavCarSelect) return;
            const placeholder = unavCarSelect.querySelector('option[disabled]');
            unavCarSelect.innerHTML = '';
            if (placeholder) unavCarSelect.appendChild(placeholder);
            carOptions.forEach(car => {
                unavCarSelect.options.add(new Option(car, car));
            });
        }


        // --- FONCTIONS D'AFFICHAGE (Rendering) ---

        function createBookingCard(booking) {
            const card = document.createElement('div');
            card.className = 'border border-gray-200 rounded-xl shadow-sm overflow-hidden';
            card.id = `booking-${booking.id}`;

            // Assurer que le timestamp est valide avant de formater
            // Utilise maintenant formatReadableDateTime qui est réglé sur Africa/Casablanca
            const receivedAt = booking.timestamp ? formatReadableDateTime(booking.timestamp) : 'Date inconnue';
            
            // Créer les chaînes de date/heure pour l'affichage
            // Celles-ci proviennent de la base de données (qui sont en UTC)
            // Nous les affichons telles quelles, mais le "Reçu le" est corrigé.
            // Si pickupTimestamp existe, nous devrions l'utiliser pour un affichage localisé.
            const pickupDateTime = booking.pickupTimestamp ? formatReadableDateTime(booking.pickupTimestamp) : `${booking.datePriseEnCharge || 'jj/mm/aaaa'} ${booking.heurePriseEnCharge || 'hh:mm'}`;
            const returnDateTime = booking.returnTimestamp ? formatReadableDateTime(booking.returnTimestamp) : `${booking.dateRetour || 'jj/mm/aaaa'} ${booking.heureRetour || 'hh:mm'}`;

            const statusClass = booking.confirmed ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
            const statusText = booking.confirmed ? '<i class="fas fa-check-circle mr-1.5"></i> Confirmée' : '<i class="fas fa-hourglass-start mr-1.5"></i> Nouvelle Demande';

            card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-xs text-gray-500 font-medium">Reçu le : ${receivedAt}</span>
                            <span class="ml-3 px-2.5 py-0.5 rounded-full text-xs font-semibold ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-text-dark mb-1">${booking.nomPrenom || 'Nom non spécifié'}</h3>
                    <p class="text-sm text-gray-600 mb-4 break-words">
                        <a href="tel:${booking.telephone}" class="text-primary hover:underline">${booking.telephone || 'Téléphone non spécifié'}</a> | 
                        <a href="mailto:${booking.email}" class="text-primary hover:underline">${booking.email || 'Email non spécifié'}</a>
                    </p>
                    
                    <div class="border-t border-gray-100 pt-4">
                        <h4 class="text-md font-semibold text-text-dark mb-3">Voiture : <span class="font-bold text-lg text-primary">${booking.voiture || 'Non spécifiée'}</span></h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div class="text-gray-700"><i class="fas fa-calendar-alt w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Prise en charge:</strong></div>
                            <div class="font-semibold text-gray-800">${pickupDateTime}</div>
                            <div class="text-gray-700"><i class="fas fa-map-marker-alt w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Lieu:</strong></div>
                            <div class="text-gray-800 break-words">${booking.lieuPriseEnCharge || 'Non spécifié'}</div>
                            
                            <div class="text-gray-700"><i class="fas fa-calendar-check w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Retour:</strong></div>
                            <div class="font-semibold text-gray-800">${returnDateTime}</div>
                            <div class="text-gray-700"><i class="fas fa-map-marker-alt w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Lieu:</strong></div>
                            <div class="text-gray-800 break-words">${booking.lieuRetour || 'Non spécifié'}</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-5 py-4 flex justify-end space-x-3">
                    <button class="btn btn-success btn-sm confirm-button ${booking.confirmed ? 'hidden' : ''}" data-id="${booking.id}">
                        <i class="fas fa-check mr-1.5"></i> Confirmer
                    </button>
                    <button class="btn btn-danger btn-sm delete-button" data-id="${booking.id}">
                        <i class="fas fa-trash-alt mr-1.5"></i> Supprimer
                    </button>
                    <a href="https://wa.me/${(booking.telephone || '').replace(/\D/g, '')}" target="_blank" class="btn btn-secondary btn-sm !bg-green-500 hover:!bg-green-600">
                        <i class="fab fa-whatsapp mr-1.5"></i> Contacter
                    </a>
                </div>
            `;

            // Attacher les écouteurs d'événements
            card.querySelector('.confirm-button')?.addEventListener('click', () => openConfirmationModal(booking.id));
            card.querySelector('.delete-button')?.addEventListener('click', () => handleDeleteBooking(booking.id));

            return card;
        }

        function createPeriodListItem(period) {
            const item = document.createElement('div');
            item.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm flex justify-between items-center';
            item.id = `period-${period.id}`;

            const carName = period.car || "Inconnue";
            // Utilise la fonction mise à jour pour l'heure du Maroc
            const startDate = period.startDate ? formatReadableDateTime(period.startDate) : "N/A";
            const endDate = period.endDate ? formatReadableDateTime(period.endDate) : "N/A";
            const typeText = period.type === 'booking' ? '(Réservé)' : '(Manuel)';

            item.innerHTML = `
                <div>
                    <strong class="text-primary">${carName}</strong> ${typeText}
                    <p class="text-xs text-gray-600">${startDate} - ${endDate}</p>
                </div>
                <button data-id="${period.id}" class="delete-period-button text-red-400 hover:text-red-600 transition-colors p-1">
                    <i class="fas fa-times-circle text-lg"></i>
                </button>
            `;

            item.querySelector('.delete-period-button').addEventListener('click', () => deletePeriod(period.id, `Supprimer cette période d'indisponibilité ?`));
            return item;
        }

        function createManualStatusItem(carName, status) {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 rounded-lg bg-gray-50 border';
            
            const isUnavailable = status === 'unavailable';
            const statusText = isUnavailable ? 'Indisponible' : 'Disponible';
            const statusClass = isUnavailable ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
            const buttonText = isUnavailable ? 'Rendre Disponible' : 'Marquer Indisponible';
            const buttonClass = isUnavailable ? 'btn-success' : 'btn-warning';

            item.innerHTML = `
                <span class="font-medium text-text-dark">${carName}</span>
                <div class="${statusClass} text-sm">${statusText}</div>
                <button data-car="${carName}" data-status="${isUnavailable ? 'available' : 'unavailable'}" class="toggle-status-button btn ${buttonClass} btn-sm py-1">
                    ${buttonText}
                </button>
            `;

            item.querySelector('.toggle-status-button').addEventListener('click', (e) => {
                const car = e.target.dataset.car;
                const newStatus = e.target.dataset.status;
                const confirmMsg = newStatus === 'unavailable' 
                    ? `Marquer ${car} comme INDISPONIBLE manuellement ? (bloquera toutes les réservations)`
                    : `Marquer ${car} comme DISPONIBLE ?`;
                toggleManualStatus(car, newStatus, confirmMsg);
            });
            return item;
        }

        // --- FONCTIONS LOGIQUES (Firestore) ---

        // ** CORRECTION: LOGIQUE DE FILTRAGE DÉPLACÉE EN JAVASCRIPT **
        function displayBookings(view) {
            // ** FIX: Utilisation des variables globales mises en cache **
            // const listDiv = document.getElementById('bookings-list');
            // const loadingMsg = document.getElementById('loading-bookings');
            // const countNew = document.getElementById('count-new');
            // const countConfirmed = document.getElementById('count-confirmed');
            
            if (!listDiv || !loadingMsg || !countNew || !countConfirmed) {
                console.error("Éléments UI manquants pour displayBookings (Vérification échouée)");
                return;
            }

            listDiv.innerHTML = ''; // Nettoyer la liste
            currentView = view;

            // Mettre à jour les styles des onglets
            // ** FIX: Utilisation des variables globales mises en cache **
            tabNew.classList.toggle('active', view === 'new');
            tabConfirmed.classList.toggle('active', view === 'confirmed');

            const isConfirmedView = (view === 'confirmed');
            
            // Filtrer le cache JavaScript
            const bookingsToDisplay = allBookingsCache.filter(booking => {
                // (booking.confirmed === true) pour 'confirmed'
                // (booking.confirmed === false) pour 'new'
                return booking.confirmed === isConfirmedView;
            });

            // Mettre à jour les compteurs
            countNew.textContent = allBookingsCache.filter(b => !b.confirmed).length;
            countConfirmed.textContent = allBookingsCache.filter(b => b.confirmed).length;

            if (bookingsToDisplay.length === 0) {
                loadingMsg.textContent = `Aucune ${view === 'new' ? 'nouvelle demande' : 'réservation confirmée'} pour le moment.`;
                loadingMsg.style.display = 'block';
            } else {
                loadingMsg.style.display = 'none';
                bookingsToDisplay.forEach(booking => {
                    listDiv.appendChild(createBookingCard(booking));
                });
            }
        }

        // ** CORRECTION: REQUÊTE FIRESTORE SIMPLIFIÉE (Évite l'erreur d'index) **
        function loadBookings() {
            // ** FIX: Utilisation de la variable globale 'loadingMsg' **
            // const loadingMsg = document.getElementById('loading-bookings');

            // Requête simplifiée: ne trie que par date.
            // Le filtrage 'deleted' et 'confirmed' se fait en JS (fonction displayBookings).
            // CELA PEUT NÉCESSITER UN INDEX SIMPLE SUR 'timestamp', mais évite l'index composite.
            // **MISE À JOUR :** La requête précédente (`where("deleted", "==", false)`) nécessitait un index.
            // Nous allons essayer SANS le `where` pour tout télécharger et filtrer en JS.
            
            const q = query(
                bookingsCollectionRef, 
                orderBy("timestamp", "desc")
            );

            onSnapshot(q, (snapshot) => {
                if (!loadingMsg) { // Sécurité supplémentaire
                    console.error("loadBookings: loadingMsg est null");
                    return;
                }
                loadingMsg.textContent = 'Chargement des réservations...';
                allBookingsCache = []; // Vider le cache
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // **FILTRAGE JS** : Ignorer les réservations marquées comme supprimées
                    if (data.deleted !== true) {
                        allBookingsCache.push({ ...data, id: doc.id });
                    }
                });
                
                // Afficher la vue actuellement sélectionnée avec les données mises à jour
                displayBookings(currentView); 

            }, (error) => {
                console.error("Erreur lors de la récupération des réservations (onSnapshot): ", error);
                if (loadingMsg) {
                    loadingMsg.textContent = "Erreur: Impossible de charger les réservations. Vérifiez la console (F12).";
                    loadingMsg.style.color = 'red';
                    // Si l'erreur est un index manquant (maintenant juste sur 'timestamp')
                    if (error.code === 'failed-precondition' && error.message.includes('index')) {
                         loadingMsg.innerHTML = `<strong>Erreur:</strong> Index Firestore manquant. <br>Veuillez suivre le lien dans la console (F12) pour le créer (index sur 'timestamp' desc).`;
                    }
                }
            });
        }


        function listenForPeriods() {
            const listDiv = document.getElementById('periods-list');
            const loadingMsg = document.getElementById('loading-periods');

            const q = query(
                unavailabilityPeriodsCollectionRef, 
                orderBy("startDate", "desc")
            );

            onSnapshot(q, (snapshot) => {
                listDiv.innerHTML = ''; // Clear list
                if (snapshot.empty) {
                    loadingMsg.textContent = 'Aucune période programmée.';
                    loadingMsg.style.display = 'block';
                } else {
                    loadingMsg.style.display = 'none';
                    snapshot.forEach((doc) => {
                        listDiv.appendChild(createPeriodListItem({ ...doc.data(), id: doc.id }));
                    });
                }
            }, (error) => {
                console.error("Erreur écoute périodes:", error);
                loadingMsg.textContent = 'Erreur chargement périodes.';
                loadingMsg.style.color = 'red';
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     loadingMsg.innerHTML = `<strong>Erreur:</strong> Index Firestore manquant (périodes). <br>Suivez le lien dans la console (F12) pour le créer.`;
                }
            });
        }

        function listenForManualStatusChanges() {
            const listDiv = document.getElementById('manual-status-list');
            const statusMap = new Map();

            // Initialiser toutes les voitures comme "disponibles"
            carOptions.forEach(carName => statusMap.set(carName, 'available'));

            // Écouter les changements dans la collection 'car_manual_status'
            onSnapshot(carManualStatusCollectionRef, (snapshot) => {
                // Mettre à jour le statut pour les voitures présentes dans la collection
                snapshot.forEach((doc) => {
                    statusMap.set(doc.id, doc.data().status || 'available');
                });

                // Rafraîchir l'affichage
                listDiv.innerHTML = '';
                statusMap.forEach((status, carName) => {
                    listDiv.appendChild(createManualStatusItem(carName, status));
                });

            }, (error) => {
                console.error("Erreur écoute statuts manuels:", error);
                listDiv.innerHTML = '<p class="text-red-500">Erreur chargement statuts.</p>';
            });
        }

        // --- FONCTIONS MODALE ---

        function openConfirmationModal(bookingId) {
            currentBookingId = bookingId;
            currentBookingData = allBookingsCache.find(b => b.id === bookingId);
            if (!currentBookingData) {
                console.error("Impossible de trouver les données pour la réservation:", bookingId);
                showAdminMessage("Erreur: Impossible de charger les détails de cette réservation.", "error");
                return;
            }

            const modal = document.getElementById('confirmation-modal');
            const detailsDiv = document.getElementById('modal-booking-details');
            const startDateInput = document.getElementById('modal-start-date');
            const startTimeInput = document.getElementById('modal-start-time');
            const endDateInput = document.getElementById('modal-end-date');
            const endTimeInput = document.getElementById('modal-end-time');

            // Remplir les détails
            detailsDiv.innerHTML = `
                <p><strong>Client:</strong> ${currentBookingData.nomPrenom}</p>
                <p><strong>Voiture:</strong> ${currentBookingData.voiture}</p>
            `;
            
            // Remplir les dates/heures actuelles
            // Tenter de parser les timestamps s'ils existent, sinon utiliser les strings
            // On utilise getDateTimeObjectFromTimestamp qui formate en UTC pour les champs
            let pickupDate = { date: currentBookingData.datePriseEnCharge, time: currentBookingData.heurePriseEnCharge };
            let returnDate = { date: currentBookingData.dateRetour, time: currentBookingData.heureRetour };

            if (currentBookingData.pickupTimestamp) {
                pickupDate = getDateTimeObjectFromTimestamp(currentBookingData.pickupTimestamp);
            }
            if (currentBookingData.returnTimestamp) {
                returnDate = getDateTimeObjectFromTimestamp(currentBookingData.returnTimestamp);
            }
            
            startDateInput.value = pickupDate.date;
            startTimeInput.value = pickupDate.time;
            endDateInput.value = returnDate.date;
            endTimeInput.value = returnDate.time;

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            setTimeout(() => modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95', '-translate-y-10'), 50);
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const modalError = document.getElementById('modal-error');
            
            modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95', '-translate-y-10');
            setTimeout(() => {
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalError.classList.add('hidden');
                    currentBookingId = null;
                    currentBookingData = null;
                }, 300);
            }, 300);
        }

        // --- ACTIONS ADMIN (Confirmation, Suppression, etc.) ---

        async function handleFinalConfirmation() {
            if (!currentBookingId || !currentBookingData) return;

            const modalError = document.getElementById('modal-error');
            const confirmButton = document.getElementById('confirm-modal-button');
            modalError.classList.add('hidden');
            confirmButton.disabled = true;

            // Récupérer les dates (potentiellement modifiées)
            const newStartDate = document.getElementById('modal-start-date').value;
            const newStartTime = document.getElementById('modal-start-time').value;
            const newEndDate = document.getElementById('modal-end-date').value;
            const newEndTime = document.getElementById('modal-end-time').value;

            // Combiner date et heure (format HH:MM)
            const newPickupDateTime = getDateTimeObjectFromISO(newStartDate, newStartTime);
            const newReturnDateTime = getDateTimeObjectFromISO(newEndDate, newEndTime);

            // Validation
            if (!newPickupDateTime || !newReturnDateTime || newPickupDateTime >= newReturnDateTime) {
                modalError.textContent = "Erreur : La date/heure de fin doit être après la date/heure de début.";
                modalError.classList.remove('hidden');
                confirmButton.disabled = false;
                return;
            }
            
            const batch = writeBatch(db);

            try {
                // 1. Mettre à jour la réservation
                const bookingRef = doc(db, "palace_cars_bookings", currentBookingId);
                batch.update(bookingRef, {
                    confirmed: true,
                    datePriseEnCharge: newStartDate,
                    heurePriseEnCharge: newStartTime,
                    dateRetour: newEndDate,
                    heureRetour: newEndTime,
                    // Mettre à jour les timestamps (très important pour la vérification)
                    pickupTimestamp: Timestamp.fromDate(newPickupDateTime), 
                    returnTimestamp: Timestamp.fromDate(newReturnDateTime)
                });

                // 2. Créer la période d'indisponibilité
                const unavailabilityData = {
                    car: currentBookingData.voiture,
                    startDate: Timestamp.fromDate(newPickupDateTime),
                    endDate: Timestamp.fromDate(newReturnDateTime),
                    type: 'booking', // Marqué comme généré par une réservation
                    bookingId: currentBookingId // Lien vers la réservation
                };
                // Nous créons un nouveau doc dans la collection d'indisponibilité
                // ** FIX: Corrected Firestore reference. Was doc(collection(unavailabilityPeriodsCollectionRef)) **
                const newPeriodRef = doc(unavailabilityPeriodsCollectionRef);
                batch.set(newPeriodRef, unavailabilityData);

                // 3. Exécuter le batch
                await batch.commit();

                showAdminMessage(`Réservation ${currentBookingId.substring(0, 5)}... confirmée et voiture bloquée.`, 'success');
                closeConfirmationModal();
                // L'affichage se mettra à jour via onSnapshot de loadBookings
            } catch (error) {
                console.error("Erreur lors de la confirmation finale:", error);
                modalError.textContent = "Erreur Firestore. Vérifiez la console.";
                modalError.classList.remove('hidden');
            } finally {
                confirmButton.disabled = false;
            }
        }


        async function handleDeleteBooking(bookingId) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer la réservation ID: ${bookingId.substring(0, 5)}... ?\n(Cela libérera aussi le créneau si elle était confirmée.)`)) return;

            try {
                const batch = writeBatch(db);

                // 1. Marquer la réservation comme supprimée (soft delete)
                const bookingRef = doc(db, "palace_cars_bookings", bookingId);
                batch.update(bookingRef, { deleted: true });

                // 2. Trouver et supprimer la période d'indisponibilité associée
                const q = query(unavailabilityPeriodsCollectionRef, where("bookingId", "==", bookingId));
                const periodSnapshot = await getDocs(q);
                
                if (!periodSnapshot.empty) {
                    periodSnapshot.forEach(docSnap => {
                        batch.delete(docSnap.ref);
                    });
                    console.log("Période d'indisponibilité associée supprimée.");
                }

                // 3. Exécuter le batch
                await batch.commit();

                showAdminMessage(`Réservation ${bookingId.substring(0, 5)}... supprimée/archivée.`, 'success');
                // L'affichage se mettra à jour via onSnapshot
            } catch (error) {
                console.error("Erreur lors de la suppression:", error);
                showAdminMessage("Erreur lors de la suppression. Vérifiez la console.", 'error');
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     showAdminMessage("Erreur: Index Firestore manquant pour la suppression. Suivez le lien dans la console (F12) pour le créer (index sur 'bookingId').", 'error', 10000);
                }
            }
        }

        async function toggleManualStatus(carName, newStatus, confirmMsg) {
            if (!confirm(confirmMsg)) return;

            const carStatusRef = doc(db, "car_manual_status", carName);

            try {
                if (newStatus === 'unavailable') {
                    // Marquer comme indisponible
                    await setDoc(carStatusRef, { status: 'unavailable' });
                    showAdminMessage(`${carName} est maintenant marqué INDISPONIBLE.`, 'warning');
                } else {
                    // Marquer comme disponible (en supprimant le document)
                    await deleteDoc(carStatusRef);
                    showAdminMessage(`${carName} est maintenant DISPONIBLE.`, 'success');
                }
                // L'affichage se met à jour via onSnapshot
            } catch (error) {
                 console.error("Erreur mise à jour statut manuel:", error);
                 showAdminMessage("Erreur Firestore. Vérifiez la console.", 'error');
            }
        }

        async function deletePeriod(periodId, confirmMsg) {
            if (!confirm(confirmMsg)) return;
            
            try {
                const periodRef = doc(db, "car_unavailability_periods", periodId);
                await deleteDoc(periodRef);
                showAdminMessage(`Période ${periodId.substring(0,5)}... supprimée.`, 'success');
                // L'affichage se met à jour via onSnapshot
            } catch (error) {
                 console.error("Erreur suppression période:", error);
                 showAdminMessage("Erreur Firestore. Vérifiez la console.", 'error');
            }
        }


        async function addUnavailability(event) {
            event.preventDefault();
            const form = event.target;
            const car = form.car.value;
            const startDate = form.startDate.value;
            const startTime = form.startTime.value;
            const endDate = form.endDate.value;
            const endTime = form.endTime.value;
            const button = form.querySelector('button');
            
            if (!car || !startDate || !startTime || !endDate || !endTime) {
                showAdminMessage("Veuillez remplir tous les champs de période.", 'warning');
                return;
            }

            const pickupDateTime = getDateTimeObjectFromISO(startDate, startTime);
            const returnDateTime = getDateTimeObjectFromISO(endDate, endTime);

            if (!pickupDateTime || !returnDateTime || pickupDateTime >= returnDateTime) {
                showAdminMessage("Date/heure de fin doit être après la date/heure de début.", 'warning');
                return;
            }
            
            button.disabled = true;

            try {
                 const unavailabilityData = {
                     car: car,
                     startDate: Timestamp.fromDate(pickupDateTime),
                     endDate: Timestamp.fromDate(returnDateTime),
                     type: 'manual', // Marqué comme manuel
                     bookingId: null // Pas de lien de réservation
                 };
                
                await addDoc(unavailabilityPeriodsCollectionRef, unavailabilityData);
                showAdminMessage(`Période d'indisponibilité ajoutée pour ${car}.`, 'success');
                form.reset();

            } catch (error) {
                console.error("Erreur ajout période:", error);
                showAdminMessage("Erreur Firestore. Vérifiez la console.", 'error');
            } finally {
                button.disabled = false;
            }
        }

        function toggleView(view) {
            displayBookings(view); // Appelle la nouvelle fonction de filtrage JS
        }


        // --- INITIALISATION (Login, PWA, etc.) ---

        document.addEventListener('DOMContentLoaded', () => {
            // ** FIX: Assignation des variables DOM globales **
            listDiv = document.getElementById('bookings-list');
            loadingMsg = document.getElementById('loading-bookings');
            countNew = document.getElementById('count-new');
            countConfirmed = document.getElementById('count-confirmed');
            tabNew = document.getElementById('tab-new');
            tabConfirmed = document.getElementById('tab-confirmed');
            
            const loginOverlay = document.getElementById('login-overlay');
            const loginButton = document.getElementById('login-button');
            const passwordInput = document.getElementById('password-input');
            const loginError = document.getElementById('login-error');
            const mainContent = document.getElementById('main-content');

            // ** FIX: Vérification initiale des éléments DOM **
            if (!listDiv || !loadingMsg || !countNew || !countConfirmed || !tabNew || !tabConfirmed || !loginError || !loginButton || !passwordInput || !mainContent) {
                console.error("ERREUR CRITIQUE: Éléments DOM non trouvés au chargement.");
                // Afficher une erreur à l'utilisateur si possible
                if(loginError) {
                    loginError.textContent = "Erreur de chargement de l'application (DOM).";
                    loginError.classList.remove('hidden');
                }
                // Empêcher le reste du script de s'exécuter
                return; 
            }

            // Liste des voitures
            populateCarSelects();

            // Gestion Login
            function handleLogin() {
                if (passwordInput.value === "12234") {
                    loginOverlay.classList.add('opacity-0', 'pointer-events-none');
                    mainContent.classList.remove('hidden');
                    setTimeout(() => mainContent.classList.remove('opacity-0'), 50); // Fade in
                    setTimeout(() => loginOverlay.style.display = 'none', 500); // Hide completely

                    // Démarrer les écouteurs Firestore SEULEMENT APRES le login
                    if (dbReady) {
                        try {
                            loadBookings();
                            listenForPeriods();
                            listenForManualStatusChanges();
                        } catch (e) {
                            console.error("Erreur au démarrage des écouteurs Firestore:", e);
                            showAdminMessage("Erreur de connexion à Firestore. Vérifiez la console.", "error");
                        }
                    } else {
                        console.error("DB non prête au moment du login.");
                        showAdminMessage("La connexion à la base de données a échoué.", "error");
                    }

                } else {
                    loginError.classList.remove('hidden');
                    passwordInput.classList.add('border-red-500', 'ring-red-500');
                    passwordInput.focus();
                }
            }
            
            loginButton.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keyup', (e) => {
                loginError.classList.add('hidden');
                passwordInput.classList.remove('border-red-500', 'ring-red-500');
                if (e.key === 'Enter') handleLogin();
            });

            // Écouteurs Modale
            document.getElementById('close-modal-button').addEventListener('click', closeConfirmationModal);
            document.getElementById('cancel-modal-button').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirm-modal-button').addEventListener('click', handleFinalConfirmation);

            // Écouteurs Formulaire Indisponibilité
            document.getElementById('unavailability-form').addEventListener('submit', addUnavailability);

            // Écouteurs Onglets
            // ** FIX: Utilisation des variables globales mises en cache **
            tabNew.addEventListener('click', () => toggleView('new'));
            tabConfirmed.addEventListener('click', () => toggleView('confirmed'));

            // Initialisation PWA (Service Worker & Notifications)
            const notifButton = document.getElementById('enable-notifications');
            const notifStatus = document.getElementById('notifications-status');
            
            // 1. Enregistrement Service Worker
            if ('serviceWorker' in navigator) {
                 // ** CORRECTION: Vérifier le protocole **
                 if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                     window.addEventListener('load', () => {
                         navigator.serviceWorker.register('/sw.js')
                             .then(registration => {
                                 console.log('Service Worker enregistré avec succès:', registration.scope);
                             })
                             .catch(error => {
                                 console.error('Échec de l\'enregistrement du Service Worker:', error);
                             });
                     });
                 } else {
                     console.warn("Le Service Worker ne peut pas être enregistré sur ce protocole:", window.location.protocol);
                 }
            }

            // 2. Demande de Permission Notification
            function requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            notifStatus.classList.remove('hidden');
                            notifButton.classList.add('hidden');
                            console.log('Permission de notification accordée.');
                            // Envoyer une notification de test
                            if (navigator.serviceWorker.controller) {
                                navigator.serviceWorker.controller.postMessage({
                                    type: 'show-notification',
                                    title: 'Palace Cars Admin',
                                    options: {
                                        body: 'Les notifications sont activées !',
                                        icon: '/icons/icon-192x192.png',
                                        badge: '/icons/icon-192x192.png',
                                        vibrate: [200, 100, 200]
                                    }
                                });
                            }
                        } else {
                            console.warn('Permission de notification refusée.');
                            showAdminMessage('Les notifications ont été bloquées.', 'warning');
                        }
                    });
                } else {
                    console.error('Ce navigateur ne supporte pas les notifications.');
                    showAdminMessage('Ce navigateur ne supporte pas les notifications.', 'error');
                }
            }

            notifButton.addEventListener('click', requestNotificationPermission);
            // Vérifier si la permission est déjà accordée
            if (window.Notification && Notification.permission === 'granted') {
                notifStatus.classList.remove('hidden');
                notifButton.classList.add('hidden');
            }


            // --- Connexion Firebase ---
            (async () => {
                try {
                    // Cette ligne va maintenant fonctionner car firebaseConfig est défini juste au-dessus
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    bookingsCollectionRef = collection(db, "palace_cars_bookings");
                    unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
                    carManualStatusCollectionRef = collection(db, "car_manual_status");
                    dbReady = true;
                    console.log("Firebase initialisé avec succès (DOMContentLoaded).");
                } catch (error) {
                    console.error("Erreur critique d'initialisation Firebase:", error);
                    loginButton.disabled = true;
                    loginButton.textContent = "Erreur DB";
                    loginError.textContent = "Impossible de connecter à Firebase. Vérifiez la console.";
                    loginError.classList.remove('hidden');
                }
            })();

        }); // Fin DOMContentLoaded
    </script>
</body>
</html>
