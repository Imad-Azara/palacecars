<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Panneau d'Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Icônes Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3F5f5qK2K6Q24L+nkA5bf5F3Gmf0iVCi/2fA/wz2N9H/Gz9oW9sP7Cg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .booking-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); margin-bottom: 1rem; padding: 1rem; }
        .confirmed-booking { opacity: 0.6; }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .tab-button:not(.active) { background-color: #e5e7eb; color: #374151; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-left: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        .sticky-top { position: sticky; top: 1rem; }
        /* Style pour la modale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        /* Specific input styles for modal */
        .modal-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Section Authentification -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Accès Administrateur</h1>
            <input type="password" id="password-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Entrez le mot de passe">
            <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                Connexion
            </button>
            <p id="error-message" class="text-red-500 text-sm mt-2 text-center hidden">Mot de passe incorrect.</p>
        </div>
    </div>

    <!-- Panneau Principal -->
    <div id="admin-panel" class="hidden container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Accès Administrateur Palace Cars</h1>

        <!-- Section Notifications -->
        <div class="text-center mb-8">
             <button id="enable-notifications-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 mr-2 disabled:opacity-50 disabled:cursor-not-allowed">
                Activer les Notifications
            </button>
             <span id="notification-status" class="text-gray-600 text-sm"></span>
        </div>

        <!-- Layout Deux Colonnes -->
        <div class="flex flex-col md:flex-row md:space-x-8">

            <!-- Colonne Gauche: Boîte de Réception -->
            <div class="w-full md:w-2/3 mb-8 md:mb-0">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">Boîte de Réception des Réservations</h2>
                    <p class="text-center text-gray-600 mb-6">Mise à jour automatique.</p>
                    <div id="loading-message" class="text-center text-blue-600 py-4">Chargement des réservations...</div>
                    <div id="error-loading-message" class="hidden p-4 rounded-md text-center bg-red-100 text-red-700 mb-4"></div>
                    <div class="flex justify-center space-x-4 mb-6">
                        <button id="tab-new" class="tab-button active">Nouvelles Demandes</button>
                        <button id="tab-confirmed" class="tab-button">Réservations Confirmées</button>
                    </div>
                    <div id="bookings-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Colonne Droite: Gérer Disponibilité (Sticky) -->
            <div class="w-full md:w-1/3">
                 <div class="bg-white p-6 rounded-lg shadow-xl sticky-top space-y-6">
                     <h2 class="text-xl font-semibold text-center text-gray-700">Gérer la Disponibilité</h2>

                     <!-- Section Ajout Période Indisponible -->
                     <div>
                         <h3 class="text-md font-semibold text-gray-700 mb-3 border-b pb-2">Ajouter Période Indisponible</h3>
                         <div class="space-y-3">
                             <div>
                                <label for="period-car" class="block text-sm font-medium text-gray-700 mb-1">Voiture</label>
                                <select id="period-car" name="period-car" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white text-sm">
                                    <option value="" disabled selected>Choisir...</option>
                                </select>
                            </div>
                             <div class="grid grid-cols-2 gap-2">
                                 <div>
                                    <label for="period-start-date" class="block text-sm font-medium text-gray-700 mb-1">Date Début</label>
                                    <input type="date" id="period-start-date" name="period-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                 </div>
                                 <div>
                                    <label for="period-start-time" class="block text-sm font-medium text-gray-700 mb-1">Heure Début</label>
                                    <input type="time" id="period-start-time" name="period-start-time" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                 </div>
                             </div>
                              <div class="grid grid-cols-2 gap-2">
                                 <div>
                                    <label for="period-end-date" class="block text-sm font-medium text-gray-700 mb-1">Date Fin</label>
                                    <input type="date" id="period-end-date" name="period-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                 </div>
                                  <div>
                                    <label for="period-end-time" class="block text-sm font-medium text-gray-700 mb-1">Heure Fin</label>
                                    <input type="time" id="period-end-time" name="period-end-time" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                 </div>
                             </div>
                             <div class="text-center pt-2">
                                 <button id="add-period-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 disabled:opacity-50 text-sm">
                                     Ajouter Période
                                     <span id="period-spinner" class="loader hidden"></span>
                                 </button>
                            </div>
                         </div>
                         <div id="period-message" class="hidden p-3 rounded-md text-center mt-3 text-sm"></div>
                     </div>

                     <!-- Section Statut Actuel des Voitures -->
                     <div>
                         <h3 class="text-md font-semibold text-gray-700 mb-3 border-b pb-2">Statut Actuel des Voitures</h3>
                         <div id="manual-status-list" class="space-y-2 max-h-40 overflow-y-auto">
                             <p id="manual-status-loading" class="text-gray-500 italic text-sm">Chargement...</p>
                             <!-- Statut des voitures chargé ici -->
                         </div>
                     </div>

                     <!-- Section Périodes Programmées -->
                     <div>
                         <h3 class="text-md font-semibold text-gray-700 mb-3 border-b pb-2">Périodes Programmées</h3>
                         <div id="periods-list" class="space-y-2 max-h-40 overflow-y-auto">
                             <p id="periods-loading" class="text-gray-500 italic text-sm">Chargement...</p>
                             <!-- Liste des périodes chargée ici -->
                         </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modale de Confirmation -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Confirmer la Réservation</h3>
            <p class="text-sm text-gray-600 mb-4">Veuillez vérifier ou modifier les dates et heures avant de confirmer.</p>

            <input type="hidden" id="modal-booking-id">
            <input type="hidden" id="modal-car-name">

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-start-date" class="block text-sm font-medium text-gray-700">Date Prise en Charge</label>
                        <input type="date" id="modal-start-date" class="modal-input mt-1">
                    </div>
                    <div>
                        <label for="modal-start-time" class="block text-sm font-medium text-gray-700">Heure Prise en Charge</label>
                        <input type="time" id="modal-start-time" class="modal-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-end-date" class="block text-sm font-medium text-gray-700">Date Retour</label>
                        <input type="date" id="modal-end-date" class="modal-input mt-1">
                    </div>
                    <div>
                        <label for="modal-end-time" class="block text-sm font-medium text-gray-700">Heure Retour</label>
                        <input type="time" id="modal-end-time" class="modal-input mt-1">
                    </div>
                </div>
            </div>

            <div id="modal-error-message" class="text-red-500 text-sm mt-4 text-center hidden"></div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="modal-cancel-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md transition duration-300 text-sm">
                    Annuler
                </button>
                <button type="button" id="modal-confirm-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-300 text-sm flex items-center disabled:opacity-50">
                    <span>Confirmer la Réservation</span>
                    <span id="modal-confirm-spinner" class="loader !border-t-white !border-l-white !w-4 !h-4 hidden ml-2"></span>
                </button>
            </div>
        </div>
    </div>


    <!-- Script Firebase & Logique Admin -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, updateDoc, deleteDoc, Timestamp, serverTimestamp, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Firebase ---
        const firebaseConfig = { /* Votre config ici */
            apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
            authDomain: "palace-cars.firebaseapp.com",
            projectId: "palace-cars",
            storageBucket: "palace-cars.firebasestorage.app",
            messagingSenderId: "469852272715",
            appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
            measurementId: "G-KCEF4WBW0G"
         };

        // --- Initialize Firebase ---
        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef;
        let carManualStatusCollectionRef;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            bookingsCollectionRef = collection(db, "palace_cars_bookings");
            unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
            carManualStatusCollectionRef = collection(db, "car_manual_status");
            console.log("Firebase initialisé.");
        } catch (error) {
            console.error("Erreur Firebase:", error); /* Gérer l'erreur */
            document.getElementById('loading-message').textContent = "Erreur critique d'initialisation.";
            document.getElementById('error-loading-message').textContent = "Erreur Firebase. Vérifiez la console F12.";
            document.getElementById('error-loading-message').classList.remove('hidden');
        }

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const adminPanel = document.getElementById('admin-panel');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const bookingsList = document.getElementById('bookings-list');
        const loadingMessage = document.getElementById('loading-message');
        const errorLoadingMessage = document.getElementById('error-loading-message');
        const enableNotificationsButton = document.getElementById('enable-notifications-button');
        const notificationStatus = document.getElementById('notification-status');
        const tabNew = document.getElementById('tab-new');
        const tabConfirmed = document.getElementById('tab-confirmed');
        const periodCarSelect = document.getElementById('period-car');
        const periodStartDateInput = document.getElementById('period-start-date');
        const periodStartTimeInput = document.getElementById('period-start-time');
        const periodEndDateInput = document.getElementById('period-end-date');
        const periodEndTimeInput = document.getElementById('period-end-time');
        const addPeriodButton = document.getElementById('add-period-button');
        const periodSpinner = document.getElementById('period-spinner');
        const periodMessage = document.getElementById('period-message');
        const manualStatusListDiv = document.getElementById('manual-status-list');
        const manualStatusLoading = document.getElementById('manual-status-loading');
        const periodsListDiv = document.getElementById('periods-list');
        const periodsLoading = document.getElementById('periods-loading');

        // Éléments de la Modale
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalBookingIdInput = document.getElementById('modal-booking-id');
        const modalCarNameInput = document.getElementById('modal-car-name');
        const modalStartDateInput = document.getElementById('modal-start-date');
        const modalStartTimeInput = document.getElementById('modal-start-time');
        const modalEndDateInput = document.getElementById('modal-end-date');
        const modalEndTimeInput = document.getElementById('modal-end-time');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalConfirmSpinner = document.getElementById('modal-confirm-spinner');

        const CORRECT_PASSWORD = "12234";
        let unsubscribeBookings = null;
        let unsubscribePeriods = null;
        let unsubscribeManualStatus = null;
        let currentFilterConfirmed = false;
        let notificationPermission = Notification.permission;

        // --- Liste des voitures ---
        const carOptions = [ /* Même liste que index.html */
            "Dacia Logan Diesel 2024", "Dacia Logan Diesel 2025", "Dacia Sandero Essence", "Dacia Sandero Diesel"
        ];

        // --- Authentification ---
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

        function handleLogin() {
            if (passwordInput.value === CORRECT_PASSWORD) {
                authSection.style.display = 'none';
                adminPanel.style.display = 'block';
                errorMessage.classList.add('hidden');
                checkNotificationPermission();
                populateCarSelects();
                loadBookings();
                listenForManualStatusChanges();
                listenForUnavailabilityPeriods();
            } else {
                errorMessage.classList.remove('hidden');
            }
        }

        // --- Gestion des Onglets (Réservations) ---
        tabNew.addEventListener('click', () => switchTab(false));
        tabConfirmed.addEventListener('click', () => switchTab(true));
        function switchTab(showConfirmed) {
             if (currentFilterConfirmed !== showConfirmed) {
                currentFilterConfirmed = showConfirmed;
                tabNew.classList.toggle('active', !showConfirmed);
                tabConfirmed.classList.toggle('active', showConfirmed);
                loadBookings();
            }
        }

        // --- Chargement des Réservations ---
        let currentBookingsData = new Map(); // Stocker les données pour la modale

        function loadBookings() {
            if (!db) return;
            loadingMessage.textContent = 'Chargement...';
            loadingMessage.classList.remove('hidden');
            errorLoadingMessage.classList.add('hidden');
            bookingsList.innerHTML = '';
            if (unsubscribeBookings) unsubscribeBookings();
            currentBookingsData.clear(); // Vider le cache des données

            const q = query(
                bookingsCollectionRef,
                where("confirmed", "==", currentFilterConfirmed),
                where("deleted", "==", false),
                orderBy("timestamp", "desc")
            );

            unsubscribeBookings = onSnapshot(q, (querySnapshot) => {
                loadingMessage.classList.add('hidden');
                bookingsList.innerHTML = '';
                if (querySnapshot.empty) {
                     bookingsList.innerHTML = `<p class="text-center text-gray-500 italic">Aucune ${currentFilterConfirmed ? 'réservation confirmée' : 'nouvelle demande'}.</p>`;
                } else {
                    const bookings = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     bookings.forEach(booking => {
                         currentBookingsData.set(booking.id, booking); // Stocker les données
                         bookingsList.appendChild(createBookingCard(booking));
                         if (!booking.confirmed && !booking.deleted && !currentFilterConfirmed && booking.timestamp && !querySnapshot.metadata.hasPendingWrites) { // Eviter notif sur propre modif
                           // showNotification('Nouvelle Réservation!', `Client: ${booking.nomPrenom || 'Inconnu'}\nVoiture: ${booking.voiture || 'N/A'}`);
                         }
                     });
                }
            }, (error) => {
                console.error("Erreur chargement réservations:", error);
                loadingMessage.classList.add('hidden');
                errorLoadingMessage.classList.remove('hidden');
                let specificError = error.message;
                if (error.code === 'failed-precondition') specificError = "Index Firestore manquant. Vérifiez la console (F12).";
                else if (error.code === 'permission-denied') specificError = "Permission refusée. Vérifiez vos règles Firestore.";
                errorLoadingMessage.textContent = `Erreur chargement réservations: ${specificError}`;
            });
        }

        // --- Création Carte Réservation & Actions (Confirm ouvre modale) ---
         function createBookingCard(booking) {
             const card = document.createElement('div');
            card.className = `booking-card border-l-4 ${booking.confirmed ? 'border-green-500' : 'border-blue-500'} ${booking.confirmed ? 'confirmed-booking' : ''}`;
            card.dataset.id = booking.id;
             const receivedDate = booking.timestamp?.toDate ? booking.timestamp.toDate().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short'}) : 'Date inconnue';
            const statusText = booking.confirmed ? 'Confirmée' : 'Nouvelle Demande';
            const statusIcon = booking.confirmed ? 'fa-solid fa-check-circle text-green-500' : 'fa-regular fa-clock text-blue-500';

            // Fonction helper pour formater date/heure
            const formatDate = (dateStr, timeStr) => {
                if (!dateStr || !timeStr) return 'N/A';
                try {
                    const d = new Date(`${dateStr}T${timeStr}`);
                    return !isNaN(d) ? d.toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'Date invalide';
                } catch { return 'Date invalide'; }
            };

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <p class="text-xs text-gray-500">Reçu le : ${receivedDate}</p>
                    <span class="text-xs font-semibold py-1 px-2 rounded-full ${booking.confirmed ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}"><i class="${statusIcon} mr-1"></i>${statusText}</span>
                </div>
                <p class="mb-1"><strong class="font-semibold text-gray-700">Nom:</strong> ${booking.nomPrenom || 'N/A'}</p>
                <p class="mb-1"><strong class="font-semibold text-gray-700">Téléphone:</strong> ${booking.telephone ? `<a href="tel:${booking.telephone}" class="text-blue-600 hover:underline">${booking.telephone}</a>` : 'N/A'}</p>
                <p class="mb-1"><strong class="font-semibold text-gray-700">Email:</strong> ${booking.email ? `<a href="mailto:${booking.email}" class="text-blue-600 hover:underline">${booking.email}</a>` : 'N/A'}</p>
                <p class="mb-3"><strong class="font-semibold text-gray-700">Voiture:</strong> ${booking.voiture || 'N/A'}</p>
                <div class="text-sm text-gray-600 space-y-1">
                    <p><strong class="font-semibold">Prise en charge:</strong> ${booking.lieuPriseEnCharge || 'N/A'} - ${formatDate(booking.datePriseEnCharge, booking.heurePriseEnCharge)}</p>
                    <p><strong class="font-semibold">Retour:</strong> ${booking.lieuRetour || 'N/A'} - ${formatDate(booking.dateRetour, booking.heureRetour)}</p>
                </div>
                <div class="flex flex-wrap justify-end gap-2 mt-4">
                    ${!booking.confirmed ? `<button data-action="open-confirm-modal" data-id="${booking.id}" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition duration-300 flex items-center"><i class="fas fa-check mr-1"></i>Confirmer</button>` : ''}
                    <button data-action="delete" data-id="${booking.id}" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm transition duration-300 flex items-center"><i class="fas fa-trash-alt mr-1"></i>Supprimer</button>
                    ${booking.telephone ? `<a href="https://wa.me/${formatPhoneNumberForWhatsApp(booking.telephone)}" target="_blank" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded-md text-sm transition duration-300 flex items-center"><i class="fab fa-whatsapp mr-1"></i> Contacter</a>` : ''}
                </div>`;
            // Le bouton "Confirmer" ouvre la modale
            card.querySelector('button[data-action="open-confirm-modal"]')?.addEventListener('click', () => openConfirmationModal(booking.id));
            card.querySelector('button[data-action="delete"]')?.addEventListener('click', handleDeleteBooking);
            return card;
         }

        // Action de suppression directe (inchangée)
        async function handleDeleteBooking(event) {
            const button = event.currentTarget;
            const bookingId = button.dataset.id;
            if (!bookingId || !db) return;
            if (!confirm('Êtes-vous sûr de vouloir marquer cette demande comme supprimée ?')) return;
            button.disabled = true;
            button.innerHTML = '<span class="loader !border-t-white !border-l-white !w-4 !h-4 !inline-block mr-1"></span> Suppr.';
            try {
                await updateDoc(doc(db, "palace_cars_bookings", bookingId), { deleted: true });
                // Note: On pourrait aussi supprimer la période d'indisponibilité associée si elle existe
            } catch (error) { console.error("Erreur suppression:", error); showModalMessage("Erreur suppression."); button.disabled = false; button.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>Supprimer'; }
         }

         function formatPhoneNumberForWhatsApp(phone) {
             if (!phone) return '';
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('2120')) cleaned = '212' + cleaned.substring(4);
            else if (cleaned.startsWith('0') && cleaned.length === 10) cleaned = '212' + cleaned.substring(1);
            if (!cleaned.startsWith('212') && cleaned.length === 9 && (cleaned.startsWith('6') || cleaned.startsWith('7'))) cleaned = '212' + cleaned;
            if (!cleaned.startsWith('212') && cleaned.length > 10) return cleaned;
            return cleaned.startsWith('212') ? cleaned : '';
         }

        // --- Logique de la Modale de Confirmation ---
        function openConfirmationModal(bookingId) {
            const booking = currentBookingsData.get(bookingId);
            if (!booking) {
                console.error("Données de réservation non trouvées pour ID:", bookingId);
                showModalMessage("Erreur : Impossible de charger les détails de la réservation.");
                return;
            }

            modalBookingIdInput.value = booking.id;
            modalCarNameInput.value = booking.voiture || ''; // Stocker le nom de la voiture
            modalStartDateInput.value = booking.datePriseEnCharge || '';
            modalStartTimeInput.value = booking.heurePriseEnCharge || '';
            modalEndDateInput.value = booking.dateRetour || '';
            modalEndTimeInput.value = booking.heureRetour || '';
            modalErrorMessage.classList.add('hidden');
            modalConfirmButton.disabled = false;
            modalConfirmSpinner.classList.add('hidden');
            confirmationModal.classList.remove('hidden');
        }

        function closeConfirmationModal() {
            confirmationModal.classList.add('hidden');
        }

        modalCancelButton.addEventListener('click', closeConfirmationModal);
        modalConfirmButton.addEventListener('click', handleFinalConfirmation);

        async function handleFinalConfirmation() {
            const bookingId = modalBookingIdInput.value;
            const carName = modalCarNameInput.value;
            const startDate = modalStartDateInput.value;
            const startTime = modalStartTimeInput.value || "00:00";
            const endDate = modalEndDateInput.value;
            const endTime = modalEndTimeInput.value || "23:59";

            modalErrorMessage.classList.add('hidden'); // Cacher ancien message

            if (!bookingId || !carName || !startDate || !startTime || !endDate || !endTime) {
                modalErrorMessage.textContent = "Tous les champs date/heure sont requis.";
                modalErrorMessage.classList.remove('hidden');
                return;
            }

            const startDateTime = new Date(`${startDate}T${startTime}:00`);
            const endDateTime = new Date(`${endDate}T${endTime}:00`);

            if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
                modalErrorMessage.textContent = "Dates ou heures invalides.";
                modalErrorMessage.classList.remove('hidden');
                return;
            }
            if (startDateTime >= endDateTime) {
                modalErrorMessage.textContent = "La date/heure de retour doit être après la prise en charge.";
                modalErrorMessage.classList.remove('hidden');
                return;
            }

            modalConfirmButton.disabled = true;
            modalConfirmSpinner.classList.remove('hidden');

            try {
                // 1. Mettre à jour la réservation
                await updateDoc(doc(db, "palace_cars_bookings", bookingId), {
                    confirmed: true,
                    datePriseEnCharge: startDate, // Sauvegarder les dates modifiées
                    heurePriseEnCharge: startTime,
                    dateRetour: endDate,
                    heureRetour: endTime
                });
                console.log("Réservation confirmée:", bookingId);

                // 2. Ajouter la période d'indisponibilité correspondante
                await addDoc(unavailabilityPeriodsCollectionRef, {
                    car: carName,
                    startDate: Timestamp.fromDate(startDateTime),
                    endDate: Timestamp.fromDate(endDateTime),
                    type: 'booking', // Marquer comme venant d'une réservation confirmée
                    bookingId: bookingId, // Lier à la réservation
                    addedAt: serverTimestamp()
                 });
                console.log("Période d'indisponibilité ajoutée pour", bookingId);

                closeConfirmationModal();
                showAvailabilityMessage("Réservation confirmée et voiture marquée indisponible.", false); // Message global

            } catch (error) {
                console.error("Erreur lors de la confirmation finale:", error);
                modalErrorMessage.textContent = "Erreur lors de la confirmation. Réessayez.";
                modalErrorMessage.classList.remove('hidden');
                modalConfirmButton.disabled = false;
                modalConfirmSpinner.classList.add('hidden');
            }
        }

         // Fonction helper pour afficher messages hors modale (utilisée pour statut et confirmation finale)
         function showAvailabilityMessage(message, isError = false) {
             // Utilise le même élément que pour les périodes manuelles
             periodMessage.textContent = message;
             periodMessage.className = `p-3 rounded-md text-center mt-3 text-sm ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
             periodMessage.classList.remove('hidden');
             setTimeout(() => periodMessage.classList.add('hidden'), 5000);
         }


        // --- Logique de Disponibilité (inchangée) ---
        // (Ajout période, écoute périodes, écoute statut manuel, création items liste)
        // ... (tout le code de gestion de disponibilité précédent reste ici) ...
        function populateCarSelects() { /* ... */ }
        function showPeriodMessage(message, isError = false) { /* ... */ }
        addPeriodButton.addEventListener('click', async () => { /* ... */ });
        function listenForUnavailabilityPeriods() { /* ... */ }
        function createPeriodListItem(period) { /* ... */ }
        function listenForManualStatusChanges() { /* ... */ }
        function createManualStatusItem(carName, currentStatus) { /* ... */ }

        // --- Notification Logic (inchangée) ---
        function checkNotificationPermission() { /* ... */ }
        function updateNotificationButtonState(permission) { /* ... */ }
        enableNotificationsButton.addEventListener('click', () => { /* ... */ });
        function showNotification(title, body) { /* ... */ }

        // --- PWA Service Worker Registration (inchangée) ---
        if ('serviceWorker' in navigator) { /* ... */ }

        // --- Simple Modal (remplacé par alert) ---
        function showModalMessage(message) { alert(message); } // Utiliser alert pour les erreurs modales simples

    </script>
</body>
</html>

