<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Panneau d'Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Icônes Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3fSLbcaL8S/V5fR07H/aLSWcaOXYjM4QdMW7Xb43p2Cwv0A5/5V9iwQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .booking-card {
            transition: all 0.3s ease-in-out;
        }
        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .status-new { background-color: #e0f2fe; color: #0c4a6e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        /* Style pour le bouton de notification */
        #notification-button.enabled { background-color: #10b981; } /* Vert si activé */
        #notification-button.disabled { background-color: #f87171; } /* Rouge si refusé */
        #notification-button.pending { background-color: #f59e0b; } /* Orange pendant la demande */
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Accès Administrateur Palace Cars</h1>

        <!-- Section de Connexion -->
        <div id="login-section" class="bg-white p-6 md:p-8 rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="text-xl font-semibold mb-4 text-center">Connexion Administrateur</h2>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mot de Passe</label>
                <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Entrez le mot de passe">
            </div>
            <p id="error-message" class="text-red-500 text-sm mb-4 hidden">Mot de passe incorrect.</p>
            <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 action-button">
                Connexion
            </button>
        </div>

        <!-- Section Boîte de Réception (cachée initialement) -->
        <div id="admin-panel" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Boîte de Réception des Réservations</h2>

            <!-- Bouton pour gérer les notifications -->
            <div class="text-center mb-6">
                <button id="notification-button" class="px-4 py-2 rounded-md text-white text-sm font-medium action-button">
                    <i class="fas fa-bell mr-1"></i> Activer les Notifications
                </button>
                <p id="notification-status" class="text-xs text-gray-500 mt-1"></p>
            </div>


            <p class="text-center text-gray-600 mb-6">Liste des demandes de réservation en temps réel. Cette page se met à jour automatiquement.</p>

            <div id="error-display" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <strong class="font-bold">Erreur de connexion à la base de données.</strong>
                <span class="block sm:inline">Vérifiez votre configuration et les règles de sécurité.</span>
            </div>

            <div id="loading-spinner" class="text-center py-10 hidden">
                 <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
                 <p class="mt-2 text-gray-600">Chargement des réservations...</p>
            </div>

            <!-- Conteneur pour les cartes de réservation -->
            <div id="bookings-container" class="space-y-4">
                <!-- Les cartes de réservation seront injectées ici par JavaScript -->
            </div>
             <p id="no-bookings" class="text-center text-gray-500 py-10 hidden">Aucune nouvelle demande de réservation pour le moment.</p>
        </div>
    </div>

    <!-- Script Firebase & Notifications -->
    <script type="module">
        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Votre configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
            authDomain: "palace-cars.firebaseapp.com",
            projectId: "palace-cars",
            storageBucket: "palace-cars.firebasestorage.app",
            messagingSenderId: "469852272715",
            appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
            measurementId: "G-KCEF4WBW0G"
        };

        // --- Variables Globales ---
        let app;
        let db;
        let bookingsCollection;
        let unsubscribe = null;
        let notifiedBookingIds = new Set(); // Pour suivre les notifs déjà envoyées dans cette session

        // --- Éléments UI ---
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const errorDisplay = document.getElementById('error-display');
        const bookingsContainer = document.getElementById('bookings-container');
        const noBookingsMessage = document.getElementById('no-bookings');
        const loadingSpinner = document.getElementById('loading-spinner');
        const notificationButton = document.getElementById('notification-button');
        const notificationStatus = document.getElementById('notification-status');
        const correctPassword = "12234";

        // --- Initialisation Firebase ---
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                bookingsCollection = collection(db, "palace_cars_bookings");
                console.log("Firebase initialisé avec succès.");
                // setLogLevel('debug'); // Décommenter pour logs détaillés
                return true;
            } catch (error) {
                console.error("Erreur d'initialisation Firebase:", error);
                displayError("Erreur d'initialisation de Firebase. Impossible de se connecter.");
                return false;
            }
        }

        // --- Gestion des Notifications ---
        function updateNotificationButton() {
            if (!("Notification" in window)) {
                notificationButton.textContent = "Notifications non supportées";
                notificationButton.disabled = true;
                notificationButton.classList.add("bg-gray-400", "cursor-not-allowed");
                notificationStatus.textContent = "Votre navigateur ne supporte pas les notifications.";
                return;
            }

            switch (Notification.permission) {
                case 'granted':
                    notificationButton.textContent = "Notifications Activées";
                    notificationButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-red-500', 'bg-yellow-500');
                    notificationButton.classList.add('bg-green-500', 'cursor-default');
                    notificationButton.disabled = true; // Déjà activé
                    notificationStatus.textContent = "Vous recevrez des alertes pour les nouvelles réservations.";
                    break;
                case 'denied':
                    notificationButton.textContent = "Notifications Bloquées";
                    notificationButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-500', 'bg-yellow-500');
                    notificationButton.classList.add('bg-red-500', 'cursor-not-allowed');
                    notificationButton.disabled = true;
                    notificationStatus.textContent = "Vous avez bloqué les notifications. Réactivez-les dans les paramètres du navigateur.";
                    break;
                default: // 'default' ou inconnu
                    notificationButton.textContent = "Activer les Notifications";
                    notificationButton.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
                    notificationButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    notificationButton.disabled = false;
                    notificationStatus.textContent = "Cliquez pour autoriser les notifications.";
                    break;
            }
        }

        notificationButton.addEventListener('click', async () => {
            if (!("Notification" in window)) return;

            if (Notification.permission === 'default') {
                notificationButton.textContent = "Demande en cours...";
                notificationButton.classList.add('bg-yellow-500');
                notificationButton.disabled = true;
                try {
                    const permission = await Notification.requestPermission();
                    console.log('Permission demandée:', permission);
                } catch (error) {
                    console.error("Erreur lors de la demande de permission:", error);
                    notificationStatus.textContent = "Erreur lors de la demande d'autorisation.";
                } finally {
                     updateNotificationButton(); // Met à jour l'état du bouton après la réponse
                }
            }
        });

        function showNotification(title, body) {
            if (!("Notification" in window)) {
                console.log("Ce navigateur ne supporte pas les notifications.");
                return;
            }

            if (Notification.permission === "granted") {
                 // Optionnel : Ajouter une icône
                // const iconUrl = 'url/to/your/icon.png';
                const notification = new Notification(title, {
                    body: body,
                    // icon: iconUrl // Décommentez si vous avez une icône
                });

                // Optionnel : Rendre la notification cliquable pour ouvrir la page admin
                notification.onclick = function(event) {
                    event.preventDefault(); // Empêche le navigateur de focaliser une éventuelle ancienne fenêtre
                    window.open(window.location.href, '_blank'); // Ouvre un nouvel onglet vers la page admin
                }

            } else if (Notification.permission !== "denied") {
                // Si la permission n'est ni accordée ni refusée, redemander.
                // Note : Certains navigateurs bloquent les demandes répétées.
                console.log("Permission non accordée, demande...");
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showNotification(title, body); // Réessayer si la permission est accordée
                    } else {
                         console.log("Permission refusée après nouvelle demande.");
                    }
                });
            } else {
                 console.log("Permission de notification refusée par l'utilisateur.");
            }
        }


        // --- Gestion de la Connexion Admin ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value === correctPassword) {
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                if (initializeFirebase()) {
                    updateNotificationButton(); // Mettre à jour l'état initial du bouton de notification
                    loadBookings();
                }
            } else {
                errorMessage.classList.remove('hidden');
            }
        });

        passwordInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                loginButton.click();
            }
        });

        // --- Affichage des Erreurs ---
        function displayError(message) {
            if (errorDisplay) {
                errorDisplay.textContent = message;
                errorDisplay.classList.remove('hidden');
            }
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        // --- Chargement et Affichage des Réservations ---
        function loadBookings() {
            if (!db || !bookingsCollection) {
                displayError("La base de données n'est pas prête.");
                return;
            }

            loadingSpinner.classList.remove('hidden');
            noBookingsMessage.classList.add('hidden');

            const q = query(bookingsCollection, orderBy("timestamp", "desc"));

            if (unsubscribe) unsubscribe(); // Nettoyer l'ancien listener

            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                bookingsContainer.innerHTML = '';
                let hasVisibleBookings = false;
                let newBookingsFound = false; // Pour savoir si on doit notifier

                snapshot.docChanges().forEach((change) => {
                     // Vérifier seulement les ajouts récents
                    if (change.type === "added") {
                        const booking = change.doc.data();
                        const bookingId = change.doc.id;
                        // Si c'est une nouvelle réservation (non confirmée/supprimée) ET qu'on ne l'a pas déjà notifiée
                        if (!booking.confirmed && !booking.deleted && !notifiedBookingIds.has(bookingId)) {
                             newBookingsFound = true;
                             notifiedBookingIds.add(bookingId); // Marquer comme notifiée pour cette session
                             console.log("Nouvelle réservation détectée:", bookingId);
                             showNotification(
                                 'Nouvelle Réservation Palace Cars!',
                                 `Client: ${booking.nomPrenom || 'Inconnu'} - Voiture: ${booking.voiture || 'Non spécifiée'}`
                             );
                        }
                    }
                });

                // Mettre à jour l'affichage complet
                snapshot.forEach((doc) => {
                    const booking = doc.data();
                    const bookingId = doc.id;
                    if (!booking.confirmed && !booking.deleted) {
                        hasVisibleBookings = true;
                        const card = createBookingCard(booking, bookingId);
                        bookingsContainer.appendChild(card); // Ajoute au début pour les plus récentes en haut
                    }
                });


                if (!hasVisibleBookings) {
                    noBookingsMessage.classList.remove('hidden');
                } else {
                    noBookingsMessage.classList.add('hidden');
                }

            }, (error) => {
                console.error("Erreur lors de la récupération des réservations: ", error);
                displayError("Impossible de charger les réservations.");
                loadingSpinner.classList.add('hidden');
            });
        }


        // --- Création d'une Carte de Réservation ---
        function createBookingCard(booking, id) {
             const card = document.createElement('div');
             card.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200 booking-card flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0';
             card.dataset.id = id;

             let timestampStr = "Date inconnue";
             if (booking.timestamp && booking.timestamp.toDate) {
                 try {
                     timestampStr = booking.timestamp.toDate().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                 } catch (e) { console.warn("Timestamp invalide:", booking.timestamp); }
             } else if (booking.timestamp) {
                  try {
                      timestampStr = new Date(booking.timestamp).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                  } catch(e) { console.warn("Timestamp non standard:", booking.timestamp); }
             }

             const infoDiv = document.createElement('div');
             infoDiv.className = 'space-y-2 text-sm';
             infoDiv.innerHTML = `
                 <p><strong class="font-semibold text-gray-700">Reçu le :</strong> ${timestampStr}</p>
                 <p><strong class="font-semibold text-gray-700">Nom:</strong> ${booking.nomPrenom || 'Non spécifié'}</p>
                 <p><strong class="font-semibold text-gray-700">Téléphone:</strong> <a href="https://wa.me/${formatPhoneNumber(booking.telephone)}" target="_blank" class="text-blue-600 hover:underline">${booking.telephone || 'Non spécifié'}</a></p>
                 <p><strong class="font-semibold text-gray-700">Email:</strong> <a href="mailto:${booking.email}" class="text-blue-600 hover:underline">${booking.email || 'Non spécifié'}</a></p>
                 <p><strong class="font-semibold text-gray-700">Voiture:</strong> ${booking.voiture || 'Non spécifiée'}</p>
                 <p><strong class="font-semibold text-gray-700">Prise en charge:</strong> ${booking.lieuPriseEnCharge} - ${booking.datePriseEnCharge} à ${booking.heurePriseEnCharge}</p>
                 <p><strong class="font-semibold text-gray-700">Retour:</strong> ${booking.lieuRetour} - ${booking.dateRetour} à ${booking.heureRetour}</p>
                 <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full status-new mt-2">
                     <i class="fas fa-hourglass-start mr-1"></i> Nouvelle Demande
                 </span>
             `;

             const actionsDiv = document.createElement('div');
             actionsDiv.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full md:w-auto mt-4 md:mt-0';

             const confirmButton = document.createElement('button');
             confirmButton.innerHTML = '<i class="fas fa-check mr-1"></i> Confirmer';
             confirmButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md text-xs action-button flex items-center justify-center';
             confirmButton.onclick = () => confirmBooking(id);

             const deleteButton = document.createElement('button');
             deleteButton.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Supprimer';
             deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md text-xs action-button flex items-center justify-center';
             deleteButton.onclick = () => deleteBooking(id);

             actionsDiv.appendChild(confirmButton);
             actionsDiv.appendChild(deleteButton);

             card.appendChild(infoDiv);
             card.appendChild(actionsDiv);

             return card;
        }

        // --- Actions sur les Réservations ---
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '212' + cleaned.substring(1);
            } else if (!cleaned.startsWith('212')) {
                 cleaned = '212' + cleaned;
            }
            return cleaned;
        }

        async function confirmBooking(bookingId) {
            if (!db) return;
            const bookingRef = doc(db, "palace_cars_bookings", bookingId);
            try {
                await updateDoc(bookingRef, { confirmed: true });
                console.log(`Réservation ${bookingId} marquée comme confirmée.`);
            } catch (error) {
                console.error("Erreur confirmation: ", error);
                // Utiliser une méthode plus discrète pour l'erreur si alert() n'est pas souhaité
                 displayError(`Erreur lors de la confirmation de ${bookingId}.`);
            }
        }

        async function deleteBooking(bookingId) {
             if (!db) return;
             if (!window.confirm("Êtes-vous sûr de vouloir supprimer cette demande ?")) return; // window.confirm est souvent bloqué en iframe, remplacer si besoin
             const bookingRef = doc(db, "palace_cars_bookings", bookingId);
             try {
                // Utilisation de updateDoc pour un "soft delete"
                await updateDoc(bookingRef, { deleted: true });
                // Ou pour une suppression définitive: await deleteDoc(bookingRef);
                console.log(`Réservation ${bookingId} marquée comme supprimée.`);
             } catch (error) {
                 console.error("Erreur suppression: ", error);
                  // Utiliser une méthode plus discrète pour l'erreur si alert() n'est pas souhaité
                 displayError(`Erreur lors de la suppression de ${bookingId}.`);
             }
        }

    </script>

</body>
</html>

