<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palace Cars - Panneau d'Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ic√¥nes Font Awesome: CORRECTION de xintegrity en integrity -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3F5f5qK2K6Q24L+nkA5bf5F3Gmf0iVCi/2fA/wz2N9H/Gz9oW9sP7Cg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; } /* Slate-100 */
        :root {
            --color-primary: #2563eb; /* Blue-600 */
            --color-accent: #f59e0b; /* Amber-500 */
            --color-text-dark: #1e293b; /* Slate-800 */
        }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; /* rounded-lg */ font-weight: 600; transition: all 0.3s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; /* Blue-700 */ }
        .btn-danger { background-color: #dc2626; /* Red-600 */ color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; /* Red-700 */ }
        .btn-success { background-color: #16a34a; /* Green-600 */ color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803d; /* Green-700 */ }
        .btn-secondary { background-color: #64748b; /* Slate-500 */ color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; /* Slate-600 */ }
        .btn-warning { background-color: var(--color-accent); color: var(--color-text-dark); }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; /* Amber-600 */ }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-button { padding: 0.75rem 1.5rem; font-weight: 600; color: #475569; /* Slate-600 */ border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--color-primary); border-color: var(--color-primary); }
        .tab-button:hover:not(.active) { color: var(--color-text-dark); }

        /* Styles pour la modale */
        #confirmation-modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 500px;
        }
        /* Animation d'apparition de la modale */
        #confirmation-modal:not(.hidden) { opacity: 1; }
        #confirmation-modal:not(.hidden) .modal-content {
            opacity: 1; transform: translateY(0) scale(1);
        }

        /* Login Form */
        #login-overlay { background-color: rgba(241, 245, 249, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen bg-gray-100">

    <!-- Authentification Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-gray-200">
            <h2 class="text-3xl font-bold text-primary">Acc√®s Admin</h2>
            <p class="text-gray-600 mb-6">Veuillez entrer le mot de passe pour acc√©der au panneau.</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Entrez le mot de passe">
            <button id="login-button" class="btn btn-primary w-full mt-6 py-3 text-lg">
                <i class="fas fa-sign-in-alt mr-2"></i> Connexion
            </button>
            <p id="login-error" class="text-red-500 mt-4 text-sm font-medium hidden">Mot de passe incorrect.</p>
        </div>
    </div>

    <!-- Contenu Principal (Cach√© par d√©faut) -->
    <div id="main-content" class="hidden opacity-0 transition-opacity duration-500">

        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo/Titre -->
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-car-on text-primary text-3xl"></i>
                        <h1 class="text-2xl font-bold text-text-dark ml-3">Palace Cars <span class="font-normal text-gray-500">Admin</span></h1>
                    </div>
                    <!-- Notifications -->
                    <div>
                        <button id="enable-notifications" class="btn btn-secondary btn-sm">
                            <i class="fas fa-bell mr-2"></i> Activer les Notifications
                        </button>
                        <span id="notifications-status" class="text-sm text-green-600 font-medium ml-3 hidden">
                            <i class="fas fa-check-circle"></i> Alertes activ√©es.
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenu Page -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">

            <!-- Message Box Global -->
            <div id="admin-message-box" class="hidden p-4 rounded-lg text-center mb-6 font-medium"></div>

            <div class="flex flex-col lg:flex-row lg:space-x-8">

                <!-- Colonne Principale: R√©servations -->
                <div class="lg:w-2/3 w-full">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-text-dark mb-5">Bo√Æte de R√©ception des R√©servations</h2>

                        <!-- Tabs -->
                        <div class="border-b border-gray-200 mb-5">
                            <nav class="flex space-x-4">
                                <button id="tab-new" class="tab-button active">
                                    Nouvelles Demandes (<span id="count-new">0</span>)
                                </button>
                                <button id="tab-confirmed" class="tab-button">
                                    R√©servations Confirm√©es (<span id="count-confirmed">0</span>)
                                </button>
                            </nav>
                        </div>

                        <!-- Liste des R√©servations -->
                        <div id="bookings-list" class="space-y-5">
                            <!-- Les r√©servations seront inject√©es ici -->
                            <p id="loading-bookings" class="text-center text-gray-500 py-10">Chargement des r√©servations...</p>
                        </div>
                    </div>
                </div>

                <!-- Colonne Lat√©rale: Gestion Disponibilit√© -->
                <div class="lg:w-1/3 w-full mt-8 lg:mt-0 lg:sticky lg:top-28" style="align-self: flex-start;">
                    <!-- G√©rer Disponibilit√© -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8">
                        <h3 class="text-xl font-bold text-text-dark mb-5">Ajouter P√©riode Indisponible</h3>
                        <form id="unavailability-form" class="space-y-4">
                            <div>
                                <label for="unav-car" class="block text-sm font-semibold text-gray-700 mb-1">Voiture</label>
                                <select id="unav-car" name="car" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="" disabled selected>Choisir...</option>
                                    <!-- Options remplies par JS -->
                                </select>
                            </div>
                            <!-- Date et Heure de D√©but -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">D√©but Indisponibilit√©</label>
                                <div class="flex gap-2">
                                    <input type="date" id="unav-start-date" name="startDate" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <input type="time" id="unav-start-time" name="startTime" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                             <!-- Date et Heure de Fin -->
                             <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Fin Indisponibilit√©</label>
                                <div class="flex gap-2">
                                    <input type="date" id="unav-end-date" name="endDate" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <input type="time" id="unav-end-time" name="endTime" required class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                            <button type="submit" id="add-period-button" class="btn btn-primary w-full py-2.5">
                                <i class="fas fa-plus-circle mr-2"></i> Ajouter P√©riode
                            </button>
                        </form>
                    </div>

                    <!-- Statut Manuel -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8">
                          <h3 class="text-xl font-bold text-text-dark mb-5">Statut Actuel des Voitures</h3>
                          <div id="manual-status-list" class="space-y-3">
                               <!-- Statuts charg√©s par JS -->
                          </div>
                    </div>

                    <!-- P√©riodes Programm√©es -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8">
                          <h3 class="text-xl font-bold text-text-dark mb-5">P√©riodes Programm√©es</h3>
                          <div id="periods-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                               <!-- P√©riodes charg√©es par JS -->
                               <p id="loading-periods" class="text-center text-gray-500 py-4">Chargement...</p>
                          </div>
                    </div>

                    <!-- NOUVELLE SECTION: Clients Fid√®les -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-text-dark mb-5">Historique des Clients</h3>
                        <div class="flex justify-between items-center mb-3 border-b pb-2 text-sm font-semibold text-gray-500">
                            <span>Client</span>
                            <span>R√©servations</span>
                        </div>
                        <div id="client-history-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <p id="loading-client-history" class="text-center text-gray-500 py-4">Chargement...</p>
                            <!-- Les clients fid√®les seront inject√©s ici -->
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modale de Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-lg opacity-0 transform scale-95 -translate-y-10 border border-gray-200">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-2xl font-bold text-primary">Confirmer la R√©servation</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-700 text-2xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-6">Veuillez v√©rifier ou modifier les dates/heures si n√©cessaire avant de confirmer. La confirmation bloquera la voiture pour cette p√©riode.</p>
            
            <div id="modal-booking-details" class="text-gray-700 mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <!-- D√©tails de la r√©servation charg√©s ici -->
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <!-- Date et Heure de D√©but -->
                <div>
                    <label for="modal-start-date" class="block text-sm font-semibold text-gray-700 mb-1">D√©but Location</label>
                    <input type="date" id="modal-start-date" name="modalStartDate" required class="block w-full mb-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <input type="time" id="modal-start-time" name="modalStartTime" required class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <!-- Date et Heure de Fin -->
                <div>
                    <label for="modal-end-date" class="block text-sm font-semibold text-gray-700 mb-1">Fin Location</label>
                    <input type="date" id="modal-end-date" name="modalEndDate" required class="block w-full mb-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <input type="time" id="modal-end-time" name="modalEndTime" required class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>

            <p id="modal-error" class="text-red-500 mt-4 text-sm font-medium text-center hidden">Erreur : La date de fin doit √™tre apr√®s la date de d√©but.</p>

            <div class="mt-8 flex justify-end space-x-3">
                 <button id="cancel-modal-button" class="btn btn-secondary">Annuler</button>
                 <button id="confirm-modal-button" class="btn btn-success" disabled>
                     <i class="fas fa-check mr-2"></i> Confirmer la R√©servation
                 </button>
            </div>
        </div>
    </div>


    <!-- Imports Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, 
            where, orderBy, doc, getDoc, getDocs, updateDoc, deleteDoc, 
            Timestamp, serverTimestamp, setDoc, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // CORRECTION: Pour √©viter l'utilisation de window.confirm/alert
        function customConfirm(message) {
            return window.prompt(message + " (Tapez 'OUI' pour confirmer)") === 'OUI';
        }
        
        // *** Configuration Firebase ***
        // (L'utilisateur doit coller sa configuration ici)
        const firebaseConfig = {
          apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
          authDomain: "palace-cars.firebaseapp.com",
          projectId: "palace-cars",
          storageBucket: "palace-cars.firebasestorage.app",
          messagingSenderId: "469852272715",
          appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
          measurementId: "G-KCEF4WBW0G"
        };
        // *** Fin Configuration Firebase ***


        // --- Variables Globales ---
        let db;
        let bookingsCollectionRef;
        let unavailabilityPeriodsCollectionRef;
        let carManualStatusCollectionRef;
        let dbReady = false;
        let allBookingsCache = []; // Cache pour stocker toutes les r√©servations
        let currentView = 'new'; // 'new' or 'confirmed'
        let currentBookingId = null; // Pour la modale de confirmation
        let currentBookingData = null; // Pour la modale de confirmation
        let isConfirmationBusy = false; // Verrou pour √©viter double-clic

        // Liste statique des voitures
        const carOptions = [
            "Dacia Logan Diesel 2024",
            "Dacia Logan Diesel 2025",
            "Dacia Sandero Essence",
            "Dacia Sandero Diesel"
        ];
        
        // --- NOUVEAU: Map des √©l√©ments DOM ---
        // (Pour √©viter les erreurs "√âl√©ments UI manquants")
        const domElements = {};

        // --- FONCTIONS UTILITAIRES ---

        function formatReadableDateTime(timestamp) {
            if (!timestamp || !timestamp.seconds) {
                // Essayer de le traiter comme une date-cha√Æne (ex: 2025-10-24 10:30)
                if(typeof timestamp === 'string') {
                    // Si c'est juste une date (YYYY-MM-DD) et une heure (HH:MM)
                    const parts = timestamp.split(' ');
                    if(parts.length === 2) {
                        const dateParts = parts[0].split('-');
                        const timeParts = parts[1].split(':');
                        if (dateParts.length === 3 && timeParts.length >= 2) {
                             // Utiliser le fuseau horaire du Maroc (WET = UTC+0/UTC+1, utilisons 'Africa/Casablanca' pour √™tre s√ªr)
                             // Note: Ceci est pour l'affichage. L'entr√©e est suppos√©e √™tre locale.
                            try {
                                const date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1])-1, parseInt(dateParts[2]), parseInt(timeParts[0]), parseInt(timeParts[1]));
                                if(!isNaN(date)) {
                                    return new Intl.DateTimeFormat('fr-FR', {
                                        day: '2-digit', month: '2-digit', year: 'numeric',
                                        hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Africa/Casablanca'
                                    }).format(date).replace('√† ', '');
                                }
                            } catch (e) { console.error("Erreur formatage date string:", e); }
                        }
                    }
                }
                return "Date non sp√©cifi√©e"; // Retour par d√©faut
            }
            // Si c'est un objet Timestamp Firebase
            const date = new Date(timestamp.seconds * 1000 + (timestamp.nanoseconds || 0) / 1000000);
            return new Intl.DateTimeFormat('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Africa/Casablanca' // Utiliser UTC+1
            }).format(date).replace('√† ', '');
        }

        // Convertit un Timestamp Firebase en { date: 'YYYY-MM-DD', time: 'HH:MM' } (pour les inputs de la modale)
        // ** NOUVELLE LOGIQUE: Utilise le fuseau horaire 'Africa/Casablanca' pour l'affichage **
        function getDateTimeObjectFromTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return { date: '', time: '12:00' }; // D√©faut 12:00 si non trouv√©
            try {
                const date = new Date(timestamp.seconds * 1000 + (timestamp.nanoseconds || 0) / 1000000);
                
                // Formater la date en utilisant IANA 'Africa/Casablanca'
                const optionsDate = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Africa/Casablanca' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Africa/Casablanca' };

                const dateParts = new Intl.DateTimeFormat('fr-FR', optionsDate).format(date).split('/');
                // G√©rer le formatage fr-FR (DD/MM/YYYY)
                if (dateParts.length === 3) {
                    const dateISO = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // Re-construire en YYYY-MM-DD
                    
                    const timeStr = new Intl.DateTimeFormat('fr-FR', optionsTime).format(date);
                    
                    // G√©rer le cas '24:00' qui peut arriver
                    const timeISO = timeStr.replace('24:', '00:');
                    
                    if (dateISO !== 'Invalid Date' && timeISO) {
                        return { date: dateISO, time: timeISO };
                    }
                }
                throw new Error("Format de date Intl inattendu");

            } catch (e) {
                console.error("Erreur conversion timestamp en ISO local:", e, timestamp);
                // Fallback (peut √™tre d√©cal√© si le serveur n'est pas au Maroc)
                const d = new Date(timestamp.seconds * 1000);
                d.setMinutes(d.getMinutes() + d.getTimezoneOffset()); // Tenter de compenser l'UTC
                
                // Si le timestamp est valide, on essaie un fallback
                if (!isNaN(d.getTime())) {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const hour = String(d.getHours()).padStart(2, '0');
                    const minute = String(d.getMinutes()).padStart(2, '0');
                    return { date: `${year}-${month}-${day}`, time: `${hour}:${minute}` };
                }
                return { date: '', time: '12:00' }; // Fallback final
            }
        }


        // Fonction utilitaire pour convertir YYYY-MM-DD et HH:MM (depuis le formulaire) en objet Date (en UTC)
        // ** CORRECTION FUSEAU HORAIRE **
        function getDateTimeObjectFromISO(dateStr, timeStr) {
             try {
                 if (!dateStr || !timeStr) throw new Error("Date ou heure manquante");
                 const [year, month, day] = dateStr.split('-');
                 const [hour, minute] = timeStr.split(':');
                 // Interpr√®te la date comme √©tant locale au Maroc (Africa/Casablanca)
                 // Puis cr√©e un objet Date.
                 // Note: C'est complexe. Le plus simple est de cr√©er un objet Date en local (navigateur)
                 // Le Timestamp.fromDate() le convertira en UTC.
                 const d = new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), 0);
                 
                 if (isNaN(d.getTime())) { throw new Error("Date invalide"); }
                 return d;
             } catch (e) {
                 console.error("Erreur conversion ISO date/heure:", dateStr, timeStr, e);
                 return null;
             }
        }

        function showAdminMessage(message, type = 'info', duration = 5000) {
            const msgBox = domElements.adminMessageBox;
            if (!msgBox) return;

            msgBox.textContent = message;
            msgBox.className = 'p-4 rounded-lg text-center mb-6 font-medium border text-sm'; // Reset
            msgBox.classList.remove('bg-green-100', 'border-green-300', 'text-green-800', 'bg-red-100', 'border-red-300', 'text-red-800', 'bg-yellow-100', 'border-yellow-300', 'text-yellow-800');

            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            } else if (type === 'warning') {
                msgBox.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
            }
            msgBox.classList.remove('hidden');
            
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, duration);
        }

        function populateCarSelects() {
            const unavCarSelect = domElements.unavCar;
            if (!unavCarSelect) return;
            const placeholder = unavCarSelect.querySelector('option[disabled]');
            unavCarSelect.innerHTML = '';
            if (placeholder) unavCarSelect.appendChild(placeholder);
            carOptions.forEach(car => {
                unavCarSelect.options.add(new Option(car, car));
            });
        }


        // --- FONCTIONS D'AFFICHAGE (Rendering) ---

        function createBookingCard(booking) {
            const card = document.createElement('div');
            card.className = 'border border-gray-200 rounded-xl shadow-sm overflow-hidden';
            card.id = `booking-${booking.id}`;

            // Assurer que le timestamp est valide avant de formater
            const receivedAt = booking.timestamp ? formatReadableDateTime(booking.timestamp) : 'Date inconnue';
            
            // Cr√©er les cha√Ænes de date/heure pour l'affichage (depuis les champs string ou timestamps)
            let pickupDateTime = `${booking.datePriseEnCharge || 'jj/mm/aaaa'} ${booking.heurePriseEnCharge || 'hh:mm'}`;
            let returnDateTime = `${booking.dateRetour || 'jj/mm/aaaa'} ${booking.heureRetour || 'hh:mm'}`;
            
            // Si les timestamps existent (pr√©f√©r√© car plus pr√©cis), les utiliser
            if (booking.pickupTimestamp) {
                pickupDateTime = formatReadableDateTime(booking.pickupTimestamp);
            }
            if (booking.returnTimestamp) {
                returnDateTime = formatReadableDateTime(booking.returnTimestamp);
            }

            const statusClass = booking.confirmed ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
            const statusText = booking.confirmed ? '<i class="fas fa-check-circle mr-1.5"></i> Confirm√©e' : '<i class="fas fa-hourglass-start mr-1.5"></i> Nouvelle Demande';

            card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-xs text-gray-500 font-medium">Re√ßu le : ${receivedAt}</span>
                            <span class="ml-3 px-2.5 py-0.5 rounded-full text-xs font-semibold ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-text-dark mb-1">${booking.nomPrenom || 'Nom non sp√©cifi√©'}</h3>
                    <p class="text-sm text-gray-600 mb-4 break-words">
                        <a href="tel:${booking.telephone}" class="text-primary hover:underline">${booking.telephone || 'T√©l√©phone non sp√©cifi√©'}</a> | 
                        <a href="mailto:${booking.email}" class="text-primary hover:underline">${booking.email || 'Email non sp√©cifi√©'}</a>
                    </p>
                    
                    <div class="border-t border-gray-100 pt-4">
                        <h4 class="text-md font-semibold text-text-dark mb-3">Voiture : <span class="font-bold text-lg text-primary">${booking.voiture || 'Non sp√©cifi√©e'}</span></h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div class="text-gray-700"><i class="fas fa-calendar-alt w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Prise en charge:</strong></div>
                            <div class="font-semibold text-gray-800">${pickupDateTime}</div>
                            <div class="text-gray-700"><i class="fas fa-map-marker-alt w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Lieu:</strong></div>
                            <div class="text-gray-800 break-words">${booking.lieuPriseEnCharge || 'Non sp√©cifi√©'}</div>
                            
                            <div class="text-gray-700"><i class="fas fa-calendar-check w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Retour:</strong></div>
                            <div class="font-semibold text-gray-800">${returnDateTime}</div>
                            <div class="text-gray-700"><i class="fas fa-map-marker-alt w-5 text-gray-400 mr-1"></i> <strong class="font-medium">Lieu:</strong></div>
                            <div class="text-gray-800 break-words">${booking.lieuRetour || 'Non sp√©cifi√©'}</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-5 py-4 flex justify-end space-x-3">
                    <button class="btn btn-success btn-sm confirm-button ${booking.confirmed ? 'hidden' : ''}" data-id="${booking.id}">
                        <i class="fas fa-check mr-1.5"></i> Confirmer
                    </button>
                    <button class="btn btn-danger btn-sm delete-button" data-id="${booking.id}">
                        <i class="fas fa-trash-alt mr-1.5"></i> Supprimer
                    </button>
                    <a href="https://wa.me/${(booking.telephone || '').replace(/\D/g, '')}" target="_blank" class="btn btn-secondary btn-sm !bg-green-500 hover:!bg-green-600">
                        <i class="fab fa-whatsapp mr-1.5"></i> Contacter
                    </a>
                </div>
            `;

            // Attacher les √©couteurs d'√©v√©nements
            card.querySelector('.confirm-button')?.addEventListener('click', () => openConfirmationModal(booking.id));
            card.querySelector('.delete-button')?.addEventListener('click', () => handleDeleteBooking(booking.id));

            return card;
        }

        function createPeriodListItem(period) {
            const item = document.createElement('div');
            item.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm flex justify-between items-center';
            item.id = `period-${period.id}`;

            const carName = period.car || "Inconnue";
            const startDate = period.startDate ? formatReadableDateTime(period.startDate) : "N/A";
            const endDate = period.endDate ? formatReadableDateTime(period.endDate) : "N/A";
            const typeText = period.type === 'booking' ? '(R√©serv√©)' : '(Manuel)';

            item.innerHTML = `
                <div>
                    <strong class="text-primary">${carName}</strong> ${typeText}
                    <p class="text-xs text-gray-600">${startDate} - ${endDate}</p>
                </div>
                <button data-id="${period.id}" class="delete-period-button text-red-400 hover:text-red-600 transition-colors p-1">
                    <i class="fas fa-times-circle text-lg"></i>
                </button>
            `;

            // Utiliser customConfirm
            item.querySelector('.delete-period-button').addEventListener('click', () => {
                if (customConfirm(`√ätes-vous s√ªr de vouloir supprimer cette p√©riode d'indisponibilit√© ?`)) {
                    deletePeriod(period.id);
                }
            });
            return item;
        }

        function createManualStatusItem(carName, status) {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 rounded-lg bg-gray-50 border';
            
            const isUnavailable = status === 'unavailable';
            const statusText = isUnavailable ? 'Indisponible' : 'Disponible';
            const statusClass = isUnavailable ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
            const buttonText = isUnavailable ? 'Rendre Disponible' : 'Marquer Indisponible';
            const buttonClass = isUnavailable ? 'btn-success' : 'btn-warning';

            item.innerHTML = `
                <span class="font-medium text-text-dark">${carName}</span>
                <div class="${statusClass} text-sm">${statusText}</div>
                <button data-car="${carName}" data-status="${isUnavailable ? 'available' : 'unavailable'}" class="toggle-status-button btn ${buttonClass} btn-sm py-1">
                    ${buttonText}
                </button>
            `;

            item.querySelector('.toggle-status-button').addEventListener('click', (e) => {
                const car = e.target.dataset.car;
                const newStatus = e.target.dataset.status;
                const confirmMsg = newStatus === 'unavailable' 
                    ? `Marquer ${car} comme INDISPONIBLE manuellement ? (bloquera toutes les r√©servations)`
                    : `Marquer ${car} comme DISPONIBLE ?`;
                
                // Utiliser customConfirm
                if (customConfirm(confirmMsg)) {
                    toggleManualStatus(car, newStatus);
                }
            });
            return item;
        }
        
        // --- NOUVELLE FONCTION: Cr√©er un item pour l'historique client ---
        function createClientHistoryItem(clientData) {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg text-sm';
            
            // Couleur bas√©e sur le nombre de r√©servations
            let countColor = 'text-primary'; // Bleu (d√©faut)
            if (clientData.count >= 5) {
                countColor = 'text-accent'; // Jaune/Or
            } else if (clientData.count >= 2) {
                countColor = 'text-green-600'; // Vert
            }

            item.innerHTML = `
                <div>
                    <strong class="text-text-dark">${clientData.nom}</strong>
                    <p class="text-xs text-gray-500">${clientData.telephone}</p>
                </div>
                <span class="font-bold text-lg ${countColor}">${clientData.count}</span>
            `;
            return item;
        }


        // --- FONCTIONS LOGIQUES (Firestore) ---

        // ** CORRECTION: LOGIQUE DE FILTRAGE D√âPLAC√âE EN JAVASCRIPT **
        function displayBookings(view) {
            const listDiv = domElements.bookingsList;
            const loadingMsg = domElements.loadingBookings;
            const countNew = domElements.countNew;
            const countConfirmed = domElements.countConfirmed;
            
            if (!listDiv || !loadingMsg || !countNew || !countConfirmed) {
                // Cette erreur ne devrait plus se produire gr√¢ce √† initDomElements
                console.error("√âl√©ments UI manquants pour displayBookings");
                return;
            }

            listDiv.innerHTML = ''; // Nettoyer la liste
            currentView = view;

            // Mettre √† jour les styles des onglets
            domElements.tabNew.classList.toggle('active', view === 'new');
            domElements.tabConfirmed.classList.toggle('active', view === 'confirmed');

            const isConfirmedView = (view === 'confirmed');
            
            // Filtrer le cache JavaScript
            const bookingsToDisplay = allBookingsCache.filter(booking => {
                // (booking.confirmed === true) pour 'confirmed'
                // (booking.confirmed === false) pour 'new'
                return booking.confirmed === isConfirmedView;
            });

            // Mettre √† jour les compteurs
            countNew.textContent = allBookingsCache.filter(b => !b.confirmed).length;
            countConfirmed.textContent = allBookingsCache.filter(b => b.confirmed).length;

            if (bookingsToDisplay.length === 0) {
                loadingMsg.textContent = `Aucune ${view === 'new' ? 'nouvelle demande' : 'r√©servation confirm√©e'} pour le moment.`;
                loadingMsg.style.display = 'block';
            } else {
                loadingMsg.style.display = 'none';
                bookingsToDisplay.forEach(booking => {
                    listDiv.appendChild(createBookingCard(booking));
                });
            }
        }
        
        // --- NOUVELLE FONCTION: Mettre √† jour l'historique des clients ---
        function updateClientHistory(allBookings) {
            const listDiv = domElements.clientHistoryList;
            const loadingMsg = domElements.loadingClientHistory;
            if (!listDiv || !loadingMsg) {
                 console.error("√âl√©ments UI manquants pour updateClientHistory");
                 return;
            }

            // 1. Filtrer pour les r√©servations CONFIRM√âES
            const confirmedBookings = allBookings.filter(b => b.confirmed === true);
            const clientCounts = new Map();

            // 2. Compter par client (t√©l√©phone + nom comme cl√©)
            for (const booking of confirmedBookings) {
                if (!booking.telephone || !booking.nomPrenom) continue; // Ignorer si donn√©es incompl√®tes
                
                // Cl√© unique bas√©e sur le t√©l√©phone normalis√© ET le nom
                const phone = booking.telephone.replace(/\s+/g, '');
                const name = booking.nomPrenom.toLowerCase().trim();
                const key = `${phone}::${name}`;
                
                if (!clientCounts.has(key)) {
                    // Utiliser le nom avec la bonne casse pour l'affichage
                    clientCounts.set(key, { nom: booking.nomPrenom, telephone: booking.telephone, count: 0 });
                }
                clientCounts.get(key).count++;
            }

            listDiv.innerHTML = ''; // Vider la liste
            
            // 3. Afficher
            if (clientCounts.size === 0) {
                loadingMsg.textContent = 'Aucun client confirm√©.';
                loadingMsg.style.display = 'block';
            } else {
                loadingMsg.style.display = 'none';
                // Convertir en tableau, trier par count (descendant)
                const sortedClients = Array.from(clientCounts.values()).sort((a, b) => b.count - a.count);
                
                sortedClients.forEach(clientData => {
                    listDiv.appendChild(createClientHistoryItem(clientData));
                });
            }
        }


        // ** CORRECTION: REQU√äTE FIRESTORE SIMPLIFI√âE (√âvite l'erreur d'index) **
        function loadBookings() {
            const loadingMsg = domElements.loadingBookings;

            const q = query(
                bookingsCollectionRef, 
                orderBy("timestamp", "desc")
            );

            onSnapshot(q, (snapshot) => {
                loadingMsg.textContent = 'Chargement des r√©servations...';
                allBookingsCache = []; // Vider le cache
                
                let newCount = 0;
                let confirmedCount = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // **FILTRAGE JS** : Ignorer les r√©servations marqu√©es comme supprim√©es
                    if (data.deleted !== true) {
                        allBookingsCache.push({ ...data, id: doc.id });
                        if (data.confirmed) {
                            confirmedCount++;
                        } else {
                            newCount++;
                            
                            // Tenter d'afficher une notification pour chaque nouvelle r√©servation
                            if (Notification.permission === 'granted' && navigator.serviceWorker.controller) {
                                // Ne pas montrer de notification si l'utilisateur est d√©j√† sur l'onglet "Nouvelles Demandes"
                                if (currentView !== 'new' && data.timestamp && (Date.now() - data.timestamp.toMillis() < 10000)) {
                                     navigator.serviceWorker.controller.postMessage({
                                        type: 'show-notification',
                                        title: 'üö® NOUVELLE R√âSERVATION !',
                                        options: {
                                            body: `${data.voiture} par ${data.nomPrenom || 'un client'}.`,
                                            icon: '/icons/icon-192x192.png',
                                            vibrate: [500, 100, 500]
                                        }
                                    });
                                }
                            }
                        }
                    }
                });
                
                // Afficher la vue actuellement s√©lectionn√©e avec les donn√©es mises √† jour
                displayBookings(currentView); 
                
                // NOUVEAU: Mettre √† jour l'historique client
                updateClientHistory(allBookingsCache);

            }, (error) => {
                console.error("Erreur lors de la r√©cup√©ration des r√©servations (onSnapshot): ", error);
                loadingMsg.textContent = "Erreur: Impossible de charger les r√©servations. V√©rifiez la console (F12).";
                loadingMsg.style.color = 'red';
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     loadingMsg.innerHTML = `<strong>Erreur:</strong> Index Firestore manquant. <br>Veuillez suivre le lien dans la console (F12) pour le cr√©er (index sur 'timestamp' desc).`;
                }
            });
        }


        function listenForPeriods() {
            const listDiv = domElements.periodsList;
            const loadingMsg = domElements.loadingPeriods;

            const q = query(
                unavailabilityPeriodsCollectionRef, 
                orderBy("startDate", "desc")
            );

            onSnapshot(q, (snapshot) => {
                listDiv.innerHTML = ''; // Clear list
                if (snapshot.empty) {
                    loadingMsg.textContent = 'Aucune p√©riode programm√©e.';
                    loadingMsg.style.display = 'block';
                } else {
                    loadingMsg.style.display = 'none';
                    snapshot.forEach((doc) => {
                        listDiv.appendChild(createPeriodListItem({ ...doc.data(), id: doc.id }));
                    });
                }
            }, (error) => {
                console.error("Erreur √©coute p√©riodes:", error);
                loadingMsg.textContent = 'Erreur chargement p√©riodes.';
                loadingMsg.style.color = 'red';
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     loadingMsg.innerHTML = `<strong>Erreur:</strong> Index Firestore manquant (p√©riodes). <br>Suivez le lien dans la console (F12) pour le cr√©er.`;
                }
            });
        }

        function listenForManualStatusChanges() {
            const listDiv = domElements.manualStatusList;
            const statusMap = new Map();

            // Initialiser toutes les voitures comme "disponibles"
            carOptions.forEach(carName => statusMap.set(carName, 'available'));

            // √âcouter les changements dans la collection 'car_manual_status'
            onSnapshot(carManualStatusCollectionRef, (snapshot) => {
                // R√©initialiser les statuts (au cas o√π un doc est supprim√©)
                 carOptions.forEach(carName => statusMap.set(carName, 'available'));
                // Mettre √† jour le statut pour les voitures pr√©sentes dans la collection
                snapshot.forEach((doc) => {
                    statusMap.set(doc.id, doc.data().status || 'available');
                });

                // Rafra√Æchir l'affichage
                listDiv.innerHTML = '';
                statusMap.forEach((status, carName) => {
                    listDiv.appendChild(createManualStatusItem(carName, status));
                });

            }, (error) => {
                console.error("Erreur √©coute statuts manuels:", error);
                listDiv.innerHTML = '<p class="text-red-500">Erreur chargement statuts.</p>';
            });
        }

        // --- FONCTIONS MODALE ---

        function openConfirmationModal(bookingId) {
            currentBookingId = bookingId;
            currentBookingData = allBookingsCache.find(b => b.id === bookingId);
            if (!currentBookingData) {
                console.error("Impossible de trouver les donn√©es pour la r√©servation:", bookingId);
                showAdminMessage("Erreur: Impossible de charger les d√©tails de cette r√©servation.", "error");
                return;
            }

            const modal = domElements.confirmationModal;
            const detailsDiv = domElements.modalBookingDetails;
            const startDateInput = domElements.modalStartDate;
            const startTimeInput = domElements.modalStartTime;
            const endDateInput = domElements.modalEndDate;
            const endTimeInput = domElements.modalEndTime;
            const confirmButton = domElements.confirmModalButton;

            // Remplir les d√©tails
            detailsDiv.innerHTML = `
                <p><strong>Client:</strong> ${currentBookingData.nomPrenom}</p>
                <p><strong>Voiture:</strong> ${currentBookingData.voiture}</p>
            `;
            
            // Remplir les dates/heures actuelles
            // Pr√©f√©rer les timestamps s'ils existent (plus fiables)
            let pickupDate, returnDate;

            if (currentBookingData.pickupTimestamp) {
                pickupDate = getDateTimeObjectFromTimestamp(currentBookingData.pickupTimestamp);
            } else {
                // Fallback pour les anciennes r√©servations sans timestamp (string)
                pickupDate = { date: currentBookingData.datePriseEnCharge || '', time: currentBookingData.heurePriseEnCharge || '12:00' };
            }

            if (currentBookingData.returnTimestamp) {
                returnDate = getDateTimeObjectFromTimestamp(currentBookingData.returnTimestamp);
            } else {
                // Fallback pour les anciennes r√©servations sans timestamp (string)
                returnDate = { date: currentBookingData.dateRetour || '', time: currentBookingData.heureRetour || '12:00' };
            }
            
            startDateInput.value = pickupDate.date;
            startTimeInput.value = pickupDate.time;
            endDateInput.value = returnDate.date;
            endTimeInput.value = returnDate.time;

            // Activer le bouton de confirmation
            confirmButton.disabled = false;

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            setTimeout(() => modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95', '-translate-y-10'), 50);
        }

        function closeConfirmationModal() {
            const modal = domElements.confirmationModal;
            const modalError = domElements.modalError;
            const confirmButton = domElements.confirmModalButton;
            
            modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95', '-translate-y-10');
            setTimeout(() => {
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalError.classList.add('hidden');
                    currentBookingId = null;
                    currentBookingData = null;
                    confirmButton.disabled = true; // D√©sactiver pour la prochaine ouverture
                }, 300);
            }, 300);
        }

        // --- ACTIONS ADMIN (Confirmation, Suppression, etc.) ---

        async function handleFinalConfirmation() {
            if (!currentBookingId || !currentBookingData || isConfirmationBusy) return;

            isConfirmationBusy = true; // Activer le verrou
            const modalError = domElements.modalError;
            const confirmButton = domElements.confirmModalButton;
            modalError.classList.add('hidden');
            confirmButton.disabled = true;
            confirmButton.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i> Confirmation...';


            // R√©cup√©rer les dates (potentiellement modifi√©es)
            const newStartDate = domElements.modalStartDate.value;
            const newStartTime = domElements.modalStartTime.value;
            const newEndDate = domElements.modalEndDate.value;
            const newEndTime = domElements.modalEndTime.value;

            // Validation (ajout√©e)
            if (!newStartDate || !newStartTime || !newEndDate || !newEndTime) {
                modalError.textContent = "Erreur : Tous les champs de date et d'heure sont requis.";
                modalError.classList.remove('hidden');
                confirmButton.disabled = false;
                confirmButton.innerHTML = '<i class="fas fa-check mr-2"></i> Confirmer la R√©servation';
                isConfirmationBusy = false; // Rel√¢cher le verrou
                return;
            }

            // Combiner date et heure
            const newPickupDateTime = getDateTimeObjectFromISO(newStartDate, newStartTime);
            const newReturnDateTime = getDateTimeObjectFromISO(newEndDate, newEndTime);

            // Validation
            if (!newPickupDateTime || !newReturnDateTime || newPickupDateTime >= newReturnDateTime) {
                modalError.textContent = "Erreur : La date/heure de fin doit √™tre apr√®s la date/heure de d√©but.";
                modalError.classList.remove('hidden');
                confirmButton.disabled = false;
                confirmButton.innerHTML = '<i class="fas fa-check mr-2"></i> Confirmer la R√©servation';
                isConfirmationBusy = false; // Rel√¢cher le verrou
                return;
            }
            
            const batch = writeBatch(db);

            try {
                // 1. Mettre √† jour la r√©servation
                const bookingRef = doc(db, "palace_cars_bookings", currentBookingId);
                batch.update(bookingRef, {
                    confirmed: true,
                    datePriseEnCharge: newStartDate,
                    heurePriseEnCharge: newStartTime,
                    dateRetour: newEndDate,
                    heureRetour: newEndTime,
                    // Mettre √† jour les timestamps (tr√®s important pour la v√©rification)
                    pickupTimestamp: Timestamp.fromDate(newPickupDateTime), 
                    returnTimestamp: Timestamp.fromDate(newReturnDateTime)
                });

                // 2. Cr√©er la p√©riode d'indisponibilit√©
                const unavailabilityData = {
                    car: currentBookingData.voiture,
                    startDate: Timestamp.fromDate(newPickupDateTime),
                    endDate: Timestamp.fromDate(newReturnDateTime),
                    type: 'booking', // Marqu√© comme g√©n√©r√© par une r√©servation
                    bookingId: currentBookingId // Lien vers la r√©servation
                };
                // Nous cr√©ons un nouveau doc dans la collection d'indisponibilit√©
                const newPeriodRef = doc(unavailabilityPeriodsCollectionRef); // doc(collection(...)) -> doc(...)
                batch.set(newPeriodRef, unavailabilityData);

                // 3. Ex√©cuter le batch
                await batch.commit();

                showAdminMessage(`R√©servation ${currentBookingId.substring(0, 5)}... confirm√©e et voiture bloqu√©e.`, 'success');
                closeConfirmationModal();
                
                // NOUVEAU: Mettre √† jour manuellement le cache et rafra√Æchir les vues
                // (onSnapshot prendra quelques secondes, ceci est plus rapide)
                const index = allBookingsCache.findIndex(b => b.id === currentBookingId);
                if (index > -1) {
                    allBookingsCache[index].confirmed = true;
                    // Mettre √† jour les donn√©es de date/heure aussi
                    allBookingsCache[index].datePriseEnCharge = newStartDate;
                    allBookingsCache[index].heurePriseEnCharge = newStartTime;
                    allBookingsCache[index].dateRetour = newEndDate;
                    allBookingsCache[index].heureRetour = newEndTime;
                    allBookingsCache[index].pickupTimestamp = Timestamp.fromDate(newPickupDateTime);
                    allBookingsCache[index].returnTimestamp = Timestamp.fromDate(newReturnDateTime);
                }
                displayBookings(currentView);
                updateClientHistory(allBookingsCache); // Rafra√Æchir l'historique client

            } catch (error) {
                console.error("Erreur lors de la confirmation finale:", error);
                modalError.textContent = "Erreur Firestore. V√©rifiez la console.";
                modalError.classList.remove('hidden');
            } finally {
                confirmButton.disabled = false;
                confirmButton.innerHTML = '<i class="fas fa-check mr-2"></i> Confirmer la R√©servation';
                isConfirmationBusy = false; // Rel√¢cher le verrou
            }
        }


        async function handleDeleteBooking(bookingId) {
            // Utiliser customConfirm √† la place de window.confirm
            if (!customConfirm(`√ätes-vous s√ªr de vouloir supprimer la r√©servation ID: ${bookingId.substring(0, 5)}... ?\n(Cela lib√©rera aussi le cr√©neau si elle √©tait confirm√©e.)`)) return;

            try {
                const batch = writeBatch(db);

                // 1. Marquer la r√©servation comme supprim√©e (soft delete)
                const bookingRef = doc(db, "palace_cars_bookings", bookingId);
                batch.update(bookingRef, { deleted: true });

                // 2. Trouver et supprimer la p√©riode d'indisponibilit√© associ√©e
                // (N√©cessite l'index sur 'bookingId' dans 'car_unavailability_periods')
                const q = query(unavailabilityPeriodsCollectionRef, where("bookingId", "==", bookingId));
                const periodSnapshot = await getDocs(q);
                
                if (!periodSnapshot.empty) {
                    periodSnapshot.forEach(docSnap => {
                        batch.delete(docSnap.ref);
                    });
                    console.log("P√©riode d'indisponibilit√© associ√©e supprim√©e.");
                }

                // 3. Ex√©cuter le batch
                await batch.commit();

                showAdminMessage(`R√©servation ${bookingId.substring(0, 5)}... supprim√©e/archiv√©e.`, 'success');
                
                // NOUVEAU: Mettre √† jour manuellement le cache et rafra√Æchir les vues
                allBookingsCache = allBookingsCache.filter(b => b.id !== bookingId);
                displayBookings(currentView);
                updateClientHistory(allBookingsCache); // Rafra√Æchir l'historique client

            } catch (error) {
                console.error("Erreur lors de la suppression:", error);
                showAdminMessage("Erreur lors de la suppression. V√©rifiez la console.", 'error');
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                     showAdminMessage("Erreur: Index Firestore manquant pour la suppression. Suivez le lien dans la console (F12) pour le cr√©er (index sur 'bookingId').", 'error', 10000);
                }
            }
        }

        async function toggleManualStatus(carName, newStatus) {
            // Confirmation d√©j√† faite via customConfirm dans createManualStatusItem

            const carStatusRef = doc(db, "car_manual_status", carName);

            try {
                if (newStatus === 'unavailable') {
                    // Marquer comme indisponible
                    await setDoc(carStatusRef, { status: 'unavailable' });
                    showAdminMessage(`${carName} est maintenant marqu√© INDISPONIBLE.`, 'warning');
                } else {
                    // Marquer comme disponible (en supprimant le document)
                    await deleteDoc(carStatusRef);
                    showAdminMessage(`${carName} est maintenant DISPONIBLE.`, 'success');
                }
                // L'affichage se met √† jour via onSnapshot
            } catch (error) {
                 console.error("Erreur mise √† jour statut manuel:", error);
                 showAdminMessage("Erreur Firestore. V√©rifiez la console.", 'error');
            }
        }

        async function deletePeriod(periodId) {
            // Confirmation d√©j√† faite via customConfirm dans createPeriodListItem
            
            try {
                const periodRef = doc(db, "car_unavailability_periods", periodId);
                await deleteDoc(periodRef);
                showAdminMessage(`P√©riode ${periodId.substring(0,5)}... supprim√©e.`, 'success');
                // L'affichage se met √† jour via onSnapshot
            } catch (error) {
                 console.error("Erreur suppression p√©riode:", error);
                 showAdminMessage("Erreur Firestore. V√©rifiez la console.", 'error');
            }
        }


        async function addUnavailability(event) {
            event.preventDefault();
            const form = event.target;
            const car = form.car.value;
            const startDate = form.startDate.value;
            const startTime = form.startTime.value;
            const endDate = form.endDate.value;
            const endTime = form.endTime.value;
            const button = form.querySelector('button');
            
            if (!car || !startDate || !startTime || !endDate || !endTime) {
                showAdminMessage("Veuillez remplir tous les champs de p√©riode.", 'warning');
                return;
            }

            const pickupDateTime = getDateTimeObjectFromISO(startDate, startTime);
            const returnDateTime = getDateTimeObjectFromISO(endDate, endTime);

            if (!pickupDateTime || !returnDateTime || pickupDateTime >= returnDateTime) {
                showAdminMessage("Date/heure de fin doit √™tre apr√®s la date/heure de d√©but.", 'warning');
                return;
            }
            
            button.disabled = true;

            try {
                 const unavailabilityData = {
                     car: car,
                     startDate: Timestamp.fromDate(pickupDateTime),
                     endDate: Timestamp.fromDate(returnDateTime),
                     type: 'manual', // Marqu√© comme manuel
                     bookingId: null // Pas de lien de r√©servation
                 };
                
                 await addDoc(unavailabilityPeriodsCollectionRef, unavailabilityData);
                 showAdminMessage(`P√©riode d'indisponibilit√© ajout√©e pour ${car}.`, 'success');
                 form.reset();

            } catch (error) {
                 console.error("Erreur ajout p√©riode:", error);
                 showAdminMessage("Erreur Firestore. V√©rifiez la console.", 'error');
            } finally {
                 button.disabled = false;
            }
        }

        function toggleView(view) {
            displayBookings(view); // Appelle la nouvelle fonction de filtrage JS
        }
        
        // --- NOUVELLE FONCTION: Initialisation des √©l√©ments DOM ---
        function initDomElements() {
             const ids = [
                'login-overlay', 'login-button', 'password-input', 'login-error', 'main-content',
                'admin-message-box', 'tab-new', 'tab-confirmed', 'count-new', 'count-confirmed',
                'bookings-list', 'loading-bookings', 'unavailability-form', 'unav-car',
                'manual-status-list', 'periods-list', 'loading-periods',
                'confirmation-modal', 'close-modal-button', 'modal-booking-details',
                'modal-start-date', 'modal-start-time', 'modal-end-date', 'modal-end-time',
                'modal-error', 'cancel-modal-button', 'confirm-modal-button',
                'enable-notifications', 'notifications-status',
                // Nouveaux √©l√©ments
                'client-history-list', 'loading-client-history'
             ];
             let allFound = true;
             ids.forEach(id => {
                 const el = document.getElementById(id);
                 if (!el) {
                     console.error(`√âl√©ment DOM manquant: #${id}`);
                     allFound = false;
                 }
                 // Convertir 'client-history-list' en 'clientHistoryList'
                 const camelCaseId = id.replace(/-(\w)/g, (match, p1) => p1.toUpperCase());
                 domElements[camelCaseId] = el;
             });
             return allFound;
        }


        // --- INITIALISATION (Login, PWA, etc.) ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Initialiser tous les √©l√©ments DOM
            if (!initDomElements()) {
                // Utiliser une m√©thode de log car alert() est interdit
                console.error("Erreur critique: Certains √©l√©ments de la page sont manquants. L'application ne peut pas d√©marrer.");
                return;
            }
            
            // 2. Remplir les listes de voitures
            populateCarSelects();

            // 3. Gestion Login
            function handleLogin() {
                if (domElements.passwordInput.value === "12234") {
                    domElements.loginOverlay.classList.add('opacity-0', 'pointer-events-none');
                    domElements.mainContent.classList.remove('hidden');
                    setTimeout(() => domElements.mainContent.classList.remove('opacity-0'), 50); // Fade in
                    setTimeout(() => domElements.loginOverlay.style.display = 'none', 500); // Hide completely

                    // D√©marrer les √©couteurs Firestore SEULEMENT APRES le login
                    if (dbReady) {
                        try {
                            loadBookings();
                            listenForPeriods();
                            listenForManualStatusChanges();
                        } catch (e) {
                            console.error("Erreur au d√©marrage des √©couteurs Firestore:", e);
                            showAdminMessage("Erreur de connexion √† Firestore. V√©rifiez la console.", "error");
                        }
                    } else {
                        console.error("DB non pr√™te au moment du login.");
                        showAdminMessage("La connexion √† la base de donn√©es a √©chou√©.", "error");
                    }

                } else {
                    domElements.loginError.classList.remove('hidden');
                    domElements.passwordInput.classList.add('border-red-500', 'ring-red-500');
                    domElements.passwordInput.focus();
                }
            }
            
            domElements.loginButton.addEventListener('click', handleLogin);
            domElements.passwordInput.addEventListener('keyup', (e) => {
                domElements.loginError.classList.add('hidden');
                domElements.passwordInput.classList.remove('border-red-500', 'ring-red-500');
                if (e.key === 'Enter') handleLogin();
            });

            // 4. √âcouteurs Modale
            domElements.closeModalButton.addEventListener('click', closeConfirmationModal);
            domElements.cancelModalButton.addEventListener('click', closeConfirmationModal);
            domElements.confirmModalButton.addEventListener('click', handleFinalConfirmation);

            // 5. √âcouteurs Formulaire Indisponibilit√©
            domElements.unavailabilityForm.addEventListener('submit', addUnavailability);

            // 6. √âcouteurs Onglets
            domElements.tabNew.addEventListener('click', () => toggleView('new'));
            domElements.tabConfirmed.addEventListener('click', () => toggleView('confirmed'));

            // 7. Initialisation PWA (Service Worker & Notifications)
            const notifButton = domElements.enableNotifications;
            const notifStatus = domElements.notificationsStatus;
            
            // 7.1 Enregistrement Service Worker
            if ('serviceWorker' in navigator) {
                 // ** CORRECTION: V√©rifier le protocole **
                 if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                     window.addEventListener('load', () => {
                         navigator.serviceWorker.register('sw.js') // Correction: pas de / au d√©but car ce n'est pas la racine ici
                             .then(registration => {
                                 console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
                             })
                             .catch(error => {
                                 console.error('√âchec de l\'enregistrement du Service Worker:', error);
                             });
                     });
                 } else {
                     console.warn("Le Service Worker ne peut pas √™tre enregistr√© sur ce protocole:", window.location.protocol);
                 }
            }

            // 7.2 Demande de Permission Notification
            function requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            notifStatus.classList.remove('hidden');
                            notifButton.classList.add('hidden');
                            console.log('Permission de notification accord√©e.');
                            // Envoyer une notification de test
                            if (navigator.serviceWorker.controller) {
                                navigator.serviceWorker.controller.postMessage({
                                    type: 'show-notification',
                                    title: 'Palace Cars Admin',
                                    options: {
                                        body: 'Les notifications sont activ√©es !',
                                        // Utilisez une URL absolue ou relative correcte pour les ic√¥nes
                                        icon: '/icons/icon-192x192.png', 
                                        badge: '/icons/icon-192x192.png',
                                        vibrate: [200, 100, 200]
                                    }
                                });
                            }
                        } else {
                            console.warn('Permission de notification refus√©e.');
                            showAdminMessage('Les notifications ont √©t√© bloqu√©es.', 'warning');
                        }
                    });
                } else {
                    console.error('Ce navigateur ne supporte pas les notifications.');
                    showAdminMessage('Ce navigateur ne supporte pas les notifications.', 'error');
                }
            }

            notifButton.addEventListener('click', requestNotificationPermission);
            // V√©rifier si la permission est d√©j√† accord√©e
            if (window.Notification && Notification.permission === 'granted') {
                notifStatus.classList.remove('hidden');
                notifButton.classList.add('hidden');
            }


            // 8. --- Connexion Firebase ---
            (async () => {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    bookingsCollectionRef = collection(db, "palace_cars_bookings");
                    unavailabilityPeriodsCollectionRef = collection(db, "car_unavailability_periods");
                    carManualStatusCollectionRef = collection(db, "car_manual_status");
                    dbReady = true;
                    console.log("Firebase initialis√© avec succ√®s (DOMContentLoaded).");
                } catch (error) {
                    console.error("Erreur critique d'initialisation Firebase:", error);
                    domElements.loginButton.disabled = true;
                    domElements.loginButton.textContent = "Erreur DB";
                    domElements.loginError.textContent = "Impossible de connecter √† Firebase. V√©rifiez la console.";
                    domElements.loginError.classList.remove('hidden');
                }
            })();

        }); // Fin DOMContentLoaded
    </script>
</body>
</html>
