<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="manifest" href="manifest.json"> <!-- Gardé pour l'instant -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- Gardé pour l'instant -->

    <title>Palace Cars - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Icônes Font Awesome (avec integrity corrigé) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4qFf3fSLbcaL8S/V5fR07H/aLSWcaOXYjM4QdMW7Xb43p2Cwv0A5/5V9iwQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .booking-card {
            transition: all 0.3s ease-in-out;
        }
        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .status-new { background-color: #e0f2fe; color: #0c4a6e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        #notification-button.enabled { background-color: #10b981; } /* Vert si activé */
        #notification-button.disabled { background-color: #f87171; } /* Rouge si refusé */
        #notification-button.pending { background-color: #f59e0b; } /* Orange pendant la demande */
        .action-button {
            transition: background-color 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Accès Administrateur Palace Cars</h1>

        <!-- Section de Connexion -->
        <div id="login-section" class="bg-white p-6 md:p-8 rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="text-xl font-semibold mb-4 text-center">Connexion Administrateur</h2>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mot de Passe</label>
                <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Entrez le mot de passe">
            </div>
            <p id="error-message" class="text-red-500 text-sm mb-4 hidden">Mot de passe incorrect.</p>
            <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 action-button">
                Connexion
            </button>
        </div>

        <!-- Section Boîte de Réception (cachée initialement) -->
        <div id="admin-panel" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Boîte de Réception des Réservations</h2>

            <!-- Bouton pour gérer les notifications -->
            <div class="text-center mb-6">
                <button id="notification-button" class="px-4 py-2 rounded-md text-white text-sm font-medium action-button">
                    <i class="fas fa-bell mr-1"></i> Activer les Notifications
                </button>
                <p id="notification-status" class="text-xs text-gray-500 mt-1"></p>
            </div>


            <p class="text-center text-gray-600 mb-6">Liste des demandes de réservation en temps réel. Cette page se met à jour automatiquement.</p>

            <div id="error-display" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <strong class="font-bold">Erreur :</strong>
                <span id="error-content" class="block sm:inline">Impossible de charger les réservations. Vérifiez la console (F12) pour plus de détails (index manquant ?).</span>
            </div>

            <div id="loading-spinner" class="text-center py-10 hidden">
                 <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
                 <p class="mt-2 text-gray-600">Chargement des réservations...</p>
            </div>

             <!-- Filtres (Nouvelles / Confirmées) -->
            <div class="flex justify-center space-x-4 mb-6">
                <button id="filter-new" class="px-4 py-2 rounded-md bg-blue-600 text-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-400">Nouvelles Demandes</button>
                <button id="filter-confirmed" class="px-4 py-2 rounded-md bg-gray-300 text-gray-700 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400">Réservations Confirmées</button>
             </div>


            <!-- Conteneur pour les cartes de réservation -->
            <div id="bookings-container" class="space-y-4">
                <!-- Les cartes de réservation seront injectées ici par JavaScript -->
            </div>
             <p id="no-bookings" class="text-center text-gray-500 py-10 hidden">Aucune demande de réservation trouvée.</p>
        </div>
    </div>

    <!-- Script Firebase & Notifications & PWA -->
    <script type="module">
        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Votre configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCsPHf_v8-gEiWGQzkwses-jOiDXs9tvWo",
            authDomain: "palace-cars.firebaseapp.com",
            projectId: "palace-cars",
            storageBucket: "palace-cars.firebasestorage.app",
            messagingSenderId: "469852272715",
            appId: "1:469852272715:web:6e87dc7083cdc04e03b5ce",
            measurementId: "G-KCEF4WBW0G"
        };

        // --- Variables Globales ---
        let app;
        let db;
        let bookingsCollection;
        let unsubscribe = null;
        let notifiedBookingIds = new Set();
        let currentFilter = 'new'; // 'new' or 'confirmed'

        // --- Éléments UI ---
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const errorDisplay = document.getElementById('error-display');
        const errorContent = document.getElementById('error-content');
        const bookingsContainer = document.getElementById('bookings-container');
        const noBookingsMessage = document.getElementById('no-bookings');
        const loadingSpinner = document.getElementById('loading-spinner');
        const notificationButton = document.getElementById('notification-button');
        const notificationStatus = document.getElementById('notification-status');
        const filterNewButton = document.getElementById('filter-new');
        const filterConfirmedButton = document.getElementById('filter-confirmed');
        const correctPassword = "12234";

        // --- Initialisation Firebase ---
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // Utiliser le chemin de collection simplifié
                bookingsCollection = collection(db, "palace_cars_bookings");
                console.log("Firebase initialisé avec succès.");
                // setLogLevel('debug'); // Décommenter pour plus de logs Firebase
                return true;
            } catch (error) {
                console.error("Erreur d'initialisation Firebase:", error);
                displayError("Erreur d'initialisation de Firebase. Impossible de se connecter.");
                return false;
            }
        }

        // --- Enregistrement du Service Worker (toujours désactivé pour le test) ---
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker enregistré avec succès:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement ServiceWorker:', error);
                    });
            });
        }
        */

        // --- Gestion des Notifications ---
         function updateNotificationButton() {
            if (!("Notification" in window)) {
                notificationButton.textContent = "Notifications non supportées";
                notificationButton.disabled = true;
                notificationButton.classList.add("bg-gray-400", "cursor-not-allowed");
                notificationStatus.textContent = "Votre navigateur ne supporte pas les notifications.";
                return;
            }

            switch (Notification.permission) {
                case 'granted':
                    notificationButton.textContent = "Notifications Activées";
                    notificationButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-red-500', 'bg-yellow-500');
                    notificationButton.classList.add('bg-green-500', 'cursor-default');
                    notificationButton.disabled = true;
                    notificationStatus.textContent = "Alertes activées.";
                    break;
                case 'denied':
                    notificationButton.textContent = "Notifications Bloquées";
                    notificationButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-500', 'bg-yellow-500');
                    notificationButton.classList.add('bg-red-500', 'cursor-not-allowed');
                    notificationButton.disabled = true;
                    notificationStatus.textContent = "Réactivez dans les paramètres du navigateur.";
                    break;
                default:
                    notificationButton.textContent = "Activer les Notifications";
                    notificationButton.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
                    notificationButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    notificationButton.disabled = false;
                    notificationStatus.textContent = "Cliquez pour autoriser les notifications.";
                    break;
            }
        }

        notificationButton.addEventListener('click', async () => {
             if (!("Notification" in window)) return;

            if (Notification.permission === 'default') {
                notificationButton.textContent = "Demande en cours...";
                notificationButton.classList.add('bg-yellow-500');
                notificationButton.disabled = true;
                try {
                    const permission = await Notification.requestPermission();
                    console.log('Permission demandée:', permission);
                } catch (error) {
                    console.error("Erreur lors de la demande de permission:", error);
                    notificationStatus.textContent = "Erreur lors de la demande d'autorisation.";
                } finally {
                     updateNotificationButton();
                }
            }
        });

        function showNotification(title, body) {
             if (!("Notification" in window)) {
                console.log("Ce navigateur ne supporte pas les notifications.");
                return;
            }

            if (Notification.permission === "granted") {
                // Tenter d'afficher la notification via le service worker s'il est actif
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                     navigator.serviceWorker.controller.postMessage({ type: 'show-notification', title: title, options: { body: body } });
                } else {
                    // Fallback si le service worker n'est pas prêt ou non supporté
                    const notification = new Notification(title, { body: body });
                    notification.onclick = function(event) {
                        event.preventDefault();
                        window.open(window.location.href, '_blank'); // Ouvre l'URL de la page admin dans un nouvel onglet
                    }
                }
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showNotification(title, body);
                    }
                });
            }
        }


        // --- Gestion de la Connexion Admin ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value === correctPassword) {
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                if (initializeFirebase()) {
                    updateNotificationButton();
                    loadBookings(); // Charger les réservations initiales
                }
            } else {
                errorMessage.classList.remove('hidden');
            }
        });
        passwordInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') loginButton.click(); });

        // --- Gestion des Filtres ---
        filterNewButton.addEventListener('click', () => {
            if (currentFilter !== 'new') {
                currentFilter = 'new';
                updateFilterButtons();
                loadBookings();
            }
        });

        filterConfirmedButton.addEventListener('click', () => {
             if (currentFilter !== 'confirmed') {
                currentFilter = 'confirmed';
                updateFilterButtons();
                loadBookings();
            }
        });

        function updateFilterButtons() {
            if (currentFilter === 'new') {
                filterNewButton.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                filterNewButton.classList.add('bg-blue-600', 'text-white');
                filterConfirmedButton.classList.remove('bg-blue-600', 'text-white');
                filterConfirmedButton.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
            } else { // confirmed
                filterConfirmedButton.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                filterConfirmedButton.classList.add('bg-blue-600', 'text-white');
                filterNewButton.classList.remove('bg-blue-600', 'text-white');
                filterNewButton.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
            }
        }


        // --- Affichage des Erreurs ---
        function displayError(message) {
            if (errorDisplay) {
                errorContent.textContent = `${message} Vérifiez la console (F12) pour plus de détails.`;
                errorDisplay.classList.remove('hidden');
            }
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        // --- Chargement et Affichage des Réservations ---
        function loadBookings() {
            if (!db || !bookingsCollection) {
                displayError("La base de données n'est pas prête.");
                return;
            }

            loadingSpinner.classList.remove('hidden');
            noBookingsMessage.classList.add('hidden');
            bookingsContainer.innerHTML = '';
            errorDisplay.classList.add('hidden');

            // !! REQUÊTE SIMPLIFIÉE !! (Temporairement sans le filtre 'deleted')
            let q;
            try {
                if (currentFilter === 'new') {
                    // Nouvelles demandes : juste non confirmées, triées par date
                     q = query(bookingsCollection, where("confirmed", "==", false), orderBy("timestamp", "desc"));
                } else { // confirmed
                     // Demandes confirmées : juste confirmées, triées par date
                     q = query(bookingsCollection, where("confirmed", "==", true), orderBy("timestamp", "desc"));
                }
            } catch (queryError) {
                 console.error("Erreur lors de la construction de la requête Firestore:", queryError);
                 displayError("Erreur interne lors de la préparation de la requête.");
                 return;
            }


            if (unsubscribe) unsubscribe(); // Nettoyer l'ancien listener

            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                bookingsContainer.innerHTML = '';
                let hasVisibleBookings = false;

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && currentFilter === 'new') {
                        const booking = change.doc.data();
                        const bookingId = change.doc.id;
                        // Simplification : Notifier si confirmed est false (ne vérifie plus deleted ici)
                        if (!booking.confirmed && !notifiedBookingIds.has(bookingId) && !change.doc.metadata.hasPendingWrites) {
                             notifiedBookingIds.add(bookingId);
                             showNotification(
                                 'Nouvelle Réservation Palace Cars!',
                                 `Client: ${booking.nomPrenom || 'Inconnu'} - Voiture: ${booking.voiture || 'Non spécifiée'}`
                             );
                        }
                    }
                 });


                snapshot.forEach((doc) => {
                    const bookingData = doc.data();
                    // On ne filtre plus ici via JS, la requête s'en charge
                    // if (currentFilter === 'new' && !bookingData.confirmed && !bookingData.deleted) { // Ancienne logique
                    //     hasVisibleBookings = true;
                    //     const card = createBookingCard(bookingData, doc.id, currentFilter);
                    //     bookingsContainer.appendChild(card);
                    // } else if (currentFilter === 'confirmed' && bookingData.confirmed && !bookingData.deleted) { // Ancienne logique
                    //     hasVisibleBookings = true;
                    //     const card = createBookingCard(bookingData, doc.id, currentFilter);
                    //     bookingsContainer.appendChild(card);
                    // }
                    // Nouvelle logique simplifiée (la requête fait déjà le filtre confirmed)
                    hasVisibleBookings = true;
                    const card = createBookingCard(bookingData, doc.id, currentFilter);
                    bookingsContainer.appendChild(card);

                });

                if (!hasVisibleBookings) {
                    noBookingsMessage.textContent = currentFilter === 'new' ? "Aucune nouvelle demande de réservation." : "Aucune réservation confirmée.";
                    noBookingsMessage.classList.remove('hidden');
                } else {
                    noBookingsMessage.classList.add('hidden');
                }

            }, (error) => {
                console.error("Erreur lors de la récupération des réservations (onSnapshot): ", error);
                let friendlyMessage = "Impossible de charger les réservations.";
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    // !! IMPORTANT: Si cette erreur réapparaît, un NOUVEL index est nécessaire !!
                    friendlyMessage = "Index Firestore manquant pour la requête simplifiée. Veuillez suivre le lien dans la console (F12) pour le créer.";
                } else if (error.code === 'permission-denied') {
                    friendlyMessage = "Permission refusée. Vérifiez les règles de sécurité Firestore.";
                }
                displayError(friendlyMessage);
                loadingSpinner.classList.add('hidden');
            });
        }


        // --- Création d'une Carte de Réservation ---
        function createBookingCard(booking, id, filterType) {
             const card = document.createElement('div');
             card.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200 booking-card flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0';
             card.dataset.id = id;

             let timestampStr = "Date inconnue";
             // --- Logique de formatage de date inchangée ---
              if (booking.timestamp && booking.timestamp.toDate) {
                 try {
                     timestampStr = booking.timestamp.toDate().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                 } catch (e) { console.warn("Timestamp invalide:", booking.timestamp); }
             } else if (typeof booking.timestamp === 'string') {
                  try {
                      timestampStr = new Date(booking.timestamp).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                      if (timestampStr === "Invalid Date") timestampStr = "Date invalide";
                  } catch(e) { console.warn("Timestamp string invalide:", booking.timestamp); timestampStr = "Date invalide"; }
             } else if (booking.timestamp?.seconds) {
                 try {
                      timestampStr = new Date(booking.timestamp.seconds * 1000).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                 } catch(e) { console.warn("Timestamp objet invalide:", booking.timestamp); timestampStr = "Date invalide"; }
             }
             // --- Fin logique de formatage ---

             const statusBadge = filterType === 'new'
                ? `<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full status-new mt-2"><i class="fas fa-hourglass-start mr-1"></i> Nouvelle Demande</span>`
                : `<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full status-confirmed mt-2"><i class="fas fa-check-circle mr-1"></i> Confirmée</span>`;


             const infoDiv = document.createElement('div');
             infoDiv.className = 'space-y-2 text-sm';
             const sanitize = (str) => {
                if (str === null || str === undefined) return 'Non spécifié';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
             };

             infoDiv.innerHTML = `
                 <p><strong class="font-semibold text-gray-700">Reçu le :</strong> ${sanitize(timestampStr)}</p>
                 <p><strong class="font-semibold text-gray-700">Nom:</strong> ${sanitize(booking.nomPrenom)}</p>
                 <p><strong class="font-semibold text-gray-700">Téléphone:</strong> <a href="https://wa.me/${formatPhoneNumber(booking.telephone)}" target="_blank" class="text-blue-600 hover:underline">${sanitize(booking.telephone)}</a></p>
                 <p><strong class="font-semibold text-gray-700">Email:</strong> <a href="mailto:${sanitize(booking.email)}" class="text-blue-600 hover:underline">${sanitize(booking.email)}</a></p>
                 <p><strong class="font-semibold text-gray-700">Voiture:</strong> ${sanitize(booking.voiture)}</p>
                 <p><strong class="font-semibold text-gray-700">Prise en charge:</strong> ${sanitize(booking.lieuPriseEnCharge)} - ${sanitize(booking.datePriseEnCharge)} à ${sanitize(booking.heurePriseEnCharge)}</p>
                 <p><strong class="font-semibold text-gray-700">Retour:</strong> ${sanitize(booking.lieuRetour)} - ${sanitize(booking.dateRetour)} à ${sanitize(booking.heureRetour)}</p>
                 ${statusBadge}
             `;

             const actionsDiv = document.createElement('div');
             actionsDiv.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full md:w-auto mt-4 md:mt-0';

             if (filterType === 'new') {
                const confirmButton = document.createElement('button');
                confirmButton.innerHTML = '<i class="fas fa-check mr-1"></i> Confirmer';
                confirmButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md text-xs action-button flex items-center justify-center';
                confirmButton.onclick = (e) => { e.stopPropagation(); confirmBooking(id); };
                actionsDiv.appendChild(confirmButton);
             }

             const deleteButton = document.createElement('button');
             deleteButton.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Supprimer';
             deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md text-xs action-button flex items-center justify-center';
             // Modification : Ne pas supprimer définitivement, mais marquer comme supprimé
             deleteButton.onclick = (e) => { e.stopPropagation(); markAsDeleted(id); };

             actionsDiv.appendChild(deleteButton);

             card.appendChild(infoDiv);
             card.appendChild(actionsDiv);

             return card;
        }

        // --- Actions sur les Réservations ---
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = String(phone).replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '212' + cleaned.substring(1);
            } else if (cleaned.length > 5 && !cleaned.startsWith('212')) {
                 cleaned = '212' + cleaned;
            }
            return cleaned;
        }

        async function confirmBooking(bookingId) {
            if (!db) return;
            const bookingRef = doc(db, "palace_cars_bookings", bookingId);
            try {
                // Mettre confirmed à true et deleted à false (au cas où elle était marquée supprimée avant)
                await updateDoc(bookingRef, {
                    confirmed: true,
                    deleted: false, // Assurer qu'elle n'est pas supprimée
                    confirmedTimestamp: serverTimestamp()
                 });
                console.log(`Réservation ${bookingId} marquée comme confirmée.`);
            } catch (error) {
                console.error("Erreur confirmation: ", error);
                 displayError(`Erreur lors de la confirmation de la réservation ${bookingId}. Code: ${error.code}`);
            }
        }

        // Nouvelle fonction pour marquer comme supprimé (soft delete)
        async function markAsDeleted(bookingId) {
             if (!db) return;
             if (!confirm("Êtes-vous sûr de vouloir marquer cette demande comme supprimée ?")) return;

             const bookingRef = doc(db, "palace_cars_bookings", bookingId);
             try {
                // Mettre juste le flag 'deleted' à true
                await updateDoc(bookingRef, { deleted: true });
                console.log(`Réservation ${bookingId} marquée comme supprimée.`);
                // L'UI se met à jour via onSnapshot car la requête filtre sur deleted == false
             } catch (error) {
                 console.error("Erreur marquage suppression: ", error);
                  displayError(`Erreur lors du marquage comme supprimé de la réservation ${bookingId}. Code: ${error.code}`);
             }
        }

        // La fonction deleteBooking n'est plus appelée directement par le bouton
        // async function deleteBooking(bookingId) { ... } // (ancienne fonction de suppression définitive)


        // Initialiser au chargement global
        updateNotificationButton();

    </script>

</body>
</html>

